document.addEventListener("DOMContentLoaded",()=>{const j=window.MEDICINE_CALENDAR_CONFIG||{},ce=j.apiPath||"index.php",k=j.canWrite!==!1&&j.canWrite!=="false",N=document.body,K=N.dataset.dbReady==="1",l=document.getElementById("calendar-status"),$=document.getElementById("calendar-month-label"),g=document.getElementById("calendar-month-picker"),G=document.getElementById("calendar-prev"),X=document.getElementById("calendar-next"),a=document.getElementById("calendar-grid"),b=document.getElementById("calendar-day-title"),h=document.getElementById("calendar-day-summary"),m=document.getElementById("calendar-day-list"),Q=document.getElementById("calendar-open-create-modal-btn"),i=document.getElementById("calendar-create-modal"),n=document.getElementById("calendar-create-intake-form"),v=n?.querySelector("button[type='submit']"),P=document.getElementById("calendar-taken-at"),L=document.getElementById("calendar-dosage-value"),D=document.getElementById("calendar-dosage-unit"),M=document.getElementById("calendar-create-rating-widget"),d=document.getElementById("calendar-rating"),c={picker:document.getElementById("calendar-create-medicine-picker"),select:document.getElementById("calendar-medicine-select"),custom:document.getElementById("calendar-medicine-custom")};let e=u(j.initialMonth)||y(new Date),t="",s=[];function u(e){const t=String(e||"").trim();return/^\d{4}-(0[1-9]|1[0-2])$/.test(t)?t:""}function S(e){const t=String(e||"").trim();return/^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])$/.test(t)?t:""}function y(e){const t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0");return`${t}-${n}`}function A(e,t){const n=u(e);if(!n)return y(new Date);const[s,o]=n.split("-"),i=Number(s),a=Number(o),r=new Date(i,a-1+t,1);return y(r)}function ae(e){const t=/^(\d{4})-(\d{2})-(\d{2})$/.exec(String(e));if(!t)return String(e||"-");const n=Number(t[1]),s=Number(t[2]),o=Number(t[3]),i=new Date(n,s-1,o);return i.toLocaleDateString(0[0],{month:"long",day:"numeric",year:"numeric"})}function oe(){const e=new Date;return new Date(e.getTime()-e.getTimezoneOffset()*6e4).toISOString().slice(0,16)}function se(e){const t=S(e);if(!t)return oe();const n=new Date,s=String(n.getHours()).padStart(2,"0"),o=String(n.getMinutes()).padStart(2,"0");return`${t}T${s}:${o}`}function o(e,t="success"){if(!l)return;l.hidden=!1,l.textContent=e,l.className=t==="error"?"alert alert-error":"alert alert-success"}function ne(){if(!l)return;l.hidden=!0,l.textContent=""}function w(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Z(e,t={}){const n=new URL(ce,window.location.href);return n.searchParams.set("api",e),Object.entries(t).forEach(([e,t])=>{n.searchParams.set(e,String(t))}),n.toString()}async function _(e,t={}){const a=t.method||"GET",r=t.params||{},o=t.data,s={method:a,headers:{Accept:"application/json"}};o!==0[0]&&(s.headers["Content-Type"]="application/json",s.body=JSON.stringify(o));const i=await fetch(Z(e,r),s);let n=null;try{n=await i.json()}catch{throw new Error("Server returned an unreadable response.")}if(!i.ok||!n.ok){const e=n?.errors?.join(" ")||n?.error||"Request failed.";throw new Error(e)}return n}function f(e){const t=Number(e);return Number.isFinite(t)?Math.max(1,Math.min(5,Math.round(t))):3}function O(e,t,n=0){if(!e)return;const s=n>0?n:t;e.querySelectorAll("button[data-star]").forEach(e=>{const n=f(e.dataset.star);e.classList.toggle("is-active",n<=s),e.setAttribute("aria-checked",n===t?"true":"false")})}function x(e,t,n){if(!e)return;const s=f(n);e.value=String(s),O(t,s)}function q(e,t){if(!e||!t)return;x(t,e,t.value),e.addEventListener("mouseover",n=>{const s=n.target.closest("button[data-star]");if(!s||!e.contains(s))return;O(e,f(t.value),f(s.dataset.star))}),e.addEventListener("mouseleave",()=>{O(e,f(t.value))}),e.addEventListener("click",n=>{const s=n.target.closest("button[data-star]");if(!s||!e.contains(s))return;x(t,e,s.dataset.star)})}function r(e,t){const o=e.picker,i=e.select,a=e.custom;if(!o||!i||!a)return;const n=t==="new"?"new":"existing";o.dataset.mode=n,o.querySelectorAll("[data-tab-mode]").forEach(e=>{const t=e.dataset.tabMode===n;e.classList.toggle("is-active",t),e.setAttribute("aria-selected",t?"true":"false")}),o.querySelectorAll("[data-panel-mode]").forEach(e=>{e.hidden=e.dataset.panelMode!==n}),i.disabled=n!=="existing"||s.length===0,i.required=n==="existing"&&s.length>0,a.disabled=n!=="new",a.required=n==="new",k||(i.disabled=!0,a.disabled=!0)}function W(e){const t=e.picker,n=e.select,s=e.custom;if(!t||!n||!s)return{medicine_mode:"new",medicine_id:0,medicine_name:""};const o=t.dataset.mode==="new"?"new":"existing";return o==="new"?{medicine_mode:"new",medicine_id:0,medicine_name:s.value.trim()}:{medicine_mode:"existing",medicine_id:Number(n.value)||0,medicine_name:""}}function U(e){const t=W(e);if(t.medicine_mode==="existing"&&t.medicine_id>0){const e=s.find(e=>e.id===t.medicine_id);return e?{id:e.id,name:e.name}:null}return t.medicine_mode==="new"&&t.medicine_name?{id:0,name:t.medicine_name}:null}function ee(e,t=0){if(!e)return;if(e.innerHTML="",!s.length){const t=new Option("No medicine types yet","");t.disabled=!0,t.selected=!0,e.add(t);return}s.forEach(t=>{e.add(new Option(t.name,String(t.id)))}),t>0&&s.some(e=>e.id===t)?e.value=String(t):e.value=String(s[0].id)}function V(e,t=null){const i=e.picker,a=e.select,n=e.custom;if(!i||!a||!n)return;const o=t&&t.id?Number(t.id):0,c=t&&t.name?String(t.name):"";if(ee(a,o),o>0&&s.some(e=>e.id===o)){n.value="",r(e,"existing");return}if(c!==""){n.value=c,r(e,"new");return}if(!s.length){n.value="",r(e,"new");return}const l=i.dataset.mode==="new"?"new":"existing";if(l==="new"){r(e,"new");return}n.value="",r(e,"existing")}function Y(e){const t=e.picker;if(!t)return;t.addEventListener("click",t=>{const i=t.target.closest("button[data-tab-mode]");if(!i)return;const n=i.dataset.tabMode==="new"?"new":"existing";if(n==="existing"&&s.length===0){o("No medicine types yet. Add a new medicine first.","error");return}r(e,n),n==="new"&&e.custom&&e.custom.focus()})}async function B(){if(!n)return;const t=U(c),e=await _("medicines");s=Array.isArray(e.medicines)?e.medicines.map(e=>({id:Number(e.id),name:String(e.name||"")})).filter(e=>e.id>0&&e.name!==""):[],V(c,t)}function I(){const e=Boolean(i&&!i.hidden);N.classList.toggle("modal-open",e)}function H(e){if(!n)return;const t=n.querySelector("button[type='submit']");t&&(t.disabled=e)}function R(){if(!n)return;if(n.reset(),L&&(L.value="20"),D&&(D.value="mg"),d&&x(d,M,3),P&&(P.value=se(t)),!s.length){r(c,"new");return}V(c),r(c,"existing")}function J(){if(!k||!i||!n)return;R(),i.hidden=!1,I()}function C(e=!1){if(!i)return;i.hidden=!0,I(),e&&R()}function te(e){const t=e.medicine_mode==="existing"&&e.medicine_id>0||e.medicine_mode==="new"&&e.medicine_name!=="";return t&&e.dosage_value!==""&&e.dosage_unit!==""&&e.rating!==""&&e.taken_at!==""}function E(e){if(!a)return;a.innerHTML=`
      <div class="calendar-cell is-empty">
        <p class="calendar-empty-text">${w(e)}</p>
      </div>
    `}function z(e){if(!b||!h||!m)return;b.textContent="Day Details",h.textContent=e,m.innerHTML='<li class="day-entry-item is-empty">No entries.</li>'}function T(e,t){if(!b||!h||!m)return;if(b.textContent=ae(t),!e||!Array.isArray(e.entries)||e.entries.length===0){h.textContent="No intakes recorded on this day.",m.innerHTML='<li class="day-entry-item is-empty">No entries logged.</li>';return}const n=Number(e.entry_count||e.entries.length),s=Number(e.avg_rating),o=Number.isFinite(s)?`${s.toFixed(2)} / 5`:"--";h.textContent=`${n} intake${n===1?"":"s"} • Avg rating ${o}`;const i=e.entries.map(e=>{const t=String(e.notes||"").trim(),n=t?` • ${t}`:"";return`
        <li class="day-entry-item">
          <p class="day-entry-title">${w(`${e.taken_time_display||e.taken_at_display||"-"} • ${e.medicine_name||"-"} • ${e.logged_by_username||"-"}`)}</p>
          <p class="day-entry-meta">${w(`${e.dosage_display||"-"} • ${e.rating_display||e.rating||"-"}${n}`)}</p>
        </li>
      `});m.innerHTML=i.join("")}function ie(n){if(!a||!$||!g)return;e||=u(n.month),$.textContent=n.month_label||e,g.value=e;const i=Number(n.days_in_month||0),d=Number(n.first_weekday||0),r=String(n.today||""),c=new Map;Array.isArray(n.days)&&n.days.forEach(e=>{const t=Number(e.day||0);t>0&&c.set(t,e)}),a.innerHTML="";for(let e=0;e<d;e+=1){const t=document.createElement("div");t.className="calendar-cell is-empty",a.appendChild(t)}let s="";for(let l=1;l<=i;l+=1){const d=`${e}-${String(l).padStart(2,"0")}`,o=c.get(l)||null,u=o?Number(o.entry_count||0):0,f=o&&Array.isArray(o.entries)?o.entries.slice(0,3):[],p=Math.max(0,u-f.length);!s&&u>0&&(s=d);const n=document.createElement("button");n.type="button",n.className="calendar-cell",u>0&&n.classList.add("is-active"),r===d&&n.classList.add("is-today");const h=document.createElement("div");h.className="calendar-cell-head";const m=document.createElement("span");if(m.className="calendar-day-number",m.textContent=String(l),h.appendChild(m),u>0){const e=document.createElement("span");e.className="calendar-day-count",e.textContent=String(u),h.appendChild(e)}if(n.appendChild(h),f.forEach(e=>{const t=document.createElement("p");t.className="calendar-entry-pill",t.textContent=`${e.taken_time_display||"-"} • ${e.medicine_name||"-"}`,n.appendChild(t)}),p>0){const e=document.createElement("p");e.className="calendar-more",e.textContent=`+${p} more`,n.appendChild(e)}n.addEventListener("click",()=>{t=d,T(o,d),F()}),n.dataset.dateKey=d,a.appendChild(n)}const o=t,l=r.startsWith(`${e}-`)?r:"";o&&o.startsWith(`${e}-`)&&Number(o.slice(-2))<=i?t=o:l?t=l:s?t=s:i>0?t=`${e}-01`:t="";const h=t?c.get(Number(t.slice(-2)))||null:null;T(h,t||`${e}-01`),F()}function F(){if(!a||!t)return;const e=a.querySelectorAll(".calendar-cell");e.forEach(e=>{const n=e.dataset.dateKey||"";n===t?e.classList.add("is-selected"):e.classList.remove("is-selected")})}function re(e){const t=new URL(window.location.href);t.searchParams.set("month",e),window.history.replaceState({},"",t.toString())}async function p(t){const n=u(t)||y(new Date);e=n,E("Loading calendar..."),ne();const o=await _("calendar",{params:{month:n}}),s=o.calendar||{};ie(s),re(s.month||n)}if(!K){o("Database unavailable.","error"),E("Database unavailable."),z("Database unavailable.");return}Y(c),q(M,d),G?.addEventListener("click",()=>{p(A(e,-1)).catch(e=>{o(e.message,"error")})}),X?.addEventListener("click",()=>{p(A(e,1)).catch(e=>{o(e.message,"error")})}),g?.addEventListener("change",()=>{const e=u(g.value);if(!e)return;p(e).catch(e=>{o(e.message,"error")})}),Q?.addEventListener("click",()=>{J()}),i?.addEventListener("click",e=>{const t=e.target.closest("[data-close-calendar-create-modal='true']");t&&C(!0)}),document.addEventListener("keydown",e=>{if(e.key!=="Escape")return;i&&!i.hidden&&C(!0)}),n?.addEventListener("submit",async s=>{if(s.preventDefault(),!k){o("Read-only access: entry logging is disabled.","error");return}const a=W(c),i={...a,dosage_value:n.dosage_value.value.trim(),dosage_unit:n.dosage_unit.value.trim(),rating:d?d.value.trim():"",taken_at:n.taken_at.value.trim(),notes:n.notes.value.trim()};if(!te(i)){o("Please complete all required fields.","error");return}H(!0),v&&(v.textContent="Saving...");try{const n=S(i.taken_at.slice(0,10));n&&n.startsWith(`${e}-`)&&(t=n),await _("create",{method:"POST",data:i}),C(!0),await Promise.all([B(),p(e)]),o("Entry saved.")}catch(e){o(e.message,"error")}finally{H(!1),v&&(v.textContent="Save Intake")}}),Promise.all([B(),p(e)]).catch(e=>{o(e.message,"error"),E("Could not load calendar."),z("Could not load day details.")})})