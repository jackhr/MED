document.addEventListener("DOMContentLoaded",()=>{const f=window.MEDICINE_CALENDAR_CONFIG||{},M=f.apiPath||"index.php",C=document.body,A=C.dataset.dbReady==="1",s=document.getElementById("calendar-status"),p=document.getElementById("calendar-month-label"),d=document.getElementById("calendar-month-picker"),O=document.getElementById("calendar-prev"),_=document.getElementById("calendar-next"),n=document.getElementById("calendar-grid"),u=document.getElementById("calendar-day-title"),r=document.getElementById("calendar-day-summary"),o=document.getElementById("calendar-day-list");let e=a(f.initialMonth)||l(new Date),t="";function a(e){const t=String(e||"").trim();return/^\d{4}-(0[1-9]|1[0-2])$/.test(t)?t:""}function l(e){const t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0");return`${t}-${n}`}function v(e,t){const n=a(e);if(!n)return l(new Date);const[s,o]=n.split("-"),i=Number(s),r=Number(o),c=new Date(i,r-1+t,1);return l(c)}function E(e){const t=/^(\d{4})-(\d{2})-(\d{2})$/.exec(String(e));if(!t)return String(e||"-");const n=Number(t[1]),s=Number(t[2]),o=Number(t[3]),i=new Date(n,s-1,o);return i.toLocaleDateString(0[0],{month:"long",day:"numeric",year:"numeric"})}function i(e,t="success"){if(!s)return;s.hidden=!1,s.textContent=e,s.className=t==="error"?"alert alert-error":"alert alert-success"}function w(){if(!s)return;s.hidden=!0,s.textContent=""}function h(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function x(e,t={}){const n=new URL(M,window.location.href);return n.searchParams.set("api",e),Object.entries(t).forEach(([e,t])=>{n.searchParams.set(e,String(t))}),n.toString()}async function y(e,t={}){const s=await fetch(x(e,t),{method:"GET",headers:{Accept:"application/json"}});let n=null;try{n=await s.json()}catch{throw new Error("Server returned an unreadable response.")}if(!s.ok||!n.ok){const e=n?.errors?.join(" ")||n?.error||"Request failed.";throw new Error(e)}return n}function m(e){if(!n)return;n.innerHTML=`
      <div class="calendar-cell is-empty">
        <p class="calendar-empty-text">${h(e)}</p>
      </div>
    `}function j(e){if(!u||!r||!o)return;u.textContent="Day Details",r.textContent=e,o.innerHTML='<li class="day-entry-item is-empty">No entries.</li>'}function b(e,t){if(!u||!r||!o)return;if(u.textContent=E(t),!e||!Array.isArray(e.entries)||e.entries.length===0){r.textContent="No intakes recorded on this day.",o.innerHTML='<li class="day-entry-item is-empty">No entries logged.</li>';return}const n=Number(e.entry_count||e.entries.length),s=Number(e.avg_rating),i=Number.isFinite(s)?`${s.toFixed(2)} / 5`:"--";r.textContent=`${n} intake${n===1?"":"s"} • Avg rating ${i}`;const a=e.entries.map(e=>{const t=String(e.notes||"").trim(),n=t?` • ${t}`:"";return`
        <li class="day-entry-item">
          <p class="day-entry-title">${h(`${e.taken_time_display||e.taken_at_display||"-"} • ${e.medicine_name||"-"} • ${e.logged_by_username||"-"}`)}</p>
          <p class="day-entry-meta">${h(`${e.dosage_display||"-"} • ${e.rating_display||e.rating||"-"}${n}`)}</p>
        </li>
      `});o.innerHTML=a.join("")}function k(s){if(!n||!p||!d)return;e||=a(s.month),p.textContent=s.month_label||e,d.value=e;const r=Number(s.days_in_month||0),h=Number(s.first_weekday||0),c=String(s.today||""),l=new Map;Array.isArray(s.days)&&s.days.forEach(e=>{const t=Number(e.day||0);t>0&&l.set(t,e)}),n.innerHTML="";for(let e=0;e<h;e+=1){const t=document.createElement("div");t.className="calendar-cell is-empty",n.appendChild(t)}let o="";for(let a=1;a<=r;a+=1){const d=`${e}-${String(a).padStart(2,"0")}`,i=l.get(a)||null,u=i?Number(i.entry_count||0):0,f=i&&Array.isArray(i.entries)?i.entries.slice(0,3):[],p=Math.max(0,u-f.length);!o&&u>0&&(o=d);const s=document.createElement("button");s.type="button",s.className="calendar-cell",u>0&&s.classList.add("is-active"),c===d&&s.classList.add("is-today");const h=document.createElement("div");h.className="calendar-cell-head";const m=document.createElement("span");if(m.className="calendar-day-number",m.textContent=String(a),h.appendChild(m),u>0){const e=document.createElement("span");e.className="calendar-day-count",e.textContent=String(u),h.appendChild(e)}if(s.appendChild(h),f.forEach(e=>{const t=document.createElement("p");t.className="calendar-entry-pill",t.textContent=`${e.taken_time_display||"-"} • ${e.medicine_name||"-"}`,s.appendChild(t)}),p>0){const e=document.createElement("p");e.className="calendar-more",e.textContent=`+${p} more`,s.appendChild(e)}s.addEventListener("click",()=>{t=d,b(i,d),g()}),s.dataset.dateKey=d,n.appendChild(s)}const i=t,u=c.startsWith(`${e}-`)?c:"";i&&i.startsWith(`${e}-`)&&Number(i.slice(-2))<=r?t=i:u?t=u:o?t=o:r>0?t=`${e}-01`:t="";const m=t?l.get(Number(t.slice(-2)))||null:null;b(m,t||`${e}-01`),g()}function g(){if(!n||!t)return;const e=n.querySelectorAll(".calendar-cell");e.forEach(e=>{const n=e.dataset.dateKey||"";n===t?e.classList.add("is-selected"):e.classList.remove("is-selected")})}function S(e){const t=new URL(window.location.href);t.searchParams.set("month",e),window.history.replaceState({},"",t.toString())}async function c(t){const n=a(t)||l(new Date);e=n,m("Loading calendar..."),w();const o=await y("calendar",{month:n}),s=o.calendar||{};k(s),S(s.month||n)}if(!A){i("Database unavailable.","error"),m("Database unavailable."),j("Database unavailable.");return}O?.addEventListener("click",()=>{c(v(e,-1)).catch(e=>{i(e.message,"error")})}),_?.addEventListener("click",()=>{c(v(e,1)).catch(e=>{i(e.message,"error")})}),d?.addEventListener("change",()=>{const e=a(d.value);if(!e)return;c(e).catch(e=>{i(e.message,"error")})}),c(e).catch(e=>{i(e.message,"error"),m("Could not load calendar."),j("Could not load day details.")})})