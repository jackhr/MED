document.addEventListener("DOMContentLoaded",()=>{const T=window.MEDICINE_LOG_CONFIG||{},zt=T.apiPath||window.location.pathname,o=T.canWrite!==!1&&T.canWrite!=="false",Ze=o?7:6,ue=document.body,Tt=ue.dataset.dbReady==="1",D=document.getElementById("status-banner"),Mt=document.getElementById("metric-today"),St=document.getElementById("metric-week"),Qe=document.getElementById("metric-rating-week"),u=document.getElementById("create-intake-form"),M=u?.querySelector("button[type='submit']"),I=document.getElementById("taken_at"),B=document.getElementById("dosage_value"),W=document.getElementById("dosage_unit"),Q=document.getElementById("create-rating-widget"),h=document.getElementById("rating"),_=document.getElementById("entries-body"),be=document.getElementById("table-meta"),S=document.getElementById("pagination"),At=document.getElementById("history-filter-form"),Se=document.getElementById("history-filter-summary"),Me=document.getElementById("filter_search"),v=document.getElementById("filter_medicine_id"),Te=document.getElementById("filter_rating"),pe=document.getElementById("filter_from_date"),fe=document.getElementById("filter_to_date"),kt=document.getElementById("history-filter-clear"),Et=document.getElementById("history-filter-last7"),wt=document.getElementById("history-filter-last30"),ae=document.getElementById("history-filter-toggle"),L=document.getElementById("history-tools-panel"),le=document.getElementById("data-tools-toggle"),te=document.getElementById("data-tools-panel"),_t=document.getElementById("export-csv-btn"),nt=document.getElementById("export-csv-all-btn"),yt=document.getElementById("backup-json-btn"),jt=document.getElementById("backup-sql-btn"),w=document.getElementById("schedules-body"),E=document.getElementById("schedule-form"),C=document.getElementById("schedule-submit-btn"),g=document.getElementById("schedule_medicine_id"),we=document.getElementById("schedule_dosage_value"),_e=document.getElementById("schedule_dosage_unit"),J=document.getElementById("schedule_time_of_day"),je=document.getElementById("schedule_is_active"),K=document.getElementById("schedule-meta"),A=document.getElementById("push-status"),oe=document.getElementById("enable-push-btn"),G=document.getElementById("disable-push-btn"),X=document.getElementById("test-push-btn"),z=document.getElementById("run-reminders-btn"),bt=Boolean(E||w||K||A||oe||G||X||z),x=document.getElementById("edit-modal"),V=document.getElementById("edit-intake-form"),b=V?.querySelector("button[type='submit']"),k=document.getElementById("delete-entry-btn"),ve=document.getElementById("edit_id"),Y=document.getElementById("edit_dosage_value"),ie=document.getElementById("edit_dosage_unit"),R=document.getElementById("edit-rating-widget"),a=document.getElementById("edit_rating"),Je=document.getElementById("edit_taken_at"),Ue=document.getElementById("edit_notes"),r={picker:document.getElementById("create-medicine-picker"),select:document.getElementById("medicine_select"),custom:document.getElementById("medicine_custom")},O={picker:document.getElementById("edit-medicine-picker"),select:document.getElementById("edit_medicine_select"),custom:document.getElementById("edit_medicine_custom")};let c=1,me=1,ce=null,n=[],N=[],i=null,U=null,y=null;const Ge=String(T.pushPublicKey||""),$=Boolean(T.pushConfigured)&&Ge!=="";let e={search:"",medicine_id:"",rating:"",from_date:"",to_date:""};const Oe=new Map,Ye=new Map;function ft(){if(o)return;ue.classList.add("is-read-only"),u?.querySelectorAll("input, select, textarea, button").forEach(e=>{e.disabled=!0}),M&&(M.textContent="Read-Only"),b&&(b.disabled=!0),k&&(k.disabled=!0),E?.querySelectorAll("input, select, textarea, button").forEach(e=>{e.disabled=!0}),C&&(C.textContent="Read-Only",C.disabled=!0),z&&(z.disabled=!0)}function qe(e,t={}){const n=new URL(zt,window.location.origin);return n.searchParams.set("api",e),Object.entries(t).forEach(([e,t])=>{n.searchParams.set(e,String(t))}),n.toString()}async function s(e,t={}){const a=t.method||"GET",r=t.params||{},o=t.data,s={method:a,headers:{Accept:"application/json"}};o!==0[0]&&(s.headers["Content-Type"]="application/json",s.body=JSON.stringify(o));const i=await fetch(qe(e,r),s);let n=null;try{n=await i.json()}catch{throw new Error("Server returned an unreadable response.")}if(!i.ok||!n.ok){const e=n?.errors?.join(" ")||n?.error||"Request failed.";throw new Error(e)}return n}function Ae(){const e=new Date;return new Date(e.getTime()-e.getTimezoneOffset()*6e4).toISOString().slice(0,16)}function We(e){return new Date(e.getTime()-e.getTimezoneOffset()*6e4).toISOString().slice(0,10)}function $e(e){const t=String(e||"").trim();return/^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])$/.test(t)?t:""}function P(e={}){const i=String(e.search||"").trim().slice(0,120),o=Number(e.medicine_id),a=Number.isInteger(o)&&o>0?String(o):"",t=Number(e.rating),r=Number.isInteger(t)&&t>=1&&t<=5?String(t):"",n=$e(e.from_date),s=$e(e.to_date);return n&&s&&n>s?{search:i,medicine_id:a,rating:r,from_date:s,to_date:n}:{search:i,medicine_id:a,rating:r,from_date:n,to_date:s}}function se(e){return Boolean(e.search||e.medicine_id||e.rating||e.from_date||e.to_date)}function Pe(){return P({search:Me?.value||"",medicine_id:v?.value||"",rating:Te?.value||"",from_date:pe?.value||"",to_date:fe?.value||""})}function ne(e){Me&&(Me.value=e.search),v&&(v.value=e.medicine_id),Te&&(Te.value=e.rating),pe&&(pe.value=e.from_date),fe&&(fe.value=e.to_date)}function mt(t){const n={page:t};return e.search&&(n.search=e.search),e.medicine_id&&(n.medicine_id=e.medicine_id),e.rating&&(n.rating=e.rating),e.from_date&&(n.from_date=e.from_date),e.to_date&&(n.to_date=e.to_date),n}function ht(){const t={};return e.search&&(t.search=e.search),e.medicine_id&&(t.medicine_id=e.medicine_id),e.rating&&(t.rating=e.rating),e.from_date&&(t.from_date=e.from_date),e.to_date&&(t.to_date=e.to_date),t}function q(e,t={}){const s=qe(e,t),n=document.createElement("a");n.href=s,n.rel="noopener",n.style.display="none",document.body.appendChild(n),n.click(),n.remove()}function ze(t=null,s=null){if(!Se)return;if(!se(e)){Se.textContent="No filters applied.";return}const o=[];if(e.search&&o.push(`Search: "${e.search}"`),e.medicine_id){const t=n.find(t=>String(t.id)===e.medicine_id);t&&o.push(`Medicine: ${t.name}`)}e.rating&&o.push(`Rating: ${e.rating}â˜…`),e.from_date&&o.push(`From: ${e.from_date}`),e.to_date&&o.push(`To: ${e.to_date}`),Number.isInteger(t)&&Number.isInteger(s)&&s>=t&&o.push(`${t} matching of ${s} total`),Se.textContent=o.join(" | ")}async function He(t){const s=Math.max(1,Number(t)||1),o=new Date,n=new Date;n.setDate(n.getDate()-(s-1)),e=P({...e,from_date:We(n),to_date:We(o)}),ne(e),await j(1)}function t(e,t="success"){if(!D)return;ce&&(window.clearTimeout(ce),ce=null),D.hidden=!1,D.textContent=e,D.className=t==="error"?"alert alert-error":"alert alert-success",ce=window.setTimeout(()=>{D.hidden=!0},3200)}function Fe(e){const t=Boolean(e);L&&(L.hidden=!t),ae&&(ae.textContent=t?"Hide Filters":"Show Filters",ae.setAttribute("aria-expanded",t?"true":"false"))}function Ve(e){const t=Boolean(e);te&&(te.hidden=!t),le&&(le.textContent=t?"Hide Data Tools":"Show Data Tools",le.setAttribute("aria-expanded",t?"true":"false"))}function ut(e){return e==null||e===""?"-":String(e)}function m(e,t=""){const n=document.createElement("td");return n.textContent=ut(e),t&&(n.className=t),n}function lt(e){const t=Number(e);return Number.isFinite(t)?t.toFixed(2).replace(/\.?0+$/,""):null}function at(e){const t=new Map;if(e.forEach(e=>{const n=String(e?.dosage_unit||"").trim().toLowerCase(),s=Number(e?.dosage_value);if(!n||!Number.isFinite(s))return;t.set(n,(t.get(n)||0)+s)}),t.size===0)return"";const s=Array.from(t.entries()).sort(([e],[t])=>e==="mg"&&t!=="mg"?-1:t==="mg"&&e!=="mg"?1:e.localeCompare(t)),n=s.map(([e,t])=>{const n=lt(t);return n?`${n} ${e}`:null}).filter(Boolean);if(n.length===0)return"";const o=n.length===1?"Total":"Totals";return` | ${o}: ${n.join(", ")}`}function Ee(e){if(!_)return;_.innerHTML="";const n=document.createElement("tr"),t=document.createElement("td");t.className="empty-cell",t.colSpan=Ze,t.textContent=e,n.appendChild(t),_.appendChild(n)}function it(t){if(!_)return;if(Oe.clear(),_.innerHTML="",!t.length){Ee(se(e)?"No matching entries.":"No entries yet.");return}const n=[];t.forEach(e=>{const t=e.taken_day_key||(typeof e.taken_at=="string"?e.taken_at.slice(0,10):""),o=e.taken_day_display||e.taken_at_display||t,s=n[n.length-1];s&&s.dayKey===t?s.entries.push(e):n.push({dayKey:t,dayLabel:o,entries:[e]})}),n.forEach(e=>{if(e.entries.length>1){const t=document.createElement("tr");t.className="day-group-row";const n=document.createElement("td");n.colSpan=Ze;const s=e.entries.length===1?"intake":"intakes",o=at(e.entries);n.textContent=`${e.dayLabel} (${e.entries.length} ${s})${o}`,t.appendChild(n),_.appendChild(t)}e.entries.forEach(t=>{Oe.set(t.id,t);const s=e.entries.length>1,n=document.createElement("tr");n.className=s?"entry-row is-nested":"entry-row";const i=s?t.taken_time_display||t.taken_at_display:t.taken_at_display;if(n.appendChild(m(i,s?"nested-time":"")),n.appendChild(m(t.medicine_name)),n.appendChild(m(t.logged_by_username||"Unknown")),n.appendChild(m(t.dosage_display)),n.appendChild(m(t.rating_display||t.rating||"-","rating-cell")),n.appendChild(m(t.notes||"")),o){const s=document.createElement("td"),e=document.createElement("button");e.type="button",e.className="table-action",e.dataset.action="edit",e.dataset.id=String(t.id),e.textContent="Edit",s.appendChild(e),n.appendChild(s)}_.appendChild(n)})})}function ye(e,t,n,s=!1){const o=document.createElement("button");return o.type="button",o.className="page-btn",o.textContent=e,o.disabled=n,n||(o.dataset.page=String(t)),s&&o.classList.add("is-current"),o}function ot(){if(!S)return;if(S.innerHTML="",me<=1)return;S.appendChild(ye("Previous",c-1,c===1));const e=Math.max(1,c-2),t=Math.min(me,c+2);for(let n=e;n<=t;n+=1)S.appendChild(ye(String(n),n,n===c,n===c));S.appendChild(ye("Next",c+1,c===me))}function H(e){const t=Number(e);return Number.isFinite(t)?Math.max(1,Math.min(5,Math.round(t))):3}function st(e){if(e==null||e==="")return"--";const t=Number(e);return Number.isFinite(t)?`${t.toFixed(2)} / 5`:"--"}function ge(e,t,n=0){if(!e)return;const s=n>0?n:t;e.querySelectorAll("button[data-star]").forEach(e=>{const n=H(e.dataset.star);e.classList.toggle("is-active",n<=s),e.setAttribute("aria-checked",n===t?"true":"false")})}function f(e,t,n){if(!e)return;const s=H(n);e.value=String(s),ge(t,s)}function tt(e,t){if(!e||!t)return;f(t,e,t.value),e.addEventListener("mouseover",n=>{const s=n.target.closest("button[data-star]");if(!s||!e.contains(s))return;ge(e,H(t.value),H(s.dataset.star))}),e.addEventListener("mouseleave",()=>{ge(e,H(t.value))}),e.addEventListener("click",n=>{const s=n.target.closest("button[data-star]");if(!s||!e.contains(s))return;f(t,e,s.dataset.star)})}function Re(e,t){if(!e)return;const n=e.querySelector("button[type='submit']");n&&(n.disabled=t)}function he(e){b&&(b.disabled=e),k&&(k.disabled=e)}function d(e,t){const i=e.picker,a=e.select,r=e.custom;if(!i||!a||!r)return;const s=t==="new"?"new":"existing";i.dataset.mode=s,i.querySelectorAll("[data-tab-mode]").forEach(e=>{const t=e.dataset.tabMode===s;e.classList.toggle("is-active",t),e.setAttribute("aria-selected",t?"true":"false")}),i.querySelectorAll("[data-panel-mode]").forEach(e=>{e.hidden=e.dataset.panelMode!==s}),a.disabled=s!=="existing"||n.length===0,a.required=s==="existing"&&n.length>0,r.disabled=s!=="new",r.required=s==="new",o||(a.disabled=!0,r.disabled=!0)}function xe(e){const t=e.picker,n=e.select,s=e.custom;if(!t||!n||!s)return{medicine_mode:"new",medicine_id:0,medicine_name:""};const o=t.dataset.mode==="new"?"new":"existing";return o==="new"?{medicine_mode:"new",medicine_id:0,medicine_name:s.value.trim()}:{medicine_mode:"existing",medicine_id:Number(n.value)||0,medicine_name:""}}function Ke(e){const t=xe(e);if(t.medicine_mode==="existing"&&t.medicine_id>0){const e=n.find(e=>e.id===t.medicine_id);return e?{id:e.id,name:e.name}:null}return t.medicine_mode==="new"&&t.medicine_name?{id:0,name:t.medicine_name}:null}function rt(e,t=0){if(!e)return;if(e.innerHTML="",!n.length){const t=new Option("No medicine types yet","");t.disabled=!0,t.selected=!0,e.add(t);return}n.forEach(t=>{e.add(new Option(t.name,String(t.id)))}),t>0&&n.some(e=>e.id===t)?e.value=String(t):e.value=String(n[0].id)}function ct(){if(!v)return;const t=e.medicine_id;v.innerHTML="",v.add(new Option("All medicines","")),n.forEach(e=>{v.add(new Option(e.name,String(e.id)))}),t&&n.some(e=>String(e.id)===t)?v.value=t:(v.value="",e.medicine_id="")}function Ne(){if(!g)return;const e=g.value;if(g.innerHTML="",!n.length){const e=new Option("No medicine types yet","");e.disabled=!0,e.selected=!0,g.add(e);return}if(n.forEach(e=>{g.add(new Option(e.name,String(e.id)))}),e&&n.some(t=>String(t.id)===e)){g.value=e;return}if(i&&i.id>0&&n.some(e=>e.id===i.id)){g.value=String(i.id);return}g.value=String(n[0].id)}function dt(e){if(!w)return;if(Ye.clear(),w.innerHTML="",!Array.isArray(e)||e.length===0){const t=document.createElement("tr"),e=document.createElement("td");e.className="empty-cell",e.colSpan=5,e.textContent="No schedules yet.",t.appendChild(e),w.appendChild(t);return}e.forEach(e=>{Ye.set(Number(e.id),e);const t=document.createElement("tr");t.appendChild(m(e.time_label||e.time_of_day_input||"-")),t.appendChild(m(e.medicine_name||"-")),t.appendChild(m(e.dosage_display||"-")),t.appendChild(m(e.is_active?"Active":"Paused"));const n=document.createElement("td");if(o){const t=document.createElement("button");t.type="button",t.className="table-action",t.dataset.scheduleAction="toggle",t.dataset.id=String(e.id),t.dataset.active=e.is_active?"1":"0",t.textContent=e.is_active?"Pause":"Resume";const s=document.createElement("button");s.type="button",s.className="table-action schedule-delete-btn",s.dataset.scheduleAction="delete",s.dataset.id=String(e.id),s.textContent="Delete",n.appendChild(t),n.appendChild(s)}else n.textContent="Read only";t.appendChild(n),w.appendChild(t)})}async function ee(){if(!K)return;const e=await s("schedules");N=Array.isArray(e.schedules)?e.schedules:[],dt(N);const t=N.filter(e=>e.is_active).length;K.textContent=`${N.length} schedule${N.length===1?"":"s"} (${t} active)`}function Le(e){if(!E)return;E.querySelectorAll("input, select, button").forEach(t=>{if(t.id==="schedule_is_active")return;t.disabled=e})}function De(){if(!E)return;if(E.reset(),we&&(we.value="20"),_e&&(_e.value="mg"),je&&(je.checked=!0),J&&!J.value){const e=new Date;e.setMinutes(e.getMinutes()+30),J.value=`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}Ne()}function l(e,t="neutral"){if(!A)return;A.textContent=e,A.classList.remove("push-ok","push-error"),t==="ok"&&A.classList.add("push-ok"),t==="error"&&A.classList.add("push-error")}function pt(e){const s="=".repeat((4-e.length%4)%4),o=(e+s).replace(/-/g,"+").replace(/_/g,"/"),t=window.atob(o),n=new Uint8Array(t.length);for(let e=0;e<t.length;e+=1)n[e]=t.charCodeAt(e);return n}function gt(){const e=navigator.userAgent||"",t=navigator.platform||"";return/iPad|iPhone|iPod/.test(e)||t==="MacIntel"&&Number(navigator.maxTouchPoints||0)>1}function vt(){const e=typeof window.matchMedia=="function"&&window.matchMedia("(display-mode: standalone)").matches,t=typeof navigator.standalone=="boolean"&&navigator.standalone;return Boolean(e||t)}function Xe(){return gt()&&!vt()?"On iPhone/iPad, add this site to Home Screen to enable push notifications.":"Push notifications are not supported in this browser context."}function Ce(e){if(!e||!e.pushManager)throw new Error(Xe());return e.pushManager}async function ke(){if(!("serviceWorker"in navigator))throw new Error("Service workers are not supported in this browser.");if(U)return U;const e=new URL("push-sw.js",window.location.href).pathname;if(await navigator.serviceWorker.register(e),U=await navigator.serviceWorker.ready,!U)throw new Error("Service worker did not become ready.");return U}function F(){const e=Boolean(y);oe&&(oe.disabled=!$||e),G&&(G.disabled=!e),X&&(X.disabled=!$||!e)}async function Be(e){const t=e?e.toJSON():null;if(!t)throw new Error("Could not read browser subscription details.");await s("push_subscribe",{method:"POST",data:{endpoint:t.endpoint,keys:t.keys||{},user_agent:navigator.userAgent||""}})}async function Ot(){if(!$)throw new Error("Push is not configured on the server.");if(!("PushManager"in window))throw new Error(Xe());if(Notification.permission==="denied")throw new Error("Notifications are blocked for this site.");const n=await ke(),t=Ce(n),s=await Notification.requestPermission();if(s!=="granted")throw new Error("Notification permission was not granted.");let e=await t.getSubscription();e||(e=await t.subscribe({userVisibleOnly:!0,applicationServerKey:pt(Ge)})),await Be(e),y=e,F(),l("Push enabled for this browser.","ok")}async function xt(){const t=await ke(),n=Ce(t),e=y||await n.getSubscription();if(!e){y=null,F(),l("Push is not enabled in this browser.");return}const o=e.toJSON();await s("push_unsubscribe",{method:"POST",data:{endpoint:o.endpoint||""}}),await e.unsubscribe(),y=null,F(),l("Push disabled for this browser.")}async function Ct(){if(!$){l("Push is not configured. Add VAPID keys in .env.","error"),F();return}try{const e=await ke(),t=Ce(e);y=await t.getSubscription(),F(),y?(await Be(y),l("Push enabled for this browser.","ok")):Notification.permission==="denied"?l("Notifications are blocked in this browser.","error"):l("Push is available. Enable it to receive reminders.")}catch(e){l(e.message||"Could not initialize push.","error")}}function p(e,t=null){const i=e.picker,a=e.select,s=e.custom;if(!i||!a||!s)return;const o=t&&t.id?Number(t.id):0,r=t&&t.name?String(t.name):"";if(rt(a,o),o>0&&n.some(e=>e.id===o)){s.value="",d(e,"existing");return}if(r!==""){s.value=r,d(e,"new");return}if(!n.length){s.value="",d(e,"new");return}const c=i.dataset.mode==="new"?"new":"existing";if(c==="new"){d(e,"new");return}s.value="",d(e,"existing")}function Ie(e){const s=e.picker;if(!s)return;s.addEventListener("click",s=>{const i=s.target.closest("button[data-tab-mode]");if(!i)return;const o=i.dataset.tabMode==="new"?"new":"existing";if(o==="existing"&&n.length===0){t("No medicine types yet. Add a new medicine first.","error");return}d(e,o),o==="new"&&e.custom&&e.custom.focus()})}async function Z(){const t=Ke(r),o=Ke(O),e=await s("medicines");n=Array.isArray(e.medicines)?e.medicines.map(e=>({id:Number(e.id),name:String(e.name||"")})).filter(e=>e.id>0&&e.name!==""):[],ct(),p(r,t),p(O,o),Ne(),ze()}async function re(){const e=await s("dashboard");Mt.textContent=String(e.metrics.entries_today),St.textContent=String(e.metrics.entries_this_week),Qe&&(Qe.textContent=st(e.metrics.average_rating_this_week))}async function j(t=1,n={}){const l=n.syncCreateDefault===!0,a=await s("entries",{params:mt(t)});a.filters&&(e=P(a.filters),ne(e),a.filters.active===!0&&L?.hidden&&Fe(!0));const o=a.pagination;if(c=o.page,me=o.total_pages,o.page===1&&Array.isArray(a.entries))if(a.entries.length>0){const e=a.entries[0];i={id:Number(e.medicine_id)||0,name:String(e.medicine_name||"")},l&&i.id>0&&(p(r,i),d(r,"existing"))}else i=null;if(it(a.entries),be){const t=Number(o.total_entries||0),n=Number(o.total_all_entries??o.total_entries??0),s=a.filters?.active===!0||se(e);s&&n>=t?be.textContent=`Page ${o.page} of ${o.total_pages} | ${t} matching entries (${n} total)`:be.textContent=`Page ${o.page} of ${o.total_pages} | ${t} total entries`,ze(t,n)}ot()}function Ft(e){if(!x||!V||!e)return;if(!o){t("Read-only access: editing is disabled for this workspace.","error");return}ve.value=String(e.id),Y.value=e.dosage_value||"20",ie.value=e.dosage_unit||"mg",a&&f(a,R,e.rating||3),Je.value=e.taken_at_input||Ae(),Ue.value=e.notes||"",p(O,{id:Number(e.medicine_id)||0,name:e.medicine_name||""}),x.hidden=!1,ue.classList.add("modal-open")}function de(){if(!x||!V)return;x.hidden=!0,ue.classList.remove("modal-open"),V.reset(),Y&&(Y.value="20"),ie&&(ie.value="mg"),a&&f(a,R,3),p(O)}function et(e){const t=e.medicine_mode==="existing"&&e.medicine_id>0||e.medicine_mode==="new"&&e.medicine_name!=="";return t&&e.dosage_value!==""&&e.dosage_unit!==""&&e.rating!==""&&e.taken_at!==""}if(!Tt){Ee("Database unavailable.");return}ft(),o||t("Read-only access enabled for this workspace."),Ie(r),Ie(O),tt(Q,h),tt(R,a),p(r),p(O),I&&!I.value&&(I.value=Ae()),B&&!B.value&&(B.value="20"),W&&!W.value&&(W.value="mg"),h&&!h.value?f(h,Q,3):f(h,Q,h?.value||3),a&&!a.value?f(a,R,3):f(a,R,a?.value||3),e=P(e),ne(e),ze(),Fe(se(e)),Ve(!1),F(),$||l("Push is not configured. Add VAPID keys in .env.","error"),ae?.addEventListener("click",()=>{const e=!!L&&!L.hidden;Fe(!e)}),le?.addEventListener("click",()=>{const e=!!te&&!te.hidden;Ve(!e)}),At?.addEventListener("submit",async n=>{n.preventDefault(),e=Pe();try{await j(1)}catch(e){t(e.message,"error")}}),kt?.addEventListener("click",async()=>{e=P({}),ne(e);try{await j(1)}catch(e){t(e.message,"error")}}),Et?.addEventListener("click",async()=>{try{await He(7)}catch(e){t(e.message,"error")}}),wt?.addEventListener("click",async()=>{try{await He(30)}catch(e){t(e.message,"error")}}),_t?.addEventListener("click",()=>{const t=Pe();e=t,q("export_entries_csv",ht())}),nt?.addEventListener("click",()=>{q("export_entries_csv")}),yt?.addEventListener("click",()=>{q("backup_json")}),jt?.addEventListener("click",()=>{q("backup_sql")}),E?.addEventListener("submit",async e=>{if(e.preventDefault(),!o){t("Read-only access: schedule updates are disabled.","error");return}const n={medicine_id:Number(g?.value||0),dosage_value:String(we?.value||"").trim(),dosage_unit:String(_e?.value||"").trim(),time_of_day:String(J?.value||"").trim(),is_active:je?.checked?1:0};if(!n.medicine_id||!n.dosage_value||!n.dosage_unit||!n.time_of_day){t("Please complete all schedule fields.","error");return}Le(!0),C&&(C.textContent="Saving...");try{await s("schedule_create",{method:"POST",data:n}),t("Schedule added."),De(),await ee()}catch(e){t(e.message,"error")}finally{Le(!1),C&&(C.textContent="Add Schedule")}}),w?.addEventListener("click",async e=>{if(!o)return;const n=e.target.closest("button[data-schedule-action]");if(!n)return;const i=Number(n.dataset.id||0);if(!i)return;if(n.dataset.scheduleAction==="delete"){const e=window.confirm("Delete this schedule?");if(!e)return;try{await s("schedule_delete",{method:"POST",data:{id:i}}),t("Schedule deleted."),await ee()}catch(e){t(e.message,"error")}return}if(n.dataset.scheduleAction==="toggle"){const e=n.dataset.active==="1";try{await s("schedule_toggle",{method:"POST",data:{id:i,is_active:e?0:1}}),t(e?"Schedule paused.":"Schedule resumed."),await ee()}catch(e){t(e.message,"error")}}}),oe?.addEventListener("click",async()=>{try{await Ot(),t("Push notifications enabled.")}catch(e){t(e.message,"error"),l(e.message,"error")}}),G?.addEventListener("click",async()=>{try{await xt(),t("Push notifications disabled.")}catch(e){t(e.message,"error"),l(e.message,"error")}}),X?.addEventListener("click",async()=>{try{const n=await s("push_test",{method:"POST"}),e=n.dispatch||{};t(`Test push sent: ${e.sent||0}/${e.attempted||0} delivered.`)}catch(e){t(e.message,"error")}}),z?.addEventListener("click",async()=>{if(!o){t("Read-only access: reminder checks are disabled.","error");return}const e=z;e&&(e.disabled=!0,e.textContent="Running...");try{const a=await s("process_reminders",{method:"POST"}),e=a.result||{},n=Number(e.due||0),o=Number(e.sent||0),r=Number(e.push_attempted||0),i=Number(e.push_failed||0),c=Number(e.push_deactivated||0),l=`Reminder check complete. Due: ${n}, sent: ${o}, attempted: ${r}, failed: ${i}, deactivated: ${c}.`;t(l,i>0||n>0&&o===0?"error":"success")}catch(e){t(e.message,"error")}finally{e&&(e.disabled=!1,e.textContent="Run Reminder Check")}}),u?.addEventListener("submit",async e=>{if(e.preventDefault(),!o){t("Read-only access: entry logging is disabled.","error");return}const c=xe(r),a={...c,dosage_value:u.dosage_value.value.trim(),dosage_unit:u.dosage_unit.value.trim(),rating:h?h.value.trim():"",taken_at:u.taken_at.value.trim(),notes:u.notes.value.trim()};if(!et(a)){t("Please complete all required fields.","error");return}Re(u,!0),M&&(M.textContent="Saving...");try{await s("create",{method:"POST",data:a}),t("Entry saved."),u.reset(),I&&(I.value=Ae()),B&&(B.value="20"),W&&(W.value="mg"),h&&f(h,Q,3),await Promise.all([Z(),re(),j(1)]),i&&i.id>0?(p(r,i),d(r,"existing")):d(r,n.length>0?"existing":"new")}catch(e){t(e.message,"error")}finally{Re(u,!1),M&&(M.textContent="Save Intake")}}),_?.addEventListener("click",e=>{if(!o)return;const n=e.target.closest("button[data-action='edit']");if(!n)return;const i=Number(n.dataset.id),s=Oe.get(i);if(!s){t("Could not load that entry.","error");return}Ft(s)}),V?.addEventListener("submit",async e=>{if(e.preventDefault(),!o){t("Read-only access: editing is disabled.","error");return}const i=xe(O),n={id:Number(ve.value),...i,dosage_value:Y.value.trim(),dosage_unit:ie.value.trim(),rating:a?a.value.trim():"",taken_at:Je.value.trim(),notes:Ue.value.trim()};if(!n.id||!et(n)){t("Please complete all required fields.","error");return}he(!0),b&&(b.textContent="Saving...");try{await s("update",{method:"POST",data:n}),de(),t("Entry updated."),await Promise.all([Z(),re(),j(c)])}catch(e){t(e.message,"error")}finally{he(!1),b&&(b.textContent="Save Changes")}}),k?.addEventListener("click",async()=>{if(!o){t("Read-only access: deleting is disabled.","error");return}const e=Number(ve.value);if(!e){t("Missing entry ID for delete.","error");return}const n=window.confirm("Delete this entry permanently?");if(!n)return;he(!0),k.textContent="Deleting...";try{await s("delete",{method:"POST",data:{id:e}}),de(),t("Entry deleted."),await Promise.all([Z(),re(),j(c)])}catch(e){t(e.message,"error")}finally{he(!1),k.textContent="Delete Entry"}}),S?.addEventListener("click",async e=>{const n=e.target.closest("button[data-page]");if(!n||n.disabled)return;const s=Number(n.dataset.page);if(!s||s===c)return;try{await j(s)}catch(e){t(e.message,"error")}}),x?.addEventListener("click",e=>{const t=e.target.closest("[data-close-modal='true']");t&&de()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&x&&!x.hidden&&de()}),Promise.all([Z(),re(),j(1)]).then(async()=>{if(i&&i.id>0&&(p(r,i),d(r,"existing")),bt){De();try{await ee()}catch{K&&(K.textContent="Schedules unavailable. Run latest DB migrations."),w&&(w.innerHTML='<tr><td class="empty-cell" colspan="5">Schedules unavailable.</td></tr>')}await Ct()}}).catch(e=>{t(e.message,"error"),Ee("Could not load entries.")})})