document.addEventListener("DOMContentLoaded",()=>{const q=window.MEDICINE_LOG_CONFIG||{},Lt=q.apiPath||window.location.pathname,i=q.canWrite!==!1&&q.canWrite!=="false",Je=i?7:6,Me=document.body,Tt=Me.dataset.dbReady==="1",W=document.getElementById("status-banner"),Ft=document.getElementById("metric-today"),St=document.getElementById("metric-week"),Ye=document.getElementById("metric-rating-week"),d=document.getElementById("create-intake-form"),T=d?.querySelector("button[type='submit']"),g=document.getElementById("taken_at"),E=document.getElementById("dosage_value"),M=document.getElementById("dosage_unit"),R=document.getElementById("create-rating-widget"),u=document.getElementById("rating"),j=document.getElementById("create-modal"),vt=document.getElementById("open-create-modal-btn"),_=document.getElementById("entries-body"),Te=document.getElementById("table-meta"),N=document.getElementById("pagination"),rt=document.getElementById("history-filter-form"),Oe=document.getElementById("history-filter-summary"),be=document.getElementById("filter_search"),b=document.getElementById("filter_medicine_id"),ye=document.getElementById("filter_rating"),ke=document.getElementById("filter_from_date"),ze=document.getElementById("filter_to_date"),gt=document.getElementById("history-filter-clear"),_t=document.getElementById("history-filter-last7"),xt=document.getElementById("history-filter-last30"),oe=document.getElementById("history-filter-toggle"),G=document.getElementById("history-tools-panel"),X=document.getElementById("data-tools-toggle"),ne=document.getElementById("data-tools-panel"),it=document.getElementById("export-csv-btn"),Ct=document.getElementById("export-csv-all-btn"),Mt=document.getElementById("backup-json-btn"),zt=document.getElementById("backup-sql-btn"),x=document.getElementById("schedules-body"),S=document.getElementById("schedule-form"),k=document.getElementById("schedule-submit-btn"),y=document.getElementById("schedule_medicine_id"),Ce=document.getElementById("schedule_dosage_value"),xe=document.getElementById("schedule_dosage_unit"),ee=document.getElementById("schedule_time_of_day"),_e=document.getElementById("schedule_is_active"),Y=document.getElementById("schedule-meta"),z=document.getElementById("push-status"),J=document.getElementById("enable-push-btn"),Q=document.getElementById("disable-push-btn"),Z=document.getElementById("test-push-btn"),H=document.getElementById("run-reminders-btn"),Ht=Boolean(S||x||Y||z||J||Q||Z||H),v=document.getElementById("edit-modal"),B=document.getElementById("edit-intake-form"),C=B?.querySelector("button[type='submit']"),F=document.getElementById("delete-entry-btn"),je=document.getElementById("edit_id"),ae=document.getElementById("edit_dosage_value"),re=document.getElementById("edit_dosage_unit"),L=document.getElementById("edit-rating-widget"),c=document.getElementById("edit_rating"),st=document.getElementById("edit_taken_at"),Be=document.getElementById("edit_notes"),o={picker:document.getElementById("create-medicine-picker"),select:document.getElementById("medicine_select"),custom:document.getElementById("medicine_custom")},A={picker:document.getElementById("edit-medicine-picker"),select:document.getElementById("edit_medicine_select"),custom:document.getElementById("edit_medicine_custom")};let r=1,pe=1,se=null,n=[],I=[],s=null,K=null,O=null;const Pt="20260222-1",tt=String(q.pushPublicKey||""),U=Boolean(q.pushConfigured)&&tt!=="";let e={search:"",medicine_id:"",rating:"",from_date:"",to_date:""};const Ee=new Map,Re=new Map;function Nt(){if(i)return;Me.classList.add("is-read-only"),d?.querySelectorAll("input, select, textarea, button").forEach(e=>{e.disabled=!0}),T&&(T.textContent="Read-Only"),C&&(C.disabled=!0),F&&(F.disabled=!0),S?.querySelectorAll("input, select, textarea, button").forEach(e=>{e.disabled=!0}),k&&(k.textContent="Read-Only",k.disabled=!0),H&&(H.disabled=!0)}function Ze(e,t={}){const n=new URL(Lt,window.location.origin);return n.searchParams.set("api",e),Object.entries(t).forEach(([e,t])=>{n.searchParams.set(e,String(t))}),n.toString()}async function a(e,t={}){const a=t.method||"GET",r=t.params||{},o=t.data,s={method:a,headers:{Accept:"application/json"}};o!==0[0]&&(s.headers["Content-Type"]="application/json",s.body=JSON.stringify(o));const i=await fetch(Ze(e,r),s);let n=null;try{n=await i.json()}catch{throw new Error("Server returned an unreadable response.")}if(!i.ok||!n.ok){const e=n?.errors?.join(" ")||n?.error||"Request failed.";throw new Error(e)}return n}function P(){const e=new Date;return new Date(e.getTime()-e.getTimezoneOffset()*6e4).toISOString().slice(0,16)}function Pe(e){return new Date(e.getTime()-e.getTimezoneOffset()*6e4).toISOString().slice(0,10)}function qe(e){const t=String(e||"").trim();return/^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])$/.test(t)?t:""}function $(e={}){const i=String(e.search||"").trim().slice(0,120),o=Number(e.medicine_id),a=Number.isInteger(o)&&o>0?String(o):"",t=Number(e.rating),r=Number.isInteger(t)&&t>=1&&t<=5?String(t):"",n=qe(e.from_date),s=qe(e.to_date);return n&&s&&n>s?{search:i,medicine_id:a,rating:r,from_date:s,to_date:n}:{search:i,medicine_id:a,rating:r,from_date:n,to_date:s}}function te(e){return Boolean(e.search||e.medicine_id||e.rating||e.from_date||e.to_date)}function He(){return $({search:be?.value||"",medicine_id:b?.value||"",rating:ye?.value||"",from_date:ke?.value||"",to_date:ze?.value||""})}function ie(e){be&&(be.value=e.search),b&&(b.value=e.medicine_id),ye&&(ye.value=e.rating),ke&&(ke.value=e.from_date),ze&&(ze.value=e.to_date)}function Ot(t){const n={page:t};return e.search&&(n.search=e.search),e.medicine_id&&(n.medicine_id=e.medicine_id),e.rating&&(n.rating=e.rating),e.from_date&&(n.from_date=e.from_date),e.to_date&&(n.to_date=e.to_date),n}function wt(){const t={};return e.search&&(t.search=e.search),e.medicine_id&&(t.medicine_id=e.medicine_id),e.rating&&(t.rating=e.rating),e.from_date&&(t.from_date=e.from_date),e.to_date&&(t.to_date=e.to_date),t}function ce(e,t={}){const s=Ze(e,t),n=document.createElement("a");n.href=s,n.rel="noopener",n.style.display="none",document.body.appendChild(n),n.click(),n.remove()}function Ne(t=null,s=null){if(!Oe)return;if(!te(e)){Oe.textContent="No filters applied.";return}const o=[];if(e.search&&o.push(`Search: "${e.search}"`),e.medicine_id){const t=n.find(t=>String(t.id)===e.medicine_id);t&&o.push(`Medicine: ${t.name}`)}e.rating&&o.push(`Rating: ${e.rating}â˜…`),e.from_date&&o.push(`From: ${e.from_date}`),e.to_date&&o.push(`To: ${e.to_date}`),Number.isInteger(t)&&Number.isInteger(s)&&s>=t&&o.push(`${t} matching of ${s} total`),Oe.textContent=o.join(" | ")}async function Ve(t){const s=Math.max(1,Number(t)||1),o=new Date,n=new Date;n.setDate(n.getDate()-(s-1)),e=$({...e,from_date:Pe(n),to_date:Pe(o)}),ie(e),await w(1)}function t(e,t="success"){if(!W)return;se&&(window.clearTimeout(se),se=null),W.hidden=!1,W.textContent=e,W.className=t==="error"?"alert alert-error":"alert alert-success",se=window.setTimeout(()=>{W.hidden=!0},3200)}function De(e){const t=Boolean(e);G&&(G.hidden=!t),oe&&(oe.textContent=t?"Hide Filters":"Show Filters",oe.setAttribute("aria-expanded",t?"true":"false"))}function Ue(e){const t=Boolean(e);ne&&(ne.hidden=!t),X&&(X.textContent=t?"Hide Data Tools":"Show Data Tools",X.setAttribute("aria-expanded",t?"true":"false"))}function pt(e){return e==null||e===""?"-":String(e)}function p(e,t=""){const n=document.createElement("td");return n.textContent=pt(e),t&&(n.className=t),n}function ft(e){const t=Number(e);return Number.isFinite(t)?t.toFixed(2).replace(/\.?0+$/,""):null}function ht(e){const t=new Map;if(e.forEach(e=>{const n=String(e?.dosage_unit||"").trim().toLowerCase(),s=Number(e?.dosage_value);if(!n||!Number.isFinite(s))return;t.set(n,(t.get(n)||0)+s)}),t.size===0)return"";const s=Array.from(t.entries()).sort(([e],[t])=>e==="mg"&&t!=="mg"?-1:t==="mg"&&e!=="mg"?1:e.localeCompare(t)),n=s.map(([e,t])=>{const n=ft(t);return n?`${n} ${e}`:null}).filter(Boolean);if(n.length===0)return"";const o=n.length===1?"Total":"Totals";return` | ${o}: ${n.join(", ")}`}function Fe(e){if(!_)return;_.innerHTML="";const n=document.createElement("tr"),t=document.createElement("td");t.className="empty-cell",t.colSpan=Je,t.textContent=e,n.appendChild(t),_.appendChild(n)}function lt(t){if(!_)return;if(Ee.clear(),_.innerHTML="",!t.length){Fe(te(e)?"No matching entries.":"No entries yet.");return}const n=[];t.forEach(e=>{const t=e.taken_day_key||(typeof e.taken_at=="string"?e.taken_at.slice(0,10):""),o=e.taken_day_display||e.taken_at_display||t,s=n[n.length-1];s&&s.dayKey===t?s.entries.push(e):n.push({dayKey:t,dayLabel:o,entries:[e]})}),n.forEach(e=>{if(e.entries.length>1){const t=document.createElement("tr");t.className="day-group-row";const n=document.createElement("td");n.colSpan=Je;const s=e.entries.length===1?"intake":"intakes",o=ht(e.entries);n.textContent=`${e.dayLabel} (${e.entries.length} ${s})${o}`,t.appendChild(n),_.appendChild(t)}e.entries.forEach(t=>{Ee.set(t.id,t);const s=e.entries.length>1,n=document.createElement("tr");n.className=s?"entry-row is-nested":"entry-row";const o=s?t.taken_time_display||t.taken_at_display:t.taken_at_display;if(n.appendChild(p(o,s?"nested-time":"")),n.appendChild(p(t.medicine_name)),n.appendChild(p(t.logged_by_username||"Unknown")),n.appendChild(p(t.dosage_display)),n.appendChild(p(t.rating_display||t.rating||"-","rating-cell")),n.appendChild(p(t.notes||"","notes-cell")),i){const s=document.createElement("td"),e=document.createElement("button");e.type="button",e.className="table-action",e.dataset.action="edit",e.dataset.id=String(t.id),e.textContent="Edit",s.appendChild(e),n.appendChild(s)}_.appendChild(n)})})}function Se(e,t,n,s=!1){const o=document.createElement("button");return o.type="button",o.className="page-btn",o.textContent=e,o.disabled=n,n||(o.dataset.page=String(t)),s&&o.classList.add("is-current"),o}function ct(){if(!N)return;if(N.innerHTML="",pe<=1)return;N.appendChild(Se("Previous",r-1,r===1));const e=Math.max(1,r-2),t=Math.min(pe,r+2);for(let n=e;n<=t;n+=1)N.appendChild(Se(String(n),n,n===r,n===r));N.appendChild(Se("Next",r+1,r===pe))}function V(e){const t=Number(e);return Number.isFinite(t)?Math.max(1,Math.min(5,Math.round(t))):3}function at(e){if(e==null||e==="")return"--";const t=Number(e);return Number.isFinite(t)?`${t.toFixed(2)} / 5`:"--"}function ge(e,t,n=0){if(!e)return;const s=n>0?n:t;e.querySelectorAll("button[data-star]").forEach(e=>{const n=V(e.dataset.star);e.classList.toggle("is-active",n<=s),e.setAttribute("aria-checked",n===t?"true":"false")})}function f(e,t,n){if(!e)return;const s=V(n);e.value=String(s),ge(t,s)}function ot(e,t){if(!e||!t)return;f(t,e,t.value),e.addEventListener("mouseover",n=>{const s=n.target.closest("button[data-star]");if(!s||!e.contains(s))return;ge(e,V(t.value),V(s.dataset.star))}),e.addEventListener("mouseleave",()=>{ge(e,V(t.value))}),e.addEventListener("click",n=>{const s=n.target.closest("button[data-star]");if(!s||!e.contains(s))return;f(t,e,s.dataset.star)})}function et(e,t){if(!e)return;const n=e.querySelector("button[type='submit']");n&&(n.disabled=t)}function le(e){C&&(C.disabled=e),F&&(F.disabled=e)}function l(e,t){const o=e.picker,a=e.select,r=e.custom;if(!o||!a||!r)return;const s=t==="new"?"new":"existing";o.dataset.mode=s,o.querySelectorAll("[data-tab-mode]").forEach(e=>{const t=e.dataset.tabMode===s;e.classList.toggle("is-active",t),e.setAttribute("aria-selected",t?"true":"false")}),o.querySelectorAll("[data-panel-mode]").forEach(e=>{e.hidden=e.dataset.panelMode!==s}),a.disabled=s!=="existing"||n.length===0,a.required=s==="existing"&&n.length>0,r.disabled=s!=="new",r.required=s==="new",i||(a.disabled=!0,r.disabled=!0)}function Ae(e){const t=e.picker,n=e.select,s=e.custom;if(!t||!n||!s)return{medicine_mode:"new",medicine_id:0,medicine_name:""};const o=t.dataset.mode==="new"?"new":"existing";return o==="new"?{medicine_mode:"new",medicine_id:0,medicine_name:s.value.trim()}:{medicine_mode:"existing",medicine_id:Number(n.value)||0,medicine_name:""}}function Qe(e){const t=Ae(e);if(t.medicine_mode==="existing"&&t.medicine_id>0){const e=n.find(e=>e.id===t.medicine_id);return e?{id:e.id,name:e.name}:null}return t.medicine_mode==="new"&&t.medicine_name?{id:0,name:t.medicine_name}:null}function dt(e,t=0){if(!e)return;if(e.innerHTML="",!n.length){const t=new Option("No medicine types yet","");t.disabled=!0,t.selected=!0,e.add(t);return}n.forEach(t=>{e.add(new Option(t.name,String(t.id)))}),t>0&&n.some(e=>e.id===t)?e.value=String(t):e.value=String(n[0].id)}function ut(){if(!b)return;const t=e.medicine_id;b.innerHTML="",b.add(new Option("All medicines","")),n.forEach(e=>{b.add(new Option(e.name,String(e.id)))}),t&&n.some(e=>String(e.id)===t)?b.value=t:(b.value="",e.medicine_id="")}function Ge(){if(!y)return;const e=y.value;if(y.innerHTML="",!n.length){const e=new Option("No medicine types yet","");e.disabled=!0,e.selected=!0,y.add(e);return}if(n.forEach(e=>{y.add(new Option(e.name,String(e.id)))}),e&&n.some(t=>String(t.id)===e)){y.value=e;return}if(s&&s.id>0&&n.some(e=>e.id===s.id)){y.value=String(s.id);return}y.value=String(n[0].id)}function mt(e){if(!x)return;if(Re.clear(),x.innerHTML="",!Array.isArray(e)||e.length===0){const t=document.createElement("tr"),e=document.createElement("td");e.className="empty-cell",e.colSpan=5,e.textContent="No schedules yet.",t.appendChild(e),x.appendChild(t);return}e.forEach(e=>{Re.set(Number(e.id),e);const t=document.createElement("tr");t.appendChild(p(e.time_label||e.time_of_day_input||"-")),t.appendChild(p(e.medicine_name||"-")),t.appendChild(p(e.dosage_display||"-")),t.appendChild(p(e.is_active?"Active":"Paused"));const n=document.createElement("td");if(i){const t=document.createElement("button");t.type="button",t.className="table-action",t.dataset.scheduleAction="toggle",t.dataset.id=String(e.id),t.dataset.active=e.is_active?"1":"0",t.textContent=e.is_active?"Pause":"Resume";const s=document.createElement("button");s.type="button",s.className="table-action schedule-delete-btn",s.dataset.scheduleAction="delete",s.dataset.id=String(e.id),s.textContent="Delete",n.appendChild(t),n.appendChild(s)}else n.textContent="Read only";t.appendChild(n),x.appendChild(t)})}async function de(){if(!Y)return;const e=await a("schedules");I=Array.isArray(e.schedules)?e.schedules:[],mt(I);const t=I.filter(e=>e.is_active).length;Y.textContent=`${I.length} schedule${I.length===1?"":"s"} (${t} active)`}function Ke(e){if(!S)return;S.querySelectorAll("input, select, button").forEach(t=>{if(t.id==="schedule_is_active")return;t.disabled=e})}function $e(){if(!S)return;if(S.reset(),Ce&&(Ce.value="20"),xe&&(xe.value="mg"),_e&&(_e.checked=!0),ee&&!ee.value){const e=new Date;e.setMinutes(e.getMinutes()+30),ee.value=`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}Ge()}function h(e,t="neutral"){if(!z)return;z.textContent=e,z.classList.remove("push-ok","push-error"),t==="ok"&&z.classList.add("push-ok"),t==="error"&&z.classList.add("push-error")}function bt(e){const s="=".repeat((4-e.length%4)%4),o=(e+s).replace(/-/g,"+").replace(/_/g,"/"),t=window.atob(o),n=new Uint8Array(t.length);for(let e=0;e<t.length;e+=1)n[e]=t.charCodeAt(e);return n}function jt(){const e=navigator.userAgent||"",t=navigator.platform||"";return/iPad|iPhone|iPod/.test(e)||t==="MacIntel"&&Number(navigator.maxTouchPoints||0)>1}function yt(){const e=typeof window.matchMedia=="function"&&window.matchMedia("(display-mode: standalone)").matches,t=typeof navigator.standalone=="boolean"&&navigator.standalone;return Boolean(e||t)}function Ie(){return jt()&&!yt()?"On iPhone/iPad, add this site to Home Screen to enable push notifications.":"Push notifications are not supported in this browser context."}function Le(e){if(!e||!e.pushManager)throw new Error(Ie());return e.pushManager}async function ve(){if(!("serviceWorker"in navigator))throw new Error("Service workers are not supported in this browser.");if(K)return K;const e=new URL("push-sw.js",window.location.href);if(e.searchParams.set("v",Pt),await navigator.serviceWorker.register(`${e.pathname}?${e.searchParams.toString()}`),K=await navigator.serviceWorker.ready,!K)throw new Error("Service worker did not become ready.");return K}function D(){const e=Boolean(O);J&&(J.disabled=!U||e),Q&&(Q.disabled=!e),Z&&(Z.disabled=!U||!e)}async function We(e){const t=e?e.toJSON():null;if(!t)throw new Error("Could not read browser subscription details.");await a("push_subscribe",{method:"POST",data:{endpoint:t.endpoint,keys:t.keys||{},user_agent:navigator.userAgent||""}})}async function Et(){if(!U)throw new Error("Push is not configured on the server.");if(!("PushManager"in window))throw new Error(Ie());if(Notification.permission==="denied")throw new Error("Notifications are blocked for this site.");const n=await ve(),t=Le(n),s=await Notification.requestPermission();if(s!=="granted")throw new Error("Notification permission was not granted.");let e=await t.getSubscription();e||(e=await t.subscribe({userVisibleOnly:!0,applicationServerKey:bt(tt)})),await We(e),O=e,D(),h("Push enabled for this browser.","ok")}async function kt(){const t=await ve(),n=Le(t),e=O||await n.getSubscription();if(!e){O=null,D(),h("Push is not enabled in this browser.");return}const s=e.toJSON();await a("push_unsubscribe",{method:"POST",data:{endpoint:s.endpoint||""}}),await e.unsubscribe(),O=null,D(),h("Push disabled for this browser.")}async function At(){if(!U){h("Push is not configured. Add VAPID keys in .env.","error"),D();return}try{const e=await ve(),t=Le(e);O=await t.getSubscription(),D(),O?(await We(O),h("Push enabled for this browser.","ok")):Notification.permission==="denied"?h("Notifications are blocked in this browser.","error"):h("Push is available. Enable it to receive reminders.")}catch(e){h(e.message||"Could not initialize push.","error")}}function m(e,t=null){const i=e.picker,a=e.select,s=e.custom;if(!i||!a||!s)return;const o=t&&t.id?Number(t.id):0,r=t&&t.name?String(t.name):"";if(dt(a,o),o>0&&n.some(e=>e.id===o)){s.value="",l(e,"existing");return}if(r!==""){s.value=r,l(e,"new");return}if(!n.length){s.value="",l(e,"new");return}const c=i.dataset.mode==="new"?"new":"existing";if(c==="new"){l(e,"new");return}s.value="",l(e,"existing")}function Xe(e){const s=e.picker;if(!s)return;s.addEventListener("click",s=>{const i=s.target.closest("button[data-tab-mode]");if(!i)return;const o=i.dataset.tabMode==="new"?"new":"existing";if(o==="existing"&&n.length===0){t("No medicine types yet. Add a new medicine first.","error");return}l(e,o),o==="new"&&e.custom&&e.custom.focus()})}async function ue(){const t=Qe(o),s=Qe(A),e=await a("medicines");n=Array.isArray(e.medicines)?e.medicines.map(e=>({id:Number(e.id),name:String(e.name||"")})).filter(e=>e.id>0&&e.name!==""):[],ut(),m(o,t),m(A,s),Ge(),Ne()}async function he(){const e=await a("dashboard");Ft.textContent=String(e.metrics.entries_today),St.textContent=String(e.metrics.entries_this_week),Ye&&(Ye.textContent=at(e.metrics.average_rating_this_week))}async function w(t=1,n={}){const d=n.syncCreateDefault===!0,c=await a("entries",{params:Ot(t)});c.filters&&(e=$(c.filters),ie(e),c.filters.active===!0&&G?.hidden&&De(!0));const i=c.pagination;if(r=i.page,pe=i.total_pages,i.page===1&&Array.isArray(c.entries))if(c.entries.length>0){const e=c.entries[0];s={id:Number(e.medicine_id)||0,name:String(e.medicine_name||"")},d&&s.id>0&&(m(o,s),l(o,"existing"))}else s=null;if(lt(c.entries),Te){const t=Number(i.total_entries||0),n=Number(i.total_all_entries??i.total_entries??0),s=c.filters?.active===!0||te(e);s&&n>=t?Te.textContent=`Page ${i.page} of ${i.total_pages} | ${t} matching entries (${n} total)`:Te.textContent=`Page ${i.page} of ${i.total_pages} | ${t} total entries`,Ne(t,n)}ct()}function Dt(e){if(!v||!B||!e)return;if(!i){t("Read-only access: editing is disabled for this workspace.","error");return}je.value=String(e.id),ae.value=e.dosage_value||"20",re.value=e.dosage_unit||"mg",c&&f(c,L,e.rating||3),st.value=e.taken_at_input||P(),Be.value=e.notes||"",m(A,{id:Number(e.medicine_id)||0,name:e.medicine_name||""}),v.hidden=!1,fe()}function me(){if(!v||!B)return;v.hidden=!0,fe(),B.reset(),ae&&(ae.value="20"),re&&(re.value="mg"),c&&f(c,L,3),m(A)}function fe(){const e=Boolean(v&&!v.hidden),t=Boolean(j&&!j.hidden);Me.classList.toggle("modal-open",e||t)}function Rt(){if(!i){t("Read-only access: entry logging is disabled.","error");return}if(!j)return;j.hidden=!1,fe(),g&&!g.value&&(g.value=P())}function we(e=!1){if(!j)return;if(j.hidden=!0,fe(),!e||!d)return;d.reset(),g&&(g.value=P()),E&&(E.value="20"),M&&(M.value="mg"),u&&f(u,R,3),s&&s.id>0?(m(o,s),l(o,"existing")):(m(o),l(o,n.length>0?"existing":"new"))}function nt(e){const t=e.medicine_mode==="existing"&&e.medicine_id>0||e.medicine_mode==="new"&&e.medicine_name!=="";return t&&e.dosage_value!==""&&e.dosage_unit!==""&&e.rating!==""&&e.taken_at!==""}if(!Tt){Fe("Database unavailable.");return}Nt(),i||t("Read-only access enabled for this workspace."),Xe(o),Xe(A),ot(R,u),ot(L,c),m(o),m(A),g&&!g.value&&(g.value=P()),E&&!E.value&&(E.value="20"),M&&!M.value&&(M.value="mg"),u&&!u.value?f(u,R,3):f(u,R,u?.value||3),c&&!c.value?f(c,L,3):f(c,L,c?.value||3),e=$(e),ie(e),Ne(),De(te(e)),Ue(!1),D(),U||h("Push is not configured. Add VAPID keys in .env.","error"),oe?.addEventListener("click",()=>{const e=!!G&&!G.hidden;De(!e)}),X?.addEventListener("click",()=>{const e=!!ne&&!ne.hidden;Ue(!e)}),rt?.addEventListener("submit",async n=>{n.preventDefault(),e=He();try{await w(1)}catch(e){t(e.message,"error")}}),gt?.addEventListener("click",async()=>{e=$({}),ie(e);try{await w(1)}catch(e){t(e.message,"error")}}),_t?.addEventListener("click",async()=>{try{await Ve(7)}catch(e){t(e.message,"error")}}),xt?.addEventListener("click",async()=>{try{await Ve(30)}catch(e){t(e.message,"error")}}),it?.addEventListener("click",()=>{const t=He();e=t,ce("export_entries_csv",wt())}),Ct?.addEventListener("click",()=>{ce("export_entries_csv")}),Mt?.addEventListener("click",()=>{ce("backup_json")}),zt?.addEventListener("click",()=>{ce("backup_sql")}),vt?.addEventListener("click",()=>{Rt()}),S?.addEventListener("submit",async e=>{if(e.preventDefault(),!i){t("Read-only access: schedule updates are disabled.","error");return}const n={medicine_id:Number(y?.value||0),dosage_value:String(Ce?.value||"").trim(),dosage_unit:String(xe?.value||"").trim(),time_of_day:String(ee?.value||"").trim(),is_active:_e?.checked?1:0};if(!n.medicine_id||!n.dosage_value||!n.dosage_unit||!n.time_of_day){t("Please complete all schedule fields.","error");return}Ke(!0),k&&(k.textContent="Saving...");try{await a("schedule_create",{method:"POST",data:n}),t("Schedule added."),$e(),await de()}catch(e){t(e.message,"error")}finally{Ke(!1),k&&(k.textContent="Add Schedule")}}),x?.addEventListener("click",async e=>{if(!i)return;const n=e.target.closest("button[data-schedule-action]");if(!n)return;const s=Number(n.dataset.id||0);if(!s)return;if(n.dataset.scheduleAction==="delete"){const e=window.confirm("Delete this schedule?");if(!e)return;try{await a("schedule_delete",{method:"POST",data:{id:s}}),t("Schedule deleted."),await de()}catch(e){t(e.message,"error")}return}if(n.dataset.scheduleAction==="toggle"){const e=n.dataset.active==="1";try{await a("schedule_toggle",{method:"POST",data:{id:s,is_active:e?0:1}}),t(e?"Schedule paused.":"Schedule resumed."),await de()}catch(e){t(e.message,"error")}}}),J?.addEventListener("click",async()=>{try{await Et(),t("Push notifications enabled.")}catch(e){t(e.message,"error"),h(e.message,"error")}}),Q?.addEventListener("click",async()=>{try{await kt(),t("Push notifications disabled.")}catch(e){t(e.message,"error"),h(e.message,"error")}}),Z?.addEventListener("click",async()=>{try{const n=await a("push_test",{method:"POST"}),e=n.dispatch||{};t(`Test push sent: ${e.sent||0}/${e.attempted||0} delivered.`)}catch(e){t(e.message,"error")}}),H?.addEventListener("click",async()=>{if(!i){t("Read-only access: reminder checks are disabled.","error");return}const e=H;e&&(e.disabled=!0,e.textContent="Running...");try{const i=await a("process_reminders",{method:"POST"}),e=i.result||{},n=Number(e.due||0),s=Number(e.sent||0),r=Number(e.push_attempted||0),o=Number(e.push_failed||0),c=Number(e.push_deactivated||0),l=`Reminder check complete. Due: ${n}, sent: ${s}, attempted: ${r}, failed: ${o}, deactivated: ${c}.`;t(l,o>0||n>0&&s===0?"error":"success")}catch(e){t(e.message,"error")}finally{e&&(e.disabled=!1,e.textContent="Run Reminder Check")}}),d?.addEventListener("submit",async e=>{if(e.preventDefault(),!i){t("Read-only access: entry logging is disabled.","error");return}const c=Ae(o),r={...c,dosage_value:d.dosage_value.value.trim(),dosage_unit:d.dosage_unit.value.trim(),rating:u?u.value.trim():"",taken_at:d.taken_at.value.trim(),notes:d.notes.value.trim()};if(!nt(r)){t("Please complete all required fields.","error");return}et(d,!0),T&&(T.textContent="Saving...");try{await a("create",{method:"POST",data:r}),t("Entry saved."),d.reset(),g&&(g.value=P()),E&&(E.value="20"),M&&(M.value="mg"),u&&f(u,R,3),await Promise.all([ue(),he(),w(1)]),s&&s.id>0?(m(o,s),l(o,"existing")):l(o,n.length>0?"existing":"new"),we()}catch(e){t(e.message,"error")}finally{et(d,!1),T&&(T.textContent="Save Intake")}}),_?.addEventListener("click",e=>{if(!i)return;const n=e.target.closest("button[data-action='edit']");if(!n)return;const o=Number(n.dataset.id),s=Ee.get(o);if(!s){t("Could not load that entry.","error");return}Dt(s)}),B?.addEventListener("submit",async e=>{if(e.preventDefault(),!i){t("Read-only access: editing is disabled.","error");return}const s=Ae(A),n={id:Number(je.value),...s,dosage_value:ae.value.trim(),dosage_unit:re.value.trim(),rating:c?c.value.trim():"",taken_at:st.value.trim(),notes:Be.value.trim()};if(!n.id||!nt(n)){t("Please complete all required fields.","error");return}le(!0),C&&(C.textContent="Saving...");try{await a("update",{method:"POST",data:n}),me(),t("Entry updated."),await Promise.all([ue(),he(),w(r)])}catch(e){t(e.message,"error")}finally{le(!1),C&&(C.textContent="Save Changes")}}),F?.addEventListener("click",async()=>{if(!i){t("Read-only access: deleting is disabled.","error");return}const e=Number(je.value);if(!e){t("Missing entry ID for delete.","error");return}const n=window.confirm("Delete this entry permanently?");if(!n)return;le(!0),F.textContent="Deleting...";try{await a("delete",{method:"POST",data:{id:e}}),me(),t("Entry deleted."),await Promise.all([ue(),he(),w(r)])}catch(e){t(e.message,"error")}finally{le(!1),F.textContent="Delete Entry"}}),N?.addEventListener("click",async e=>{const n=e.target.closest("button[data-page]");if(!n||n.disabled)return;const s=Number(n.dataset.page);if(!s||s===r)return;try{await w(s)}catch(e){t(e.message,"error")}}),v?.addEventListener("click",e=>{const t=e.target.closest("[data-close-modal='true']");t&&me()}),j?.addEventListener("click",e=>{const t=e.target.closest("[data-close-create-modal='true']");t&&we(!0)}),document.addEventListener("keydown",e=>{if(e.key!=="Escape")return;if(j&&!j.hidden){we(!0);return}v&&!v.hidden&&me()}),Promise.all([ue(),he(),w(1)]).then(async()=>{if(s&&s.id>0&&(m(o,s),l(o,"existing")),Ht){$e();try{await de()}catch{Y&&(Y.textContent="Schedules unavailable. Run latest DB migrations."),x&&(x.innerHTML='<tr><td class="empty-cell" colspan="5">Schedules unavailable.</td></tr>')}await At()}}).catch(e=>{t(e.message,"error"),Fe("Could not load entries.")})})