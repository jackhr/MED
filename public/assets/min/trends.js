document.addEventListener("DOMContentLoaded",()=>{const he=window.MEDICINE_TRENDS_CONFIG||{},ye=he.apiPath||"index.php",ge=document.body,de=ge.dataset.dbReady==="1",w=document.getElementById("trends-status"),D=document.getElementById("trend-avg-week"),J=document.getElementById("trend-avg-90"),Q=document.getElementById("trend-entries-30"),X=document.getElementById("trend-active-days-30"),G=document.getElementById("trend-dose-gap-week"),Y=document.getElementById("trend-dose-gap-7d"),F=document.getElementById("trend-monthly-body"),M=document.getElementById("trend-weekly-body"),O=document.getElementById("trend-medicines-body"),A=document.getElementById("trend-weekday-body"),g=document.getElementById("trend-dose-order-body"),q=document.getElementById("chart-monthly-rating"),K=document.getElementById("chart-weekly-entries"),z=document.getElementById("chart-top-medicines"),W=document.getElementById("chart-weekday-pattern"),_=document.getElementById("chart-dose-order"),m=document.getElementById("chart-dose-order-meta"),V=document.getElementById("chart-dose-interval"),B=document.getElementById("chart-dose-interval-meta"),I=document.getElementById("chart-dose-interval-rolling"),C=document.getElementById("chart-dose-interval-rolling-meta"),u=document.getElementById("dose-view-controls"),s=document.getElementById("dose-order-controls"),n=document.getElementById("dose-medicine-controls");let c=null,f="single",h=null,o="all";const H=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];function oe(e){const t=e instanceof Date?e:new Date,n=t.getDay();return(n+6)%7}function N(){const t=oe(new Date),e=[];for(let n=6;n>=0;n-=1){const s=(t-n+7)%7;e.push({weekday_index:s,weekday_label:H[s]})}return e}function je(e){const t=new URL(ye,window.location.href);return t.searchParams.set("api",e),t.toString()}async function pe(e){const n=await fetch(je(e),{method:"GET",headers:{Accept:"application/json"}});let t=null;try{t=await n.json()}catch{throw new Error("Server returned an unreadable response.")}if(!n.ok||!t.ok){const e=t?.errors?.join(" ")||t?.error||"Request failed.";throw new Error(e)}return t}function P(e,t="success"){if(!w)return;w.hidden=!1,w.textContent=e,w.className=t==="error"?"alert alert-error":"alert alert-success"}function b(e){if(e==null||e==="")return"--";const t=Number(e);return Number.isFinite(t)?`${t.toFixed(2)} / 5`:"--"}function y(e){const t=Number(e);return Number.isFinite(t)?String(Math.round(t)):"0"}function d(e,t=!1){if(e==null||e==="")return"--";const o=Number(e);if(!Number.isFinite(o))return"--";const n=Math.round(o);if(n>1440)return t?"12 AM+":"12:00 AM (+1d)";if(n===1440)return t?"12AM":"12:00 AM";const i=Math.max(0,n),s=Math.floor(i/60),a=i%60,r=s>=12?"PM":"AM",c=s%12===0?12:s%12;return t&&a===0?`${c}${r}`:`${c}:${String(a).padStart(2,"0")} ${r}`}function l(e,t=!1){if(e==null||e==="")return"--";const o=Number(e);if(!Number.isFinite(o))return"--";const i=Math.max(0,Math.round(o)),n=Math.floor(i/60),s=i%60;return n<=0?`${s}m`:s===0?t?`${n}h`:`${n}h 0m`:`${n}h ${s}m`}function re(e){const t=Number(e);return Number.isFinite(t)?Math.abs(t-Math.round(t))<.001?String(Math.round(t)):t.toFixed(2).replace(/\.?0+$/,""):"--"}function t(e){const t=Number(e);return!Number.isInteger(t)||t<=0?null:t}function i(e){if(e==="all")return"all";const t=Number(e);return!Number.isInteger(t)||t<=0?null:t}function p(e){const n=t(e);if(n===null)return String(e);const s=n%100;if(s>=11&&s<=13)return`${n}th`;switch(n%10){case 1:return`${n}st`;case 2:return`${n}nd`;case 3:return`${n}rd`;default:return`${n}th`}}function e(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function r(e,t,n=3){if(!e)return;e.innerHTML="";const o=document.createElement("tr"),s=document.createElement("td");s.className="empty-cell",s.colSpan=n,s.textContent=t,o.appendChild(s),e.appendChild(o)}function v(e,t,n,s){if(!e)return;if(e.innerHTML="",!Array.isArray(t)||t.length===0){r(e,"No data yet.",n);return}t.forEach(t=>{const n=document.createElement("tr"),o=s(t);o.forEach(e=>{const t=document.createElement("td");t.textContent=String(e),n.appendChild(t)}),e.appendChild(n)})}function a(t,n){if(!t)return;t.innerHTML=`<p class="chart-empty">${e(n)}</p>`}function S(e,t=280){const n=700;if(!e)return{width:n,height:t};const o=e.getBoundingClientRect(),s=Math.round(o.width||e.clientWidth||0),i=Math.max(280,s>0?s:n);return{width:i,height:t}}function Z(e,t,n,s,o){const r=Math.max(1,Number(t)||1);let i=Number(n),a="middle";return e===0?(a="start",i=Math.max(s+2,i)):e===r-1&&(a="end",i=Math.min(o-2,i)),{x:i,anchor:a}}function E(t,n,s={}){if(!t)return;const i=n.filter(e=>Number.isFinite(e.value));if(i.length===0){a(t,"No chart data yet.");return}const O=S(t,280),r=O.width,l=O.height,o={top:22,right:16,bottom:48,left:48},g=r-o.left-o.right,p=l-o.top-o.bottom,f=i.map(e=>e.value);let c=Number.isFinite(s.yMin)?s.yMin:Math.min(...f),d=Number.isFinite(s.yMax)?s.yMax:Math.max(...f);s.startAtZero&&(c=Math.min(0,c)),c===d&&(d=c+1);const m=e=>i.length===1?o.left+g/2:o.left+e/(i.length-1)*g,h=e=>o.top+(d-e)/(d-c)*p,v=4,b=[],j=[];for(let t=0;t<=v;t+=1){const n=d-(d-c)*t/v,i=h(n),a=typeof s.tickFormatter=="function"?s.tickFormatter(n):n.toFixed(1);b.push(`<line class="chart-grid-line" x1="${o.left}" y1="${i.toFixed(2)}" x2="${r-o.right}" y2="${i.toFixed(2)}"></line>`),j.push(`<text class="chart-axis-label" x="${o.left-8}" y="${(i+4).toFixed(2)}" text-anchor="end">${e(a)}</text>`)}const C=i.map((e,t)=>{const n=t===0?"M":"L";return`${n}${m(t).toFixed(2)} ${h(e.value).toFixed(2)}`}).join(" "),y=[],_=[],w=[],u=i.map((e,t)=>m(t)),E=i.length>8?Math.ceil(i.length/6):1;if(i.forEach((t,n)=>{const a=u[n],c=h(t.value),d=typeof s.valueFormatter=="function"?s.valueFormatter(t.value):String(t.value),m=typeof s.tooltipFormatter=="function"?String(s.tooltipFormatter(t,d)):`${t.label}: ${d}`,f=encodeURIComponent(m);if(_.push(`<circle class="chart-point" cx="${a.toFixed(2)}" cy="${c.toFixed(2)}" r="3.8" data-tooltip="${f}" data-tooltip-anchor-x="${a.toFixed(2)}" data-tooltip-anchor-y="${c.toFixed(2)}"><title>${e(m)}</title></circle>`),s.enableHoverTooltip===!0&&s.hoverMode==="x"){const t=n>0?u[n-1]:o.left,s=n<i.length-1?u[n+1]:r-o.right,e=n===0?o.left:(t+a)/2,l=n===i.length-1?r-o.right:(a+s)/2,d=Math.max(1,l-e);w.push(`<rect class="chart-line-hover-zone" x="${e.toFixed(2)}" y="${o.top.toFixed(2)}" width="${d.toFixed(2)}" height="${p.toFixed(2)}" fill="transparent" data-tooltip="${f}" data-tooltip-anchor-x="${a.toFixed(2)}" data-tooltip-anchor-y="${c.toFixed(2)}"></rect>`)}if(n%E===0||n===i.length-1){const d=typeof s.labelFormatter=="function"?s.labelFormatter(t.label):String(t.label),c=Z(n,i.length,a,o.left,r-o.right);y.push(`<text class="chart-axis-label" x="${c.x.toFixed(2)}" y="${l-o.bottom+18}" text-anchor="${c.anchor}">${e(d)}</text>`)}}),t.innerHTML=`
      <svg class="chart-svg" viewBox="0 0 ${r} ${l}" role="img" aria-label="${e(s.ariaLabel||"Line chart")}">
        <line class="chart-axis-line" x1="${o.left}" y1="${o.top}" x2="${o.left}" y2="${l-o.bottom}"></line>
        <line class="chart-axis-line" x1="${o.left}" y1="${l-o.bottom}" x2="${r-o.right}" y2="${l-o.bottom}"></line>
        ${b.join("")}
        ${j.join("")}
        <path class="chart-line" d="${C}"></path>
        ${_.join("")}
        ${w.join("")}
        ${y.join("")}
      </svg>
    `,s.enableHoverTooltip===!0){const e=s.hoverMode==="x"?".chart-line-hover-zone[data-tooltip]":".chart-point[data-tooltip]";x(t,e)}}function x(e,t){if(!e)return;const s=e.querySelectorAll(t);if(s.length===0)return;const n=document.createElement("div");n.className="chart-tooltip",n.hidden=!0,e.appendChild(n);const o=(t,s,o=!1)=>{const i=e.getBoundingClientRect(),a=n.offsetWidth,r=n.offsetHeight,c=o?t-i.left-a/2:t-i.left+12,l=s-i.top-r-10,d=Math.min(Math.max(8,c),Math.max(8,i.width-a-8)),u=Math.min(Math.max(8,l),Math.max(8,i.height-r-8));n.style.left=`${d}px`,n.style.top=`${u}px`},i=(t,n,s)=>{const r=Number(t.getAttribute("data-tooltip-anchor-x")),c=Number(t.getAttribute("data-tooltip-anchor-y"));if(!Number.isFinite(r)||!Number.isFinite(c))return{clientX:n,clientY:s,anchored:!1};const i=t.ownerSVGElement||e.querySelector("svg");if(!i)return{clientX:n,clientY:s,anchored:!1};const o=i.viewBox&&i.viewBox.baseVal?i.viewBox.baseVal:null;if(!o||o.width<=0||o.height<=0)return{clientX:n,clientY:s,anchored:!1};const a=i.getBoundingClientRect(),l=(r-o.x)/o.width,d=(c-o.y)/o.height;return{clientX:a.left+l*a.width,clientY:a.top+d*a.height,anchored:!0}},a=()=>{n.hidden=!0};s.forEach(e=>{e.addEventListener("mouseenter",t=>{const c=e.getAttribute("data-tooltip")||"";let s="";try{s=decodeURIComponent(c)}catch{s=""}if(s===""){a();return}n.textContent=s,n.hidden=!1;const r=i(e,t.clientX,t.clientY);o(r.clientX,r.clientY,r.anchored)}),e.addEventListener("mousemove",t=>{if(n.hidden)return;const s=i(e,t.clientX,t.clientY);o(s.clientX,s.clientY,s.anchored)}),e.addEventListener("mouseleave",a)})}function k(t,n,s={}){if(!t)return;const j=Array.isArray(n)?n:[],h=j.filter(e=>Number.isFinite(e.value)),r=s.keepAllPoints===!0?j:h;if(r.length===0||h.length===0){a(t,"No chart data yet.");return}const b=S(t,280),c=b.width,d=b.height,o={top:22,right:16,bottom:52,left:44},k=c-o.left-o.right,m=d-o.top-o.bottom,M=h.map(e=>e.value),p=Math.max(1,Number.isFinite(s.yMax)?s.yMax:Math.max(...M)),A=s.integerTicks===!0,u=4,l=[];let i=p;if(A){const e=Math.max(1,Math.ceil(p/u));i=Math.max(e,Math.ceil(p/e)*e);for(let t=i;t>=0;t-=e)l.push(t);l[l.length-1]!==0&&l.push(0)}else for(let e=0;e<=u;e+=1)l.push(i-i*e/u);const y=e=>o.top+(i-e)/i*m,_=[],w=[];l.forEach(t=>{const n=y(t),i=typeof s.tickFormatter=="function"?s.tickFormatter(t):String(Math.round(t));_.push(`<line class="chart-grid-line" x1="${o.left}" y1="${n.toFixed(2)}" x2="${c-o.right}" y2="${n.toFixed(2)}"></line>`),w.push(`<text class="chart-axis-label" x="${o.left-8}" y="${(n+4).toFixed(2)}" text-anchor="end">${e(i)}</text>`)});let O="",v="";if(Number.isFinite(s.referenceLineValue)){const t=Number(s.referenceLineValue),l=Math.max(0,Math.min(i,t)),n=y(l),a=s.referenceLineLabel||"Average",r=typeof s.referenceValueFormatter=="function"?s.referenceValueFormatter(t):String(t),d=Math.max(o.top+12,n-6);O=`<line class="chart-reference-line" x1="${o.left}" y1="${n.toFixed(2)}" x2="${c-o.right}" y2="${n.toFixed(2)}"><title>${e(`${a}: ${r}`)}</title></line>`,v=`<text class="chart-reference-label" x="${(c-o.right-4).toFixed(2)}" y="${d.toFixed(2)}" text-anchor="end">${e(`${a}: ${r}`)}</text>`}const C=[],E=[],g=k/r.length,f=Math.max(10,g*.64),F=r.length>10?Math.ceil(r.length/8):1;r.forEach((t,n)=>{const a=o.left+n*g+(g-f)/2,l=Number.isFinite(t.value),u=l?Math.max(0,t.value)/i*m:0,h=o.top+m-u,p=typeof s.valueFormatter=="function"?s.valueFormatter(t.value):String(t.value);if(l){const e=`${t.label}: ${p}`,n=encodeURIComponent(e);C.push(`<rect class="chart-bar" x="${a.toFixed(2)}" y="${h.toFixed(2)}" width="${f.toFixed(2)}" height="${u.toFixed(2)}" data-tooltip="${n}"></rect>`)}if(n%F===0||n===r.length-1){const l=typeof s.labelFormatter=="function"?s.labelFormatter(t.label):String(t.label),u=a+f/2,i=Z(n,r.length,u,o.left,c-o.right);E.push(`<text class="chart-axis-label" x="${i.x.toFixed(2)}" y="${d-o.bottom+18}" text-anchor="${i.anchor}">${e(l)}</text>`)}}),t.innerHTML=`
      <svg class="chart-svg" viewBox="0 0 ${c} ${d}" role="img" aria-label="${e(s.ariaLabel||"Bar chart")}">
        <line class="chart-axis-line" x1="${o.left}" y1="${o.top}" x2="${o.left}" y2="${d-o.bottom}"></line>
        <line class="chart-axis-line" x1="${o.left}" y1="${d-o.bottom}" x2="${c-o.right}" y2="${d-o.bottom}"></line>
        ${_.join("")}
        ${w.join("")}
        ${C.join("")}
        ${O}
        ${v}
        ${E.join("")}
      </svg>
    `,s.enableHoverTooltip===!0&&x(t,".chart-bar[data-tooltip]")}function ue(t,n){if(!t)return;const s=n.filter(e=>Number.isFinite(e.value));if(s.length===0){a(t,"No chart data yet.");return}const o=Math.max(...s.map(e=>e.value),1),i=s.map(t=>{const n=Math.max(0,t.value)/o*100;return`
        <div class="bar-row">
          <div class="bar-meta">
            <span class="bar-label">${e(t.label)}</span>
            <span class="bar-value">${e(y(t.value))}</span>
          </div>
          <div class="bar-track" aria-hidden="true">
            <span class="bar-fill" style="width: ${n.toFixed(2)}%"></span>
          </div>
        </div>
      `});t.innerHTML=`<div class="bar-list">${i.join("")}</div>`}function te(e){a(q,e),a(K,e),a(z,e),a(W,e),a(_,e),a(V,e),a(I,e)}function ee(e,n,s){const r=N(),o=new Map,a=i(s),c=a===null?"all":a;return e.forEach(e=>{const d=t(e.dose_order),r=e.medicine_id===null||e.medicine_id===0[0]||e.medicine_id===""?"all":i(e.medicine_id),s=Number(e.weekday_index);if(d!==n||r===null||r!==c||!Number.isInteger(s)||s<0||s>6)return;const l=Number(e.avg_minute_of_day),a=Number(e.samples);o.set(s,{weekday_index:s,weekday_label:H[s],avg_minute_of_day:Number.isFinite(l)?l:null,samples:Number.isFinite(a)&&a>0?Math.round(a):0})}),r.map(e=>o.has(e.weekday_index)?o.get(e.weekday_index):{weekday_index:e.weekday_index,weekday_label:e.weekday_label,avg_minute_of_day:null,samples:0})}function U(e,n,s){const a=i(s),r=a===null?"all":a,c=new Set((Array.isArray(n)?n:[]).map(e=>t(e)).filter(e=>e!==null)),o=new Map;return(Array.isArray(e)?e:[]).forEach(e=>{const n=t(e.dose_order),a=e.medicine_id===null||e.medicine_id===0[0]||e.medicine_id===""?"all":i(e.medicine_id),l=String(e.dosage_unit||"").trim(),d=Number(e.avg_dosage_value),s=Number(e.samples);if(n===null||!c.has(n)||a===null||a!==r||l===""||!Number.isFinite(d)||!Number.isFinite(s)||s<=0)return;o.has(n)||o.set(n,[]),o.get(n).push({dosage_unit:l,avg_dosage_value:d,samples:Math.round(s)})}),(Array.isArray(n)?n:[]).map(e=>{const n=t(e),s=n!==null&&o.has(n)?o.get(n):[],i=s.map(e=>`${re(e.avg_dosage_value)} ${String(e.dosage_unit||"").trim()}`).filter(e=>e!=="").join(" / "),a=s.reduce((e,t)=>e+Math.max(0,Number(t.samples)||0),0);return{dose_order:n,dosage_text:i===""?"--":i,samples:a}})}function ae(e,n,s){const r=N(),c=new Set((Array.isArray(n)?n:[]).map(e=>t(e)).filter(e=>e!==null)),o=new Map,a=i(s),l=a===null?"all":a;return e.forEach(e=>{const s=t(e.dose_order),r=e.medicine_id===null||e.medicine_id===0[0]||e.medicine_id===""?"all":i(e.medicine_id),n=Number(e.weekday_index);if(s===null||!c.has(s)||r===null||r!==l||!Number.isInteger(n)||n<0||n>6)return;const d=Number(e.avg_minute_of_day),a=Number(e.samples),u={dose_order:s,avg_minute_of_day:Number.isFinite(d)?d:null,samples:Number.isFinite(a)&&a>0?Math.round(a):0};o.has(n)||o.set(n,new Map),o.get(n).set(s,u)}),r.map(e=>{const s=o.get(e.weekday_index)||new Map,i=(Array.isArray(n)?n:[]).map(e=>{const n=t(e),o=n!==null?s.get(n):null;return o||{dose_order:n,avg_minute_of_day:null,samples:0}});return{weekday_index:e.weekday_index,weekday_label:e.weekday_label,doses:i}})}function $(e){let n=0,t=0;return e.forEach(e=>{const o=Number(e.avg_minute_of_day),s=Number(e.samples);Number.isFinite(o)&&Number.isFinite(s)&&s>0&&(n+=o*s,t+=s)}),t>0?n/t:null}function ce(e,n,s){const o=new Map;Array.isArray(n)&&n.forEach(e=>{const t=i(e?.id),n=String(e?.name||"").trim();t!==null&&t!=="all"&&n!==""&&o.set(t,n)});const a=new Map;return e.forEach(e=>{const l=t(e.dose_order),n=i(e.medicine_id),r=Number(e.samples);if(l!==s||n===null||n==="all"||!Number.isFinite(r)||r<=0)return;const c=String(e.medicine_name||"").trim();a.set(n,c!==""?c:o.get(n)||`Medicine ${n}`)}),Array.from(a.entries()).map(([e,t])=>({id:e,name:t})).sort((e,t)=>e.name.localeCompare(t.name))}function le(e,n,s){const o=new Map;Array.isArray(n)&&n.forEach(e=>{const t=i(e?.id),n=String(e?.name||"").trim();t!==null&&t!=="all"&&n!==""&&o.set(t,n)});const r=new Set((Array.isArray(s)?s:[]).map(e=>t(e)).filter(e=>e!==null)),a=new Map;return e.forEach(e=>{const s=t(e.dose_order),n=i(e.medicine_id),c=Number(e.samples);if(s===null||!r.has(s)||n===null||n==="all"||!Number.isFinite(c)||c<=0)return;const l=String(e.medicine_name||"").trim();a.set(n,l!==""?l:o.get(n)||`Medicine ${n}`)}),Array.from(a.entries()).map(([e,t])=>({id:e,name:t})).sort((e,t)=>e.name.localeCompare(t.name))}function ne(){if(!u)return;const e=[{id:"single",label:"Single dose"},{id:"combined",label:"Combined day"}];u.innerHTML="",e.forEach(e=>{const t=document.createElement("button");t.type="button",t.className="ghost-btn dose-order-btn",t.textContent=e.label,f===e.id&&t.classList.add("is-active"),t.addEventListener("click",()=>{if(f===e.id)return;f=e.id,c&&j(c)}),u.appendChild(t)})}function ie(e,t){const o=Math.max(0,Number(e)||0),n=Math.max(1,Number(t)||1),s=n<=1?0:Math.max(0,Math.min(1,o/(n-1))),i=45-s*20,a=.96-s*.24;return`hsla(172, 72%, ${i.toFixed(1)}%, ${a.toFixed(3)})`}function se(e,t){const s=Math.max(0,Number(e)||0),n=Math.max(1,Number(t)||1),o=n<=1?0:Math.max(0,Math.min(1,s/(n-1))),i=59-o*14;return`hsla(33, 90%, ${i.toFixed(1)}%, 1)`}function me(n,s,o,i){if(!n)return;const m=Array.isArray(s)?s:[],f=Array.isArray(o)?o:[],M=m.some(e=>!!Array.isArray(e.doses)&&e.doses.some(e=>Number.isFinite(Number(e.avg_minute_of_day))&&Number(e.samples)>0));if(m.length===0||f.length===0||!M){a(n,"No chart data yet.");return}const j=S(n,280),c=j.width,l=j.height,r={top:22,right:16,bottom:52,left:44},E=c-r.left-r.right,g=l-r.top-r.bottom,u=24,k=[24,18,12,6,0],b=e=>r.top+(u-e)/u*g,A=Array.isArray(i?.referenceLines)?i.referenceLines.map(e=>({value:Number(e?.value),label:String(e?.label||"Average"),color:String(e?.color||"#f5a23a")})).filter(e=>Number.isFinite(e.value)):[],v=[],y=[];k.forEach(t=>{const n=b(t);v.push(`<line class="chart-grid-line" x1="${r.left}" y1="${n.toFixed(2)}" x2="${c-r.right}" y2="${n.toFixed(2)}"></line>`),y.push(`<text class="chart-axis-label" x="${r.left-8}" y="${(n+4).toFixed(2)}" text-anchor="end">${e(d(t*60,!0))}</text>`)});const h=E/m.length,_=[],w=[],O=[],C=[],F=[...f].sort((e,t)=>t-e);A.forEach((t,n)=>{const s=Math.max(0,Math.min(u,t.value)),o=b(s),i=d(s*60);O.push(`<line class="chart-reference-line chart-dose-reference-line" x1="${r.left}" y1="${o.toFixed(2)}" x2="${c-r.right}" y2="${o.toFixed(2)}" style="stroke:${e(t.color)}"><title>${e(`${t.label}: ${i}`)}</title></line>`),C.push(`<text class="chart-reference-label chart-dose-reference-label" x="${(c-r.right-4).toFixed(2)}" y="${(r.top+12+n*12).toFixed(2)}" text-anchor="end" style="fill:${e(t.color)}">${e(`${t.label}: ${i}`)}</text>`)}),m.forEach((n,s)=>{const o=r.left+s*h+h/2,i=new Map((Array.isArray(n.doses)?n.doses:[]).map(e=>[t(e.dose_order),e]));F.forEach(e=>{const s=t(e);if(s===null)return;const l=f.indexOf(s),a=i.get(s);if(!a)return;const c=Number(a.avg_minute_of_day),m=Number(a.samples);if(!Number.isFinite(c)||!Number.isFinite(m)||m<=0)return;const j=Math.max(0,Math.min(u,c/60)),v=j/u*g,y=r.top+g-v,w=.46+l*.08,b=Math.max(12,Math.min(h*.84,h*w)),O=o-b/2,x=`${n.weekday_label} ${p(s)} dose: ${d(c)}`;_.push(`<rect class="chart-bar chart-dose-layer" x="${O.toFixed(2)}" y="${y.toFixed(2)}" width="${b.toFixed(2)}" height="${v.toFixed(2)}" style="fill:${ie(l,f.length)}" data-tooltip="${encodeURIComponent(x)}"></rect>`)}),w.push(`<text class="chart-axis-label" x="${o.toFixed(2)}" y="${l-r.bottom+18}" text-anchor="middle">${e(n.weekday_label)}</text>`)}),n.innerHTML=`
      <svg class="chart-svg" viewBox="0 0 ${c} ${l}" role="img" aria-label="${e(i?.ariaLabel||"Combined dose time highlights")}">
        <line class="chart-axis-line" x1="${r.left}" y1="${r.top}" x2="${r.left}" y2="${l-r.bottom}"></line>
        <line class="chart-axis-line" x1="${r.left}" y1="${l-r.bottom}" x2="${c-r.right}" y2="${l-r.bottom}"></line>
        ${v.join("")}
        ${y.join("")}
        ${_.join("")}
        ${C.join("")}
        ${w.join("")}
        ${O.join("")}
      </svg>
    `,x(n,".chart-dose-layer[data-tooltip]")}function fe(e){if(!s)return;s.innerHTML="",e.forEach(e=>{const t=document.createElement("button");t.type="button",t.className="ghost-btn dose-order-btn",t.textContent=`${p(e)} dose`,e===h&&t.classList.add("is-active"),t.addEventListener("click",()=>{if(h===e)return;h=e,c&&j(c)}),s.appendChild(t)})}function R(e){if(!n)return;if(!Array.isArray(e)||e.length<=1){n.hidden=!0,n.innerHTML="";return}n.hidden=!1,n.innerHTML="";const t=document.createElement("button");t.type="button",t.className="ghost-btn dose-order-btn",t.textContent="All medicines",o==="all"&&t.classList.add("is-active"),t.addEventListener("click",()=>{if(o==="all")return;o="all",c&&j(c)}),n.appendChild(t),e.forEach(e=>{const t=i(e.id);if(t===null||t==="all")return;const s=document.createElement("button");s.type="button",s.className="ghost-btn dose-order-btn",s.textContent=String(e.name||`Medicine ${t}`),o===t&&s.classList.add("is-active"),s.addEventListener("click",()=>{if(o===t)return;o=t,c&&j(c)}),n.appendChild(s)})}function j(e){const l=e?.dose_weekday_patterns_7_days||e?.dose_weekday_patterns_90_days||{},j=Array.isArray(l.rows)?l.rows:[],T=Array.isArray(l.dosage_averages)?l.dosage_averages:[],A=Array.isArray(l.available_medicines)?l.available_medicines:[];let c=Array.isArray(l.available_orders)?l.available_orders.map(e=>t(e)).filter(e=>e!==null):[];if(f!=="single"&&f!=="combined"&&(f="single"),c.length===0&&(c=Array.from(new Set(j.map(e=>t(e.dose_order)).filter(e=>e!==null)))),c.sort((e,t)=>e-t),c.length===0){o="all",u&&(u.innerHTML=""),s&&(s.hidden=f!=="single",s.innerHTML=""),n&&(n.hidden=!0,n.innerHTML=""),m&&(m.textContent="No dose-order timing data yet for the last 7 days."),r(g,"No data yet."),a(_,"No chart data yet.");return}ne();const z=f==="combined";if(z){s&&(s.hidden=!0);const n=le(j,A,c),h=i(o);n.length<=1||h===null?o="all":h!=="all"&&!n.some(e=>e.id===h)&&(o="all"),R(n);const l=n.length>1?i(o)||"all":"all",x=n.find(e=>e.id===l),b=l==="all"?n.length===1?n[0].name:"All medicines":x?.name||"All medicines",u=ae(j,c,l),e=c.filter(e=>u.some(n=>(Array.isArray(n.doses)?n.doses:[]).some(n=>t(n.dose_order)===e&&Number.isFinite(Number(n.avg_minute_of_day))&&Number(n.samples)>0)));if(e.length===0){m&&(m.textContent="No combined dose timing data yet for the last 7 days."),r(g,"No data yet."),a(_,"No chart data yet.");return}const y=e.map(e=>{const t=ee(j,e,l),n=$(t);return{doseOrder:e,averageMinute:n}}).filter(e=>e.averageMinute!==null),O=U(T,e,l),f=y.map(e=>`${p(e.doseOrder)}: ${d(e.averageMinute)}`).join(" | "),w=O.filter(e=>e.dose_order!==null&&e.samples>0&&String(e.dosage_text||"").trim()!=="--").map(e=>`${p(e.dose_order)}: ${String(e.dosage_text||"--")}`).join(" | "),C=f===""?"No average-time samples yet.":f,E=w===""?"No dosage averages yet.":w;m&&(m.textContent=`Combined timing for ${b} over the last 7 days. Avg times: ${C}. Avg dosages: ${E}`),v(g,u,3,n=>{const s=e.map(e=>{const s=(Array.isArray(n.doses)?n.doses:[]).find(n=>t(n.dose_order)===e);return!s||!Number.isFinite(Number(s.avg_minute_of_day))||Number(s.samples)<=0?null:`${p(e)}: ${d(s.avg_minute_of_day)}`}).filter(e=>e!==null),o=(Array.isArray(n.doses)?n.doses:[]).reduce((n,s)=>{const o=t(s.dose_order);return o===null||!e.includes(o)?n:n+Math.max(0,Number(s.samples)||0)},0);return[n.weekday_label,s.length>0?s.join(" | "):"--",o]}),me(_,u,e,{ariaLabel:`Combined dose times by weekday for ${b}`,referenceLines:y.map(t=>{const n=e.indexOf(t.doseOrder),s=Number(t.averageMinute)/60;return{value:s,label:`${p(t.doseOrder)} Avg`,color:se(n,e.length)}})});return}s&&(s.hidden=!1),c.includes(h)||(h=c[0]),fe(c);const b=ce(j,A,h),E=i(o);b.length<=1||E===null?o="all":E!=="all"&&!b.some(e=>e.id===E)&&(o="all"),R(b);const x=b.length>1?i(o)||"all":"all",P=b.find(e=>e.id===x),S=x==="all"?b.length===1?b[0].name:"All medicines":P?.name||"All medicines",w=ee(j,h,x),y=`${p(h)} dose`,C=$(w),N=C===null?null:C/60,D=w.reduce((e,t)=>e+Math.max(0,Number(t.samples)||0),0),F=U(T,c,x),O=F.find(e=>e.dose_order===h),L=O&&O.samples>0&&String(O.dosage_text||"").trim()!==""?String(O.dosage_text):"--",M=F.filter(e=>e.dose_order!==null&&e.samples>0&&String(e.dosage_text||"").trim()!=="--").map(e=>`${p(e.dose_order)}: ${String(e.dosage_text||"--")}`).join(" | "),H=M===""?"No dosage averages yet.":M;m&&(m.textContent=`${y} average time by day for ${S} over the last 7 days. ${y} overall average: ${d(C)} (${D} samples). ${y} avg dosage: ${L}. All dose avg dosages: ${H}`),v(g,w,3,e=>[e.weekday_label,e.samples>0?d(e.avg_minute_of_day):"--",e.samples]);const I=w.map(e=>({label:e.weekday_label,value:e.samples>0&&Number.isFinite(Number(e.avg_minute_of_day))?Number(e.avg_minute_of_day)/60:Number.NaN}));k(_,I,{ariaLabel:`${y} average time by day for ${S}`,yMax:24,integerTicks:!0,keepAllPoints:!0,enableHoverTooltip:!0,tickFormatter:e=>d(e*60,!0),valueFormatter:e=>d(e*60),labelFormatter:e=>e,referenceLineValue:N,referenceLineLabel:`${y} Avg`,referenceValueFormatter:e=>d(e*60)})}function ve(e){const p=Array.isArray(e?.dose_interval_weekly_12_weeks)?e.dose_interval_weekly_12_weeks:[],t=e?.summary||{},u=Number(t.avg_dose_interval_this_week_minutes),n=Number.isFinite(u)?u:null,c=Number(t.dose_interval_this_week_samples),a=Number.isFinite(c)&&c>0?Math.round(c):0,m=Number(t.avg_dose_interval_last_7_days_minutes),s=Number.isFinite(m)?m:null,o=Number(t.dose_interval_last_7_days_samples),i=Number.isFinite(o)&&o>0?Math.round(o):0,d=Number(t.avg_dose_interval_last_90_days_minutes),h=Number.isFinite(d)?d:null,r=Number(t.dose_interval_last_90_days_samples),f=Number.isFinite(r)&&r>0?Math.round(r):0;G&&(G.textContent=n!==null&&a>0?l(n):"--"),Y&&(Y.textContent=s!==null&&i>0?l(s):"--");const g=n!==null&&a>0?`This week average gap: ${l(n)} (${a} gaps).`:"No dose-gap samples this week yet.",v=s!==null&&i>0?`Rolling 7-day average gap: ${l(s)} (${i} gaps).`:"No rolling 7-day dose-gap samples yet.",b=h!==null&&f>0?`Last 90-day average gap: ${l(h)} (${f} gaps).`:"No dose-gap data in the last 90 days.";B&&(B.textContent=`Average time between consecutive doses by week over the last 12 weeks. ${g} ${v} ${b}`);const j=p.map(e=>({label:String(e.label||"-").replace(/^Week of\s+/i,""),value:Number.isFinite(Number(e.avg_interval_minutes))&&Number(e.avg_interval_minutes)>=0?Number(e.avg_interval_minutes)/60:Number.NaN})).filter(e=>Number.isFinite(e.value));E(V,j,{yMin:0,ariaLabel:"Average time between doses by week",tickFormatter:e=>l(e*60,!0),valueFormatter:e=>l(e*60),labelFormatter:e=>e})}function be(e){const i=Array.isArray(e?.dose_interval_rolling_7_days_30_days)?e.dose_interval_rolling_7_days_30_days:[],n=[...i].reverse().find(e=>Number(e.intake_count)>=2&&Number(e.day_gap_samples)>0&&Number.isFinite(Number(e.day_avg_interval_minutes)));C&&(n&&Number.isFinite(Number(n.day_avg_interval_minutes))?C.textContent=`Daily dose gap over the last 30 days. Latest day (${n.label||n.date||"today"}): ${l(Number(n.day_avg_interval_minutes))}.`:C.textContent="Daily dose gap over the last 30 days. No same-day gaps yet.");const a=i.map(e=>{const t=Number(e.intake_count),n=Number(e.day_avg_interval_minutes),s=Number(e.day_gap_samples),o=Number.isFinite(s)&&s>0&&Number.isFinite(n)&&n>=0;return{label:String(e.date||e.label||"-"),intake_count:Number.isFinite(t)?t:0,day_avg_interval_minutes:o?n:null,day_gap_samples:Number.isFinite(s)?s:0,value:Number.isFinite(t)&&t>=2&&o?n/60:0}}),o=a.map(e=>e.value).filter(e=>Number.isFinite(e)),r=o.length>0,s=r?Math.min(...o):null,t=r?Math.max(...o):null,c=s!==null&&t!==null?t-s:0,d=s!==null&&t!==null?Math.max(.15,c>0?c*.12:t*.12):0,h=s!==null?Math.max(0,s-d):0,u=t!==null?t+d:0[0];E(I,a,{yMin:h,...Number.isFinite(u)?{yMax:u}:{},ariaLabel:"Daily dose gap by day",enableHoverTooltip:!0,hoverMode:"x",tickFormatter:e=>l(e*60,!0),valueFormatter:e=>l(e*60),tooltipFormatter:e=>{const t=Number(e.day_avg_interval_minutes),n=Number(e.intake_count||0);return Number.isFinite(t)&&t>=0&&n>=2?`${e.label}: ${l(t)}`:`${e.label}: 0m (fewer than 2 intakes)`},labelFormatter:e=>{if(/^\d{4}-\d{2}-\d{2}$/.test(e)){const t=e.slice(5);return t.replace("-","/")}return e}})}function L(e){const n=Array.isArray(e.monthly_average_rating)?e.monthly_average_rating:[],s=Array.isArray(e.weekly_entries)?e.weekly_entries:[],o=Array.isArray(e.top_medicines_90_days)?e.top_medicines_90_days:[],i=Array.isArray(e.weekday_patterns_90_days)?e.weekday_patterns_90_days:[],t=e.summary||{};if(D&&(D.textContent=b(t.avg_rating_this_week)),J&&(J.textContent=b(t.avg_rating_last_90_days)),Q&&(Q.textContent=String(t.entries_last_30_days??0)),X){const e=Number(t.active_days_last_30_days??0),n=Number(t.active_day_ratio_last_30_days??0);X.textContent=`${e} (${n.toFixed(1)}%)`}v(F,n,3,e=>[e.label||"-",b(e.avg_rating),e.entries??0]),v(M,s,3,e=>[e.label||"-",e.entries??0,b(e.avg_rating)]),v(O,o,3,e=>[e.medicine_name||"-",e.entries??0,b(e.avg_rating)]),v(A,i,3,e=>[e.label||"-",e.entries??0,b(e.avg_rating)]);const r=n.map(e=>({label:e.label||"-",value:Number(e.avg_rating)})).filter(e=>Number.isFinite(e.value));E(q,r,{yMin:0,yMax:5,ariaLabel:"Monthly average rating trend",tickFormatter:e=>e.toFixed(1),valueFormatter:e=>`${e.toFixed(2)} / 5`,labelFormatter:e=>e});const c=s.map(e=>({label:String(e.label||"-").replace(/^Week of\s+/i,""),value:Number(e.entries)})).filter(e=>Number.isFinite(e.value));k(K,c,{ariaLabel:"Weekly intake entries trend",integerTicks:!0,tickFormatter:e=>y(e),valueFormatter:e=>`${y(e)} entries`,labelFormatter:e=>e});const l=o.map(e=>({label:e.medicine_name||"-",value:Number(e.entries)})).filter(e=>Number.isFinite(e.value));ue(z,l);const d=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],a=new Map(i.map(e=>[String(e.label||""),Number(e.entries)])),u=d.map(e=>({label:e,value:Number.isFinite(a.get(e))?Number(a.get(e)):0}));k(W,u,{ariaLabel:"Weekday intake entry pattern",integerTicks:!0,tickFormatter:e=>y(e),valueFormatter:e=>`${y(e)} entries`,labelFormatter:e=>e}),j(e),ve(e),be(e)}if(!de){P("Database unavailable.","error"),r(F,"Database unavailable."),r(M,"Database unavailable."),r(O,"Database unavailable."),r(A,"Database unavailable."),r(g,"Database unavailable."),u&&(u.innerHTML=""),s&&(s.hidden=!0,s.innerHTML=""),n&&(n.hidden=!0,n.innerHTML=""),te("Database unavailable.");return}pe("trends").then(e=>{c=e.trends||{},L(c)}).catch(e=>{c=null,P(e.message,"error"),r(F,"Could not load trends."),r(M,"Could not load trends."),r(O,"Could not load trends."),r(A,"Could not load trends."),r(g,"Could not load trends."),u&&(u.innerHTML=""),s&&(s.hidden=!0,s.innerHTML=""),n&&(n.hidden=!0,n.innerHTML=""),te("Could not load charts.")});let T=null;window.addEventListener("resize",()=>{if(!c)return;T&&window.clearTimeout(T),T=window.setTimeout(()=>{L(c)},120)})})