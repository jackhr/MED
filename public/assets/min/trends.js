document.addEventListener("DOMContentLoaded",()=>{const he=window.MEDICINE_TRENDS_CONFIG||{},ye=he.apiPath||"index.php",ge=document.body,de=ge.dataset.dbReady==="1",O=document.getElementById("trends-status"),J=document.getElementById("trend-avg-week"),Z=document.getElementById("trend-avg-90"),Q=document.getElementById("trend-entries-30"),X=document.getElementById("trend-active-days-30"),G=document.getElementById("trend-dose-gap-week"),Y=document.getElementById("trend-dose-gap-7d"),E=document.getElementById("trend-monthly-body"),x=document.getElementById("trend-weekly-body"),S=document.getElementById("trend-medicines-body"),F=document.getElementById("trend-weekday-body"),b=document.getElementById("trend-dose-order-body"),q=document.getElementById("chart-monthly-rating"),K=document.getElementById("chart-weekly-entries"),z=document.getElementById("chart-top-medicines"),W=document.getElementById("chart-weekday-pattern"),w=document.getElementById("chart-dose-order"),m=document.getElementById("chart-dose-order-meta"),V=document.getElementById("chart-dose-interval"),B=document.getElementById("chart-dose-interval-meta"),I=document.getElementById("chart-dose-interval-rolling"),C=document.getElementById("chart-dose-interval-rolling-meta"),u=document.getElementById("dose-view-controls"),s=document.getElementById("dose-order-controls"),n=document.getElementById("dose-medicine-controls");let a=null,f="single",h=null,o="all";const H=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];function oe(e){const t=e instanceof Date?e:new Date,n=t.getDay();return(n+6)%7}function N(){const t=oe(new Date),e=[];for(let n=6;n>=0;n-=1){const s=(t-n+7)%7;e.push({weekday_index:s,weekday_label:H[s]})}return e}function je(e){const t=new URL(ye,window.location.href);return t.searchParams.set("api",e),t.toString()}async function pe(e){const n=await fetch(je(e),{method:"GET",headers:{Accept:"application/json"}});let t=null;try{t=await n.json()}catch{throw new Error("Server returned an unreadable response.")}if(!n.ok||!t.ok){const e=t?.errors?.join(" ")||t?.error||"Request failed.";throw new Error(e)}return t}function P(e,t="success"){if(!O)return;O.hidden=!1,O.textContent=e,O.className=t==="error"?"alert alert-error":"alert alert-success"}function j(e){if(e==null||e==="")return"--";const t=Number(e);return Number.isFinite(t)?`${t.toFixed(2)} / 5`:"--"}function v(e){const t=Number(e);return Number.isFinite(t)?String(Math.round(t)):"0"}function d(e,t=!1){if(e==null||e==="")return"--";const o=Number(e);if(!Number.isFinite(o))return"--";const n=Math.round(o);if(n>1440)return t?"12 AM+":"12:00 AM (+1d)";if(n===1440)return t?"12AM":"12:00 AM";const i=Math.max(0,n),s=Math.floor(i/60),a=i%60,r=s>=12?"PM":"AM",c=s%12===0?12:s%12;return t&&a===0?`${c}${r}`:`${c}:${String(a).padStart(2,"0")} ${r}`}function l(e,t=!1){if(e==null||e==="")return"--";const o=Number(e);if(!Number.isFinite(o))return"--";const i=Math.max(0,Math.round(o)),n=Math.floor(i/60),s=i%60;return n<=0?`${s}m`:s===0?t?`${n}h`:`${n}h 0m`:`${n}h ${s}m`}function re(e){const t=Number(e);return Number.isFinite(t)?Math.abs(t-Math.round(t))<.001?String(Math.round(t)):t.toFixed(2).replace(/\.?0+$/,""):"--"}function t(e){const t=Number(e);return!Number.isInteger(t)||t<=0?null:t}function i(e){if(e==="all")return"all";const t=Number(e);return!Number.isInteger(t)||t<=0?null:t}function p(e){const n=t(e);if(n===null)return String(e);const s=n%100;if(s>=11&&s<=13)return`${n}th`;switch(n%10){case 1:return`${n}st`;case 2:return`${n}nd`;case 3:return`${n}rd`;default:return`${n}th`}}function e(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function y(e,t=12){const n=String(e);return n.length<=t?n:`${n.slice(0,t-1)}...`}function c(e,t,n=3){if(!e)return;e.innerHTML="";const o=document.createElement("tr"),s=document.createElement("td");s.className="empty-cell",s.colSpan=n,s.textContent=t,o.appendChild(s),e.appendChild(o)}function g(e,t,n,s){if(!e)return;if(e.innerHTML="",!Array.isArray(t)||t.length===0){c(e,"No data yet.",n);return}t.forEach(t=>{const n=document.createElement("tr"),o=s(t);o.forEach(e=>{const t=document.createElement("td");t.textContent=String(e),n.appendChild(t)}),e.appendChild(n)})}function r(t,n){if(!t)return;t.innerHTML=`<p class="chart-empty">${e(n)}</p>`}function k(e,t=280){const n=700;if(!e)return{width:n,height:t};const o=e.getBoundingClientRect(),s=Math.round(o.width||e.clientWidth||0),i=Math.max(280,s>0?s:n);return{width:i,height:t}}function A(t,n,s={}){if(!t)return;const i=n.filter(e=>Number.isFinite(e.value));if(i.length===0){r(t,"No chart data yet.");return}const m=k(t,280),d=m.width,c=m.height,o={top:22,right:16,bottom:48,left:48},p=d-o.left-o.right,w=c-o.top-o.bottom,h=i.map(e=>e.value);let a=Number.isFinite(s.yMin)?s.yMin:Math.min(...h),l=Number.isFinite(s.yMax)?s.yMax:Math.max(...h);s.startAtZero&&(a=Math.min(0,a)),a===l&&(l=a+1);const f=e=>i.length===1?o.left+p/2:o.left+e/(i.length-1)*p,u=e=>o.top+(l-e)/(l-a)*w,g=4,v=[],b=[];for(let t=0;t<=g;t+=1){const n=l-(l-a)*t/g,i=u(n),r=typeof s.tickFormatter=="function"?s.tickFormatter(n):n.toFixed(1);v.push(`<line class="chart-grid-line" x1="${o.left}" y1="${i.toFixed(2)}" x2="${d-o.right}" y2="${i.toFixed(2)}"></line>`),b.push(`<text class="chart-axis-label" x="${o.left-8}" y="${(i+4).toFixed(2)}" text-anchor="end">${e(r)}</text>`)}const O=i.map((e,t)=>{const n=t===0?"M":"L";return`${n}${f(t).toFixed(2)} ${u(e.value).toFixed(2)}`}).join(" "),j=[],_=[],x=i.length>8?Math.ceil(i.length/6):1;i.forEach((t,n)=>{const a=f(n),r=u(t.value),l=typeof s.valueFormatter=="function"?s.valueFormatter(t.value):String(t.value);if(_.push(`<circle class="chart-point" cx="${a.toFixed(2)}" cy="${r.toFixed(2)}" r="3.8"><title>${e(`${t.label}: ${l}`)}</title></circle>`),n%x===0||n===i.length-1){const n=typeof s.labelFormatter=="function"?s.labelFormatter(t.label):y(t.label,10);j.push(`<text class="chart-axis-label" x="${a.toFixed(2)}" y="${c-o.bottom+18}" text-anchor="middle">${e(n)}</text>`)}}),t.innerHTML=`
      <svg class="chart-svg" viewBox="0 0 ${d} ${c}" role="img" aria-label="${e(s.ariaLabel||"Line chart")}">
        <line class="chart-axis-line" x1="${o.left}" y1="${o.top}" x2="${o.left}" y2="${c-o.bottom}"></line>
        <line class="chart-axis-line" x1="${o.left}" y1="${c-o.bottom}" x2="${d-o.right}" y2="${c-o.bottom}"></line>
        ${v.join("")}
        ${b.join("")}
        <path class="chart-line" d="${O}"></path>
        ${_.join("")}
        ${j.join("")}
      </svg>
    `}function D(e,t){if(!e)return;const s=e.querySelectorAll(t);if(s.length===0)return;const n=document.createElement("div");n.className="chart-tooltip",n.hidden=!0,e.appendChild(n);const o=(t,s)=>{const o=e.getBoundingClientRect(),a=n.offsetWidth,i=n.offsetHeight,r=t-o.left+12,c=s-o.top-i-10,l=Math.min(Math.max(8,r),Math.max(8,o.width-a-8)),d=Math.min(Math.max(8,c),Math.max(8,o.height-i-8));n.style.left=`${l}px`,n.style.top=`${d}px`},i=()=>{n.hidden=!0};s.forEach(e=>{e.addEventListener("mouseenter",t=>{const a=e.getAttribute("data-tooltip")||"";let s="";try{s=decodeURIComponent(a)}catch{s=""}if(s===""){i();return}n.textContent=s,n.hidden=!1,o(t.clientX,t.clientY)}),e.addEventListener("mousemove",e=>{if(n.hidden)return;o(e.clientX,e.clientY)}),e.addEventListener("mouseleave",i)})}function M(t,n,s={}){if(!t)return;const j=Array.isArray(n)?n:[],h=j.filter(e=>Number.isFinite(e.value)),a=s.keepAllPoints===!0?j:h;if(a.length===0||h.length===0){r(t,"No chart data yet.");return}const b=k(t,280),l=b.width,d=b.height,o={top:22,right:16,bottom:52,left:44},A=l-o.left-o.right,m=d-o.top-o.bottom,M=h.map(e=>e.value),p=Math.max(1,Number.isFinite(s.yMax)?s.yMax:Math.max(...M)),S=s.integerTicks===!0,u=4,c=[];let i=p;if(S){const e=Math.max(1,Math.ceil(p/u));i=Math.max(e,Math.ceil(p/e)*e);for(let t=i;t>=0;t-=e)c.push(t);c[c.length-1]!==0&&c.push(0)}else for(let e=0;e<=u;e+=1)c.push(i-i*e/u);const _=e=>o.top+(i-e)/i*m,w=[],O=[];c.forEach(t=>{const n=_(t),i=typeof s.tickFormatter=="function"?s.tickFormatter(t):String(Math.round(t));w.push(`<line class="chart-grid-line" x1="${o.left}" y1="${n.toFixed(2)}" x2="${l-o.right}" y2="${n.toFixed(2)}"></line>`),O.push(`<text class="chart-axis-label" x="${o.left-8}" y="${(n+4).toFixed(2)}" text-anchor="end">${e(i)}</text>`)});let x="",v="";if(Number.isFinite(s.referenceLineValue)){const t=Number(s.referenceLineValue),c=Math.max(0,Math.min(i,t)),n=_(c),a=s.referenceLineLabel||"Average",r=typeof s.referenceValueFormatter=="function"?s.referenceValueFormatter(t):String(t),d=Math.max(o.top+12,n-6);x=`<line class="chart-reference-line" x1="${o.left}" y1="${n.toFixed(2)}" x2="${l-o.right}" y2="${n.toFixed(2)}"><title>${e(`${a}: ${r}`)}</title></line>`,v=`<text class="chart-reference-label" x="${(l-o.right-4).toFixed(2)}" y="${d.toFixed(2)}" text-anchor="end">${e(`${a}: ${r}`)}</text>`}const C=[],E=[],g=A/a.length,f=Math.max(10,g*.64),F=a.length>10?Math.ceil(a.length/8):1;a.forEach((t,n)=>{const r=o.left+n*g+(g-f)/2,c=Number.isFinite(t.value),l=c?Math.max(0,t.value)/i*m:0,u=o.top+m-l,h=typeof s.valueFormatter=="function"?s.valueFormatter(t.value):String(t.value);if(c){const e=`${t.label}: ${h}`,n=encodeURIComponent(e);C.push(`<rect class="chart-bar" x="${r.toFixed(2)}" y="${u.toFixed(2)}" width="${f.toFixed(2)}" height="${l.toFixed(2)}" data-tooltip="${n}"></rect>`)}if(n%F===0||n===a.length-1){const n=typeof s.labelFormatter=="function"?s.labelFormatter(t.label):y(t.label,10);E.push(`<text class="chart-axis-label" x="${(r+f/2).toFixed(2)}" y="${d-o.bottom+18}" text-anchor="middle">${e(n)}</text>`)}}),t.innerHTML=`
      <svg class="chart-svg" viewBox="0 0 ${l} ${d}" role="img" aria-label="${e(s.ariaLabel||"Bar chart")}">
        <line class="chart-axis-line" x1="${o.left}" y1="${o.top}" x2="${o.left}" y2="${d-o.bottom}"></line>
        <line class="chart-axis-line" x1="${o.left}" y1="${d-o.bottom}" x2="${l-o.right}" y2="${d-o.bottom}"></line>
        ${w.join("")}
        ${O.join("")}
        ${C.join("")}
        ${x}
        ${v}
        ${E.join("")}
      </svg>
    `,s.enableHoverTooltip===!0&&D(t,".chart-bar[data-tooltip]")}function ue(t,n){if(!t)return;const s=n.filter(e=>Number.isFinite(e.value));if(s.length===0){r(t,"No chart data yet.");return}const o=Math.max(...s.map(e=>e.value),1),i=s.map(t=>{const n=Math.max(0,t.value)/o*100;return`
        <div class="bar-row">
          <div class="bar-meta">
            <span class="bar-label">${e(t.label)}</span>
            <span class="bar-value">${e(v(t.value))}</span>
          </div>
          <div class="bar-track" aria-hidden="true">
            <span class="bar-fill" style="width: ${n.toFixed(2)}%"></span>
          </div>
        </div>
      `});t.innerHTML=`<div class="bar-list">${i.join("")}</div>`}function te(e){r(q,e),r(K,e),r(z,e),r(W,e),r(w,e),r(V,e),r(I,e)}function ee(e,n,s){const r=N(),o=new Map,a=i(s),c=a===null?"all":a;return e.forEach(e=>{const d=t(e.dose_order),r=e.medicine_id===null||e.medicine_id===0[0]||e.medicine_id===""?"all":i(e.medicine_id),s=Number(e.weekday_index);if(d!==n||r===null||r!==c||!Number.isInteger(s)||s<0||s>6)return;const l=Number(e.avg_minute_of_day),a=Number(e.samples);o.set(s,{weekday_index:s,weekday_label:H[s],avg_minute_of_day:Number.isFinite(l)?l:null,samples:Number.isFinite(a)&&a>0?Math.round(a):0})}),r.map(e=>o.has(e.weekday_index)?o.get(e.weekday_index):{weekday_index:e.weekday_index,weekday_label:e.weekday_label,avg_minute_of_day:null,samples:0})}function U(e,n,s){const a=i(s),r=a===null?"all":a,c=new Set((Array.isArray(n)?n:[]).map(e=>t(e)).filter(e=>e!==null)),o=new Map;return(Array.isArray(e)?e:[]).forEach(e=>{const n=t(e.dose_order),a=e.medicine_id===null||e.medicine_id===0[0]||e.medicine_id===""?"all":i(e.medicine_id),l=String(e.dosage_unit||"").trim(),d=Number(e.avg_dosage_value),s=Number(e.samples);if(n===null||!c.has(n)||a===null||a!==r||l===""||!Number.isFinite(d)||!Number.isFinite(s)||s<=0)return;o.has(n)||o.set(n,[]),o.get(n).push({dosage_unit:l,avg_dosage_value:d,samples:Math.round(s)})}),(Array.isArray(n)?n:[]).map(e=>{const n=t(e),s=n!==null&&o.has(n)?o.get(n):[],i=s.map(e=>`${re(e.avg_dosage_value)} ${String(e.dosage_unit||"").trim()}`).filter(e=>e!=="").join(" / "),a=s.reduce((e,t)=>e+Math.max(0,Number(t.samples)||0),0);return{dose_order:n,dosage_text:i===""?"--":i,samples:a}})}function ae(e,n,s){const r=N(),c=new Set((Array.isArray(n)?n:[]).map(e=>t(e)).filter(e=>e!==null)),o=new Map,a=i(s),l=a===null?"all":a;return e.forEach(e=>{const s=t(e.dose_order),r=e.medicine_id===null||e.medicine_id===0[0]||e.medicine_id===""?"all":i(e.medicine_id),n=Number(e.weekday_index);if(s===null||!c.has(s)||r===null||r!==l||!Number.isInteger(n)||n<0||n>6)return;const d=Number(e.avg_minute_of_day),a=Number(e.samples),u={dose_order:s,avg_minute_of_day:Number.isFinite(d)?d:null,samples:Number.isFinite(a)&&a>0?Math.round(a):0};o.has(n)||o.set(n,new Map),o.get(n).set(s,u)}),r.map(e=>{const s=o.get(e.weekday_index)||new Map,i=(Array.isArray(n)?n:[]).map(e=>{const n=t(e),o=n!==null?s.get(n):null;return o||{dose_order:n,avg_minute_of_day:null,samples:0}});return{weekday_index:e.weekday_index,weekday_label:e.weekday_label,doses:i}})}function $(e){let n=0,t=0;return e.forEach(e=>{const o=Number(e.avg_minute_of_day),s=Number(e.samples);Number.isFinite(o)&&Number.isFinite(s)&&s>0&&(n+=o*s,t+=s)}),t>0?n/t:null}function ce(e,n,s){const o=new Map;Array.isArray(n)&&n.forEach(e=>{const t=i(e?.id),n=String(e?.name||"").trim();t!==null&&t!=="all"&&n!==""&&o.set(t,n)});const a=new Map;return e.forEach(e=>{const l=t(e.dose_order),n=i(e.medicine_id),r=Number(e.samples);if(l!==s||n===null||n==="all"||!Number.isFinite(r)||r<=0)return;const c=String(e.medicine_name||"").trim();a.set(n,c!==""?c:o.get(n)||`Medicine ${n}`)}),Array.from(a.entries()).map(([e,t])=>({id:e,name:t})).sort((e,t)=>e.name.localeCompare(t.name))}function le(e,n,s){const o=new Map;Array.isArray(n)&&n.forEach(e=>{const t=i(e?.id),n=String(e?.name||"").trim();t!==null&&t!=="all"&&n!==""&&o.set(t,n)});const r=new Set((Array.isArray(s)?s:[]).map(e=>t(e)).filter(e=>e!==null)),a=new Map;return e.forEach(e=>{const s=t(e.dose_order),n=i(e.medicine_id),c=Number(e.samples);if(s===null||!r.has(s)||n===null||n==="all"||!Number.isFinite(c)||c<=0)return;const l=String(e.medicine_name||"").trim();a.set(n,l!==""?l:o.get(n)||`Medicine ${n}`)}),Array.from(a.entries()).map(([e,t])=>({id:e,name:t})).sort((e,t)=>e.name.localeCompare(t.name))}function ne(){if(!u)return;const e=[{id:"single",label:"Single dose"},{id:"combined",label:"Combined day"}];u.innerHTML="",e.forEach(e=>{const t=document.createElement("button");t.type="button",t.className="ghost-btn dose-order-btn",t.textContent=e.label,f===e.id&&t.classList.add("is-active"),t.addEventListener("click",()=>{if(f===e.id)return;f=e.id,a&&_(a)}),u.appendChild(t)})}function ie(e,t){const o=Math.max(0,Number(e)||0),n=Math.max(1,Number(t)||1),s=n<=1?0:Math.max(0,Math.min(1,o/(n-1))),i=45-s*20,a=.96-s*.24;return`hsla(172, 72%, ${i.toFixed(1)}%, ${a.toFixed(3)})`}function se(e,t){const s=Math.max(0,Number(e)||0),n=Math.max(1,Number(t)||1),o=n<=1?0:Math.max(0,Math.min(1,s/(n-1))),i=59-o*14;return`hsla(33, 90%, ${i.toFixed(1)}%, 1)`}function me(n,s,o,i){if(!n)return;const m=Array.isArray(s)?s:[],f=Array.isArray(o)?o:[],S=m.some(e=>!!Array.isArray(e.doses)&&e.doses.some(e=>Number.isFinite(Number(e.avg_minute_of_day))&&Number(e.samples)>0));if(m.length===0||f.length===0||!S){r(n,"No chart data yet.");return}const j=k(n,280),c=j.width,l=j.height,a={top:22,right:16,bottom:52,left:44},C=c-a.left-a.right,g=l-a.top-a.bottom,u=24,E=[24,18,12,6,0],b=e=>a.top+(u-e)/u*g,A=Array.isArray(i?.referenceLines)?i.referenceLines.map(e=>({value:Number(e?.value),label:String(e?.label||"Average"),color:String(e?.color||"#f5a23a")})).filter(e=>Number.isFinite(e.value)):[],v=[],y=[];E.forEach(t=>{const n=b(t);v.push(`<line class="chart-grid-line" x1="${a.left}" y1="${n.toFixed(2)}" x2="${c-a.right}" y2="${n.toFixed(2)}"></line>`),y.push(`<text class="chart-axis-label" x="${a.left-8}" y="${(n+4).toFixed(2)}" text-anchor="end">${e(d(t*60,!0))}</text>`)});const h=C/m.length,_=[],w=[],O=[],x=[],M=[...f].sort((e,t)=>t-e);A.forEach((t,n)=>{const s=Math.max(0,Math.min(u,t.value)),o=b(s),i=d(s*60);O.push(`<line class="chart-reference-line chart-dose-reference-line" x1="${a.left}" y1="${o.toFixed(2)}" x2="${c-a.right}" y2="${o.toFixed(2)}" style="stroke:${e(t.color)}"><title>${e(`${t.label}: ${i}`)}</title></line>`),x.push(`<text class="chart-reference-label chart-dose-reference-label" x="${(c-a.right-4).toFixed(2)}" y="${(a.top+12+n*12).toFixed(2)}" text-anchor="end" style="fill:${e(t.color)}">${e(`${t.label}: ${i}`)}</text>`)}),m.forEach((n,s)=>{const o=a.left+s*h+h/2,i=new Map((Array.isArray(n.doses)?n.doses:[]).map(e=>[t(e.dose_order),e]));M.forEach(e=>{const s=t(e);if(s===null)return;const l=f.indexOf(s),r=i.get(s);if(!r)return;const c=Number(r.avg_minute_of_day),m=Number(r.samples);if(!Number.isFinite(c)||!Number.isFinite(m)||m<=0)return;const j=Math.max(0,Math.min(u,c/60)),v=j/u*g,y=a.top+g-v,w=.46+l*.08,b=Math.max(12,Math.min(h*.84,h*w)),O=o-b/2,x=`${n.weekday_label} ${p(s)} dose: ${d(c)}`;_.push(`<rect class="chart-bar chart-dose-layer" x="${O.toFixed(2)}" y="${y.toFixed(2)}" width="${b.toFixed(2)}" height="${v.toFixed(2)}" style="fill:${ie(l,f.length)}" data-tooltip="${encodeURIComponent(x)}"></rect>`)}),w.push(`<text class="chart-axis-label" x="${o.toFixed(2)}" y="${l-a.bottom+18}" text-anchor="middle">${e(n.weekday_label)}</text>`)}),n.innerHTML=`
      <svg class="chart-svg" viewBox="0 0 ${c} ${l}" role="img" aria-label="${e(i?.ariaLabel||"Combined dose time highlights")}">
        <line class="chart-axis-line" x1="${a.left}" y1="${a.top}" x2="${a.left}" y2="${l-a.bottom}"></line>
        <line class="chart-axis-line" x1="${a.left}" y1="${l-a.bottom}" x2="${c-a.right}" y2="${l-a.bottom}"></line>
        ${v.join("")}
        ${y.join("")}
        ${_.join("")}
        ${x.join("")}
        ${w.join("")}
        ${O.join("")}
      </svg>
    `,D(n,".chart-dose-layer[data-tooltip]")}function fe(e){if(!s)return;s.innerHTML="",e.forEach(e=>{const t=document.createElement("button");t.type="button",t.className="ghost-btn dose-order-btn",t.textContent=`${p(e)} dose`,e===h&&t.classList.add("is-active"),t.addEventListener("click",()=>{if(h===e)return;h=e,a&&_(a)}),s.appendChild(t)})}function R(e){if(!n)return;if(!Array.isArray(e)||e.length<=1){n.hidden=!0,n.innerHTML="";return}n.hidden=!1,n.innerHTML="";const t=document.createElement("button");t.type="button",t.className="ghost-btn dose-order-btn",t.textContent="All medicines",o==="all"&&t.classList.add("is-active"),t.addEventListener("click",()=>{if(o==="all")return;o="all",a&&_(a)}),n.appendChild(t),e.forEach(e=>{const t=i(e.id);if(t===null||t==="all")return;const s=document.createElement("button");s.type="button",s.className="ghost-btn dose-order-btn",s.textContent=String(e.name||`Medicine ${t}`),o===t&&s.classList.add("is-active"),s.addEventListener("click",()=>{if(o===t)return;o=t,a&&_(a)}),n.appendChild(s)})}function _(e){const l=e?.dose_weekday_patterns_7_days||e?.dose_weekday_patterns_90_days||{},j=Array.isArray(l.rows)?l.rows:[],T=Array.isArray(l.dosage_averages)?l.dosage_averages:[],k=Array.isArray(l.available_medicines)?l.available_medicines:[];let a=Array.isArray(l.available_orders)?l.available_orders.map(e=>t(e)).filter(e=>e!==null):[];if(f!=="single"&&f!=="combined"&&(f="single"),a.length===0&&(a=Array.from(new Set(j.map(e=>t(e.dose_order)).filter(e=>e!==null)))),a.sort((e,t)=>e-t),a.length===0){o="all",u&&(u.innerHTML=""),s&&(s.hidden=f!=="single",s.innerHTML=""),n&&(n.hidden=!0,n.innerHTML=""),m&&(m.textContent="No dose-order timing data yet for the last 7 days."),c(b,"No data yet."),r(w,"No chart data yet.");return}ne();const z=f==="combined";if(z){s&&(s.hidden=!0);const n=le(j,k,a),h=i(o);n.length<=1||h===null?o="all":h!=="all"&&!n.some(e=>e.id===h)&&(o="all"),R(n);const l=n.length>1?i(o)||"all":"all",x=n.find(e=>e.id===l),v=l==="all"?n.length===1?n[0].name:"All medicines":x?.name||"All medicines",u=ae(j,a,l),e=a.filter(e=>u.some(n=>(Array.isArray(n.doses)?n.doses:[]).some(n=>t(n.dose_order)===e&&Number.isFinite(Number(n.avg_minute_of_day))&&Number(n.samples)>0)));if(e.length===0){m&&(m.textContent="No combined dose timing data yet for the last 7 days."),c(b,"No data yet."),r(w,"No chart data yet.");return}const y=e.map(e=>{const t=ee(j,e,l),n=$(t);return{doseOrder:e,averageMinute:n}}).filter(e=>e.averageMinute!==null),O=U(T,e,l),f=y.map(e=>`${p(e.doseOrder)}: ${d(e.averageMinute)}`).join(" | "),_=O.filter(e=>e.dose_order!==null&&e.samples>0&&String(e.dosage_text||"").trim()!=="--").map(e=>`${p(e.dose_order)}: ${String(e.dosage_text||"--")}`).join(" | "),C=f===""?"No average-time samples yet.":f,E=_===""?"No dosage averages yet.":_;m&&(m.textContent=`Combined timing for ${v} over the last 7 days. Avg times: ${C}. Avg dosages: ${E}`),g(b,u,3,n=>{const s=e.map(e=>{const s=(Array.isArray(n.doses)?n.doses:[]).find(n=>t(n.dose_order)===e);return!s||!Number.isFinite(Number(s.avg_minute_of_day))||Number(s.samples)<=0?null:`${p(e)}: ${d(s.avg_minute_of_day)}`}).filter(e=>e!==null),o=(Array.isArray(n.doses)?n.doses:[]).reduce((n,s)=>{const o=t(s.dose_order);return o===null||!e.includes(o)?n:n+Math.max(0,Number(s.samples)||0)},0);return[n.weekday_label,s.length>0?s.join(" | "):"--",o]}),me(w,u,e,{ariaLabel:`Combined dose times by weekday for ${v}`,referenceLines:y.map(t=>{const n=e.indexOf(t.doseOrder),s=Number(t.averageMinute)/60;return{value:s,label:`${p(t.doseOrder)} Avg`,color:se(n,e.length)}})});return}s&&(s.hidden=!1),a.includes(h)||(h=a[0]),fe(a);const v=ce(j,k,h),E=i(o);v.length<=1||E===null?o="all":E!=="all"&&!v.some(e=>e.id===E)&&(o="all"),R(v);const x=v.length>1?i(o)||"all":"all",P=v.find(e=>e.id===x),A=x==="all"?v.length===1?v[0].name:"All medicines":P?.name||"All medicines",_=ee(j,h,x),y=`${p(h)} dose`,C=$(_),N=C===null?null:C/60,D=_.reduce((e,t)=>e+Math.max(0,Number(t.samples)||0),0),F=U(T,a,x),O=F.find(e=>e.dose_order===h),L=O&&O.samples>0&&String(O.dosage_text||"").trim()!==""?String(O.dosage_text):"--",S=F.filter(e=>e.dose_order!==null&&e.samples>0&&String(e.dosage_text||"").trim()!=="--").map(e=>`${p(e.dose_order)}: ${String(e.dosage_text||"--")}`).join(" | "),H=S===""?"No dosage averages yet.":S;m&&(m.textContent=`${y} average time by day for ${A} over the last 7 days. ${y} overall average: ${d(C)} (${D} samples). ${y} avg dosage: ${L}. All dose avg dosages: ${H}`),g(b,_,3,e=>[e.weekday_label,e.samples>0?d(e.avg_minute_of_day):"--",e.samples]);const I=_.map(e=>({label:e.weekday_label,value:e.samples>0&&Number.isFinite(Number(e.avg_minute_of_day))?Number(e.avg_minute_of_day)/60:Number.NaN}));M(w,I,{ariaLabel:`${y} average time by day for ${A}`,yMax:24,integerTicks:!0,keepAllPoints:!0,enableHoverTooltip:!0,tickFormatter:e=>d(e*60,!0),valueFormatter:e=>d(e*60),labelFormatter:e=>e,referenceLineValue:N,referenceLineLabel:`${y} Avg`,referenceValueFormatter:e=>d(e*60)})}function ve(e){const p=Array.isArray(e?.dose_interval_weekly_12_weeks)?e.dose_interval_weekly_12_weeks:[],t=e?.summary||{},u=Number(t.avg_dose_interval_this_week_minutes),n=Number.isFinite(u)?u:null,c=Number(t.dose_interval_this_week_samples),a=Number.isFinite(c)&&c>0?Math.round(c):0,m=Number(t.avg_dose_interval_last_7_days_minutes),s=Number.isFinite(m)?m:null,o=Number(t.dose_interval_last_7_days_samples),i=Number.isFinite(o)&&o>0?Math.round(o):0,d=Number(t.avg_dose_interval_last_90_days_minutes),h=Number.isFinite(d)?d:null,r=Number(t.dose_interval_last_90_days_samples),f=Number.isFinite(r)&&r>0?Math.round(r):0;G&&(G.textContent=n!==null&&a>0?l(n):"--"),Y&&(Y.textContent=s!==null&&i>0?l(s):"--");const g=n!==null&&a>0?`This week average gap: ${l(n)} (${a} gaps).`:"No dose-gap samples this week yet.",v=s!==null&&i>0?`Rolling 7-day average gap: ${l(s)} (${i} gaps).`:"No rolling 7-day dose-gap samples yet.",b=h!==null&&f>0?`Last 90-day average gap: ${l(h)} (${f} gaps).`:"No dose-gap data in the last 90 days.";B&&(B.textContent=`Average time between consecutive doses by week over the last 12 weeks. ${g} ${v} ${b}`);const j=p.map(e=>({label:String(e.label||"-").replace(/^Week of\s+/i,""),value:Number.isFinite(Number(e.avg_interval_minutes))&&Number(e.avg_interval_minutes)>=0?Number(e.avg_interval_minutes)/60:Number.NaN})).filter(e=>Number.isFinite(e.value));A(V,j,{yMin:0,ariaLabel:"Average time between doses by week",tickFormatter:e=>l(e*60,!0),valueFormatter:e=>l(e*60),labelFormatter:e=>y(e,8)})}function be(e){const i=Array.isArray(e?.dose_interval_rolling_7_days_30_days)?e.dose_interval_rolling_7_days_30_days:[],t=[...i].reverse().find(e=>Number(e.samples)>0);C&&(t&&Number.isFinite(Number(t.avg_interval_minutes))?C.textContent=`Rolling 7-day average time between consecutive doses over the last 30 days. Latest window (${t.label||t.date||"today"}): ${l(Number(t.avg_interval_minutes))} (${v(t.samples)} gaps).`:C.textContent="Rolling 7-day average time between consecutive doses over the last 30 days. No rolling-window samples yet.");const a=i.map(e=>({label:String(e.date||e.label||"-"),value:Number.isFinite(Number(e.avg_interval_minutes))&&Number(e.avg_interval_minutes)>=0?Number(e.avg_interval_minutes)/60:Number.NaN})),o=a.map(e=>e.value).filter(e=>Number.isFinite(e)),r=o.length>0,s=r?Math.min(...o):null,n=r?Math.max(...o):null,c=s!==null&&n!==null?n-s:0,d=s!==null&&n!==null?Math.max(.15,c>0?c*.12:n*.12):0,h=s!==null?Math.max(0,s-d):0,u=n!==null?n+d:0[0];A(I,a,{yMin:h,...Number.isFinite(u)?{yMax:u}:{},ariaLabel:"Rolling 7-day average time between doses",tickFormatter:e=>l(e*60,!0),valueFormatter:e=>l(e*60),labelFormatter:e=>{if(/^\d{4}-\d{2}-\d{2}$/.test(e)){const t=e.slice(5);return t.replace("-","/")}return y(e,8)}})}function L(e){const n=Array.isArray(e.monthly_average_rating)?e.monthly_average_rating:[],s=Array.isArray(e.weekly_entries)?e.weekly_entries:[],o=Array.isArray(e.top_medicines_90_days)?e.top_medicines_90_days:[],i=Array.isArray(e.weekday_patterns_90_days)?e.weekday_patterns_90_days:[],t=e.summary||{};if(J&&(J.textContent=j(t.avg_rating_this_week)),Z&&(Z.textContent=j(t.avg_rating_last_90_days)),Q&&(Q.textContent=String(t.entries_last_30_days??0)),X){const e=Number(t.active_days_last_30_days??0),n=Number(t.active_day_ratio_last_30_days??0);X.textContent=`${e} (${n.toFixed(1)}%)`}g(E,n,3,e=>[e.label||"-",j(e.avg_rating),e.entries??0]),g(x,s,3,e=>[e.label||"-",e.entries??0,j(e.avg_rating)]),g(S,o,3,e=>[e.medicine_name||"-",e.entries??0,j(e.avg_rating)]),g(F,i,3,e=>[e.label||"-",e.entries??0,j(e.avg_rating)]);const r=n.map(e=>({label:e.label||"-",value:Number(e.avg_rating)})).filter(e=>Number.isFinite(e.value));A(q,r,{yMin:0,yMax:5,ariaLabel:"Monthly average rating trend",tickFormatter:e=>e.toFixed(1),valueFormatter:e=>`${e.toFixed(2)} / 5`,labelFormatter:e=>y(e,8)});const c=s.map(e=>({label:String(e.label||"-").replace(/^Week of\s+/i,""),value:Number(e.entries)})).filter(e=>Number.isFinite(e.value));M(K,c,{ariaLabel:"Weekly intake entries trend",integerTicks:!0,tickFormatter:e=>v(e),valueFormatter:e=>`${v(e)} entries`,labelFormatter:e=>y(e,8)});const l=o.map(e=>({label:e.medicine_name||"-",value:Number(e.entries)})).filter(e=>Number.isFinite(e.value));ue(z,l);const d=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],a=new Map(i.map(e=>[String(e.label||""),Number(e.entries)])),u=d.map(e=>({label:e,value:Number.isFinite(a.get(e))?Number(a.get(e)):0}));M(W,u,{ariaLabel:"Weekday intake entry pattern",integerTicks:!0,tickFormatter:e=>v(e),valueFormatter:e=>`${v(e)} entries`,labelFormatter:e=>e}),_(e),ve(e),be(e)}if(!de){P("Database unavailable.","error"),c(E,"Database unavailable."),c(x,"Database unavailable."),c(S,"Database unavailable."),c(F,"Database unavailable."),c(b,"Database unavailable."),u&&(u.innerHTML=""),s&&(s.hidden=!0,s.innerHTML=""),n&&(n.hidden=!0,n.innerHTML=""),te("Database unavailable.");return}pe("trends").then(e=>{a=e.trends||{},L(a)}).catch(e=>{a=null,P(e.message,"error"),c(E,"Could not load trends."),c(x,"Could not load trends."),c(S,"Could not load trends."),c(F,"Could not load trends."),c(b,"Could not load trends."),u&&(u.innerHTML=""),s&&(s.hidden=!0,s.innerHTML=""),n&&(n.hidden=!0,n.innerHTML=""),te("Could not load charts.")});let T=null;window.addEventListener("resize",()=>{if(!a)return;T&&window.clearTimeout(T),T=window.setTimeout(()=>{L(a)},120)})})