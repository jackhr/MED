document.addEventListener("DOMContentLoaded",()=>{const ie=window.MEDICINE_TRENDS_CONFIG||{},ye=ie.apiPath||"index.php",ge=document.body,oe=ge.dataset.dbReady==="1",w=document.getElementById("trends-status"),J=document.getElementById("trend-avg-week"),Q=document.getElementById("trend-avg-90"),X=document.getElementById("trend-entries-30"),G=document.getElementById("trend-active-days-30"),Y=document.getElementById("trend-dose-gap-week"),q=document.getElementById("trend-dose-gap-7d"),x=document.getElementById("trend-monthly-body"),O=document.getElementById("trend-weekly-body"),C=document.getElementById("trend-medicines-body"),E=document.getElementById("trend-weekday-body"),v=document.getElementById("trend-dose-order-body"),K=document.getElementById("chart-monthly-rating"),U=document.getElementById("chart-weekly-entries"),T=document.getElementById("chart-top-medicines"),V=document.getElementById("chart-weekday-pattern"),y=document.getElementById("chart-dose-order"),p=document.getElementById("chart-dose-order-meta"),B=document.getElementById("chart-dose-interval"),I=document.getElementById("chart-dose-interval-meta"),H=document.getElementById("chart-dose-interval-rolling"),k=document.getElementById("chart-dose-interval-rolling-meta"),u=document.getElementById("dose-view-controls"),s=document.getElementById("dose-order-controls"),n=document.getElementById("dose-medicine-controls");let a=null,f="single",h=null,o="all";const z=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];function je(e){const t=e instanceof Date?e:new Date,n=t.getDay();return(n+6)%7}function N(){const t=je(new Date),e=[];for(let n=6;n>=0;n-=1){const s=(t-n+7)%7;e.push({weekday_index:s,weekday_label:z[s]})}return e}function pe(e){const t=new URL(ye,window.location.href);return t.searchParams.set("api",e),t.toString()}async function re(e){const n=await fetch(pe(e),{method:"GET",headers:{Accept:"application/json"}});let t=null;try{t=await n.json()}catch{throw new Error("Server returned an unreadable response.")}if(!n.ok||!t.ok){const e=t?.errors?.join(" ")||t?.error||"Request failed.";throw new Error(e)}return t}function P(e,t="success"){if(!w)return;w.hidden=!1,w.textContent=e,w.className=t==="error"?"alert alert-error":"alert alert-success"}function b(e){if(e==null||e==="")return"--";const t=Number(e);return Number.isFinite(t)?`${t.toFixed(2)} / 5`:"--"}function j(e){const t=Number(e);return Number.isFinite(t)?String(Math.round(t)):"0"}function l(e,t=!1){if(e==null||e==="")return"--";const o=Number(e);if(!Number.isFinite(o))return"--";const n=Math.round(o);if(n>1440)return t?"12 AM+":"12:00 AM (+1d)";if(n===1440)return t?"12AM":"12:00 AM";const i=Math.max(0,n),s=Math.floor(i/60),a=i%60,r=s>=12?"PM":"AM",c=s%12===0?12:s%12;return t&&a===0?`${c}${r}`:`${c}:${String(a).padStart(2,"0")} ${r}`}function d(e,t=!1){if(e==null||e==="")return"--";const o=Number(e);if(!Number.isFinite(o))return"--";const i=Math.max(0,Math.round(o)),n=Math.floor(i/60),s=i%60;return n<=0?`${s}m`:s===0?t?`${n}h`:`${n}h 0m`:`${n}h ${s}m`}function ne(e){const t=Number(e);return Number.isFinite(t)?Math.abs(t-Math.round(t))<.001?String(Math.round(t)):t.toFixed(2).replace(/\.?0+$/,""):"--"}function t(e){const t=Number(e);return!Number.isInteger(t)||t<=0?null:t}function i(e){if(e==="all")return"all";const t=Number(e);return!Number.isInteger(t)||t<=0?null:t}function m(e){const n=t(e);if(n===null)return String(e);const s=n%100;if(s>=11&&s<=13)return`${n}th`;switch(n%10){case 1:return`${n}st`;case 2:return`${n}nd`;case 3:return`${n}rd`;default:return`${n}th`}}function e(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function c(e,t,n=3){if(!e)return;e.innerHTML="";const o=document.createElement("tr"),s=document.createElement("td");s.className="empty-cell",s.colSpan=n,s.textContent=t,o.appendChild(s),e.appendChild(o)}function g(e,t,n,s){if(!e)return;if(e.innerHTML="",!Array.isArray(t)||t.length===0){c(e,"No data yet.",n);return}t.forEach(t=>{const n=document.createElement("tr"),o=s(t);o.forEach(e=>{const t=document.createElement("td");t.textContent=String(e),n.appendChild(t)}),e.appendChild(n)})}function r(t,n){if(!t)return;t.innerHTML=`<p class="chart-empty">${e(n)}</p>`}function A(e,t=280){const n=700;if(!e)return{width:n,height:t};const o=e.getBoundingClientRect(),s=Math.round(o.width||e.clientWidth||0),i=Math.max(280,s>0?s:n);return{width:i,height:t}}function Z(e,t,n,s,o){const r=Math.max(1,Number(t)||1);let i=Number(n),a="middle";return e===0?(a="start",i=Math.max(s+2,i)):e===r-1&&(a="end",i=Math.min(o-2,i)),{x:i,anchor:a}}function S(t,n,s={}){if(!t)return;const i=n.filter(e=>Number.isFinite(e.value));if(i.length===0){r(t,"No chart data yet.");return}const m=A(t,280),d=m.width,c=m.height,o={top:22,right:16,bottom:48,left:48},p=d-o.left-o.right,_=c-o.top-o.bottom,h=i.map(e=>e.value);let a=Number.isFinite(s.yMin)?s.yMin:Math.min(...h),l=Number.isFinite(s.yMax)?s.yMax:Math.max(...h);s.startAtZero&&(a=Math.min(0,a)),a===l&&(l=a+1);const f=e=>i.length===1?o.left+p/2:o.left+e/(i.length-1)*p,u=e=>o.top+(l-e)/(l-a)*_,g=4,v=[],b=[];for(let t=0;t<=g;t+=1){const n=l-(l-a)*t/g,i=u(n),r=typeof s.tickFormatter=="function"?s.tickFormatter(n):n.toFixed(1);v.push(`<line class="chart-grid-line" x1="${o.left}" y1="${i.toFixed(2)}" x2="${d-o.right}" y2="${i.toFixed(2)}"></line>`),b.push(`<text class="chart-axis-label" x="${o.left-8}" y="${(i+4).toFixed(2)}" text-anchor="end">${e(r)}</text>`)}const w=i.map((e,t)=>{const n=t===0?"M":"L";return`${n}${f(t).toFixed(2)} ${u(e.value).toFixed(2)}`}).join(" "),j=[],y=[],O=i.length>8?Math.ceil(i.length/6):1;i.forEach((t,n)=>{const a=f(n),r=u(t.value),l=typeof s.valueFormatter=="function"?s.valueFormatter(t.value):String(t.value);if(y.push(`<circle class="chart-point" cx="${a.toFixed(2)}" cy="${r.toFixed(2)}" r="3.8"><title>${e(`${t.label}: ${l}`)}</title></circle>`),n%O===0||n===i.length-1){const l=typeof s.labelFormatter=="function"?s.labelFormatter(t.label):String(t.label),r=Z(n,i.length,a,o.left,d-o.right);j.push(`<text class="chart-axis-label" x="${r.x.toFixed(2)}" y="${c-o.bottom+18}" text-anchor="${r.anchor}">${e(l)}</text>`)}}),t.innerHTML=`
      <svg class="chart-svg" viewBox="0 0 ${d} ${c}" role="img" aria-label="${e(s.ariaLabel||"Line chart")}">
        <line class="chart-axis-line" x1="${o.left}" y1="${o.top}" x2="${o.left}" y2="${c-o.bottom}"></line>
        <line class="chart-axis-line" x1="${o.left}" y1="${c-o.bottom}" x2="${d-o.right}" y2="${c-o.bottom}"></line>
        ${v.join("")}
        ${b.join("")}
        <path class="chart-line" d="${w}"></path>
        ${y.join("")}
        ${j.join("")}
      </svg>
    `}function ee(e,t){if(!e)return;const s=e.querySelectorAll(t);if(s.length===0)return;const n=document.createElement("div");n.className="chart-tooltip",n.hidden=!0,e.appendChild(n);const o=(t,s)=>{const o=e.getBoundingClientRect(),a=n.offsetWidth,i=n.offsetHeight,r=t-o.left+12,c=s-o.top-i-10,l=Math.min(Math.max(8,r),Math.max(8,o.width-a-8)),d=Math.min(Math.max(8,c),Math.max(8,o.height-i-8));n.style.left=`${l}px`,n.style.top=`${d}px`},i=()=>{n.hidden=!0};s.forEach(e=>{e.addEventListener("mouseenter",t=>{const a=e.getAttribute("data-tooltip")||"";let s="";try{s=decodeURIComponent(a)}catch{s=""}if(s===""){i();return}n.textContent=s,n.hidden=!1,o(t.clientX,t.clientY)}),e.addEventListener("mousemove",e=>{if(n.hidden)return;o(e.clientX,e.clientY)}),e.addEventListener("mouseleave",i)})}function M(t,n,s={}){if(!t)return;const j=Array.isArray(n)?n:[],h=j.filter(e=>Number.isFinite(e.value)),a=s.keepAllPoints===!0?j:h;if(a.length===0||h.length===0){r(t,"No chart data yet.");return}const b=A(t,280),c=b.width,d=b.height,o={top:22,right:16,bottom:52,left:44},E=c-o.left-o.right,m=d-o.top-o.bottom,S=h.map(e=>e.value),p=Math.max(1,Number.isFinite(s.yMax)?s.yMax:Math.max(...S)),k=s.integerTicks===!0,u=4,l=[];let i=p;if(k){const e=Math.max(1,Math.ceil(p/u));i=Math.max(e,Math.ceil(p/e)*e);for(let t=i;t>=0;t-=e)l.push(t);l[l.length-1]!==0&&l.push(0)}else for(let e=0;e<=u;e+=1)l.push(i-i*e/u);const y=e=>o.top+(i-e)/i*m,_=[],w=[];l.forEach(t=>{const n=y(t),i=typeof s.tickFormatter=="function"?s.tickFormatter(t):String(Math.round(t));_.push(`<line class="chart-grid-line" x1="${o.left}" y1="${n.toFixed(2)}" x2="${c-o.right}" y2="${n.toFixed(2)}"></line>`),w.push(`<text class="chart-axis-label" x="${o.left-8}" y="${(n+4).toFixed(2)}" text-anchor="end">${e(i)}</text>`)});let O="",v="";if(Number.isFinite(s.referenceLineValue)){const t=Number(s.referenceLineValue),l=Math.max(0,Math.min(i,t)),n=y(l),a=s.referenceLineLabel||"Average",r=typeof s.referenceValueFormatter=="function"?s.referenceValueFormatter(t):String(t),d=Math.max(o.top+12,n-6);O=`<line class="chart-reference-line" x1="${o.left}" y1="${n.toFixed(2)}" x2="${c-o.right}" y2="${n.toFixed(2)}"><title>${e(`${a}: ${r}`)}</title></line>`,v=`<text class="chart-reference-label" x="${(c-o.right-4).toFixed(2)}" y="${d.toFixed(2)}" text-anchor="end">${e(`${a}: ${r}`)}</text>`}const x=[],C=[],g=E/a.length,f=Math.max(10,g*.64),M=a.length>10?Math.ceil(a.length/8):1;a.forEach((t,n)=>{const r=o.left+n*g+(g-f)/2,l=Number.isFinite(t.value),u=l?Math.max(0,t.value)/i*m:0,h=o.top+m-u,p=typeof s.valueFormatter=="function"?s.valueFormatter(t.value):String(t.value);if(l){const e=`${t.label}: ${p}`,n=encodeURIComponent(e);x.push(`<rect class="chart-bar" x="${r.toFixed(2)}" y="${h.toFixed(2)}" width="${f.toFixed(2)}" height="${u.toFixed(2)}" data-tooltip="${n}"></rect>`)}if(n%M===0||n===a.length-1){const l=typeof s.labelFormatter=="function"?s.labelFormatter(t.label):String(t.label),u=r+f/2,i=Z(n,a.length,u,o.left,c-o.right);C.push(`<text class="chart-axis-label" x="${i.x.toFixed(2)}" y="${d-o.bottom+18}" text-anchor="${i.anchor}">${e(l)}</text>`)}}),t.innerHTML=`
      <svg class="chart-svg" viewBox="0 0 ${c} ${d}" role="img" aria-label="${e(s.ariaLabel||"Bar chart")}">
        <line class="chart-axis-line" x1="${o.left}" y1="${o.top}" x2="${o.left}" y2="${d-o.bottom}"></line>
        <line class="chart-axis-line" x1="${o.left}" y1="${d-o.bottom}" x2="${c-o.right}" y2="${d-o.bottom}"></line>
        ${_.join("")}
        ${w.join("")}
        ${x.join("")}
        ${O}
        ${v}
        ${C.join("")}
      </svg>
    `,s.enableHoverTooltip===!0&&ee(t,".chart-bar[data-tooltip]")}function se(t,n){if(!t)return;const s=n.filter(e=>Number.isFinite(e.value));if(s.length===0){r(t,"No chart data yet.");return}const o=Math.max(...s.map(e=>e.value),1),i=s.map(t=>{const n=Math.max(0,t.value)/o*100;return`
        <div class="bar-row">
          <div class="bar-meta">
            <span class="bar-label">${e(t.label)}</span>
            <span class="bar-value">${e(j(t.value))}</span>
          </div>
          <div class="bar-track" aria-hidden="true">
            <span class="bar-fill" style="width: ${n.toFixed(2)}%"></span>
          </div>
        </div>
      `});t.innerHTML=`<div class="bar-list">${i.join("")}</div>`}function $(e){r(K,e),r(U,e),r(T,e),r(V,e),r(y,e),r(B,e),r(H,e)}function te(e,n,s){const r=N(),o=new Map,a=i(s),c=a===null?"all":a;return e.forEach(e=>{const d=t(e.dose_order),r=e.medicine_id===null||e.medicine_id===0[0]||e.medicine_id===""?"all":i(e.medicine_id),s=Number(e.weekday_index);if(d!==n||r===null||r!==c||!Number.isInteger(s)||s<0||s>6)return;const l=Number(e.avg_minute_of_day),a=Number(e.samples);o.set(s,{weekday_index:s,weekday_label:z[s],avg_minute_of_day:Number.isFinite(l)?l:null,samples:Number.isFinite(a)&&a>0?Math.round(a):0})}),r.map(e=>o.has(e.weekday_index)?o.get(e.weekday_index):{weekday_index:e.weekday_index,weekday_label:e.weekday_label,avg_minute_of_day:null,samples:0})}function W(e,n,s){const a=i(s),r=a===null?"all":a,c=new Set((Array.isArray(n)?n:[]).map(e=>t(e)).filter(e=>e!==null)),o=new Map;return(Array.isArray(e)?e:[]).forEach(e=>{const n=t(e.dose_order),a=e.medicine_id===null||e.medicine_id===0[0]||e.medicine_id===""?"all":i(e.medicine_id),l=String(e.dosage_unit||"").trim(),d=Number(e.avg_dosage_value),s=Number(e.samples);if(n===null||!c.has(n)||a===null||a!==r||l===""||!Number.isFinite(d)||!Number.isFinite(s)||s<=0)return;o.has(n)||o.set(n,[]),o.get(n).push({dosage_unit:l,avg_dosage_value:d,samples:Math.round(s)})}),(Array.isArray(n)?n:[]).map(e=>{const n=t(e),s=n!==null&&o.has(n)?o.get(n):[],i=s.map(e=>`${ne(e.avg_dosage_value)} ${String(e.dosage_unit||"").trim()}`).filter(e=>e!=="").join(" / "),a=s.reduce((e,t)=>e+Math.max(0,Number(t.samples)||0),0);return{dose_order:n,dosage_text:i===""?"--":i,samples:a}})}function ae(e,n,s){const r=N(),c=new Set((Array.isArray(n)?n:[]).map(e=>t(e)).filter(e=>e!==null)),o=new Map,a=i(s),l=a===null?"all":a;return e.forEach(e=>{const s=t(e.dose_order),r=e.medicine_id===null||e.medicine_id===0[0]||e.medicine_id===""?"all":i(e.medicine_id),n=Number(e.weekday_index);if(s===null||!c.has(s)||r===null||r!==l||!Number.isInteger(n)||n<0||n>6)return;const d=Number(e.avg_minute_of_day),a=Number(e.samples),u={dose_order:s,avg_minute_of_day:Number.isFinite(d)?d:null,samples:Number.isFinite(a)&&a>0?Math.round(a):0};o.has(n)||o.set(n,new Map),o.get(n).set(s,u)}),r.map(e=>{const s=o.get(e.weekday_index)||new Map,i=(Array.isArray(n)?n:[]).map(e=>{const n=t(e),o=n!==null?s.get(n):null;return o||{dose_order:n,avg_minute_of_day:null,samples:0}});return{weekday_index:e.weekday_index,weekday_label:e.weekday_label,doses:i}})}function R(e){let n=0,t=0;return e.forEach(e=>{const o=Number(e.avg_minute_of_day),s=Number(e.samples);Number.isFinite(o)&&Number.isFinite(s)&&s>0&&(n+=o*s,t+=s)}),t>0?n/t:null}function ce(e,n,s){const o=new Map;Array.isArray(n)&&n.forEach(e=>{const t=i(e?.id),n=String(e?.name||"").trim();t!==null&&t!=="all"&&n!==""&&o.set(t,n)});const a=new Map;return e.forEach(e=>{const l=t(e.dose_order),n=i(e.medicine_id),r=Number(e.samples);if(l!==s||n===null||n==="all"||!Number.isFinite(r)||r<=0)return;const c=String(e.medicine_name||"").trim();a.set(n,c!==""?c:o.get(n)||`Medicine ${n}`)}),Array.from(a.entries()).map(([e,t])=>({id:e,name:t})).sort((e,t)=>e.name.localeCompare(t.name))}function le(e,n,s){const o=new Map;Array.isArray(n)&&n.forEach(e=>{const t=i(e?.id),n=String(e?.name||"").trim();t!==null&&t!=="all"&&n!==""&&o.set(t,n)});const r=new Set((Array.isArray(s)?s:[]).map(e=>t(e)).filter(e=>e!==null)),a=new Map;return e.forEach(e=>{const s=t(e.dose_order),n=i(e.medicine_id),c=Number(e.samples);if(s===null||!r.has(s)||n===null||n==="all"||!Number.isFinite(c)||c<=0)return;const l=String(e.medicine_name||"").trim();a.set(n,l!==""?l:o.get(n)||`Medicine ${n}`)}),Array.from(a.entries()).map(([e,t])=>({id:e,name:t})).sort((e,t)=>e.name.localeCompare(t.name))}function de(){if(!u)return;const e=[{id:"single",label:"Single dose"},{id:"combined",label:"Combined day"}];u.innerHTML="",e.forEach(e=>{const t=document.createElement("button");t.type="button",t.className="ghost-btn dose-order-btn",t.textContent=e.label,f===e.id&&t.classList.add("is-active"),t.addEventListener("click",()=>{if(f===e.id)return;f=e.id,a&&_(a)}),u.appendChild(t)})}function ue(e,t){const o=Math.max(0,Number(e)||0),n=Math.max(1,Number(t)||1),s=n<=1?0:Math.max(0,Math.min(1,o/(n-1))),i=45-s*20,a=.96-s*.24;return`hsla(172, 72%, ${i.toFixed(1)}%, ${a.toFixed(3)})`}function he(e,t){const s=Math.max(0,Number(e)||0),n=Math.max(1,Number(t)||1),o=n<=1?0:Math.max(0,Math.min(1,s/(n-1))),i=59-o*14;return`hsla(33, 90%, ${i.toFixed(1)}%, 1)`}function me(n,s,o,i){if(!n)return;const f=Array.isArray(s)?s:[],p=Array.isArray(o)?o:[],S=f.some(e=>!!Array.isArray(e.doses)&&e.doses.some(e=>Number.isFinite(Number(e.avg_minute_of_day))&&Number(e.samples)>0));if(f.length===0||p.length===0||!S){r(n,"No chart data yet.");return}const j=A(n,280),c=j.width,d=j.height,a={top:22,right:16,bottom:52,left:44},C=c-a.left-a.right,g=d-a.top-a.bottom,u=24,E=[24,18,12,6,0],b=e=>a.top+(u-e)/u*g,k=Array.isArray(i?.referenceLines)?i.referenceLines.map(e=>({value:Number(e?.value),label:String(e?.label||"Average"),color:String(e?.color||"#f5a23a")})).filter(e=>Number.isFinite(e.value)):[],v=[],y=[];E.forEach(t=>{const n=b(t);v.push(`<line class="chart-grid-line" x1="${a.left}" y1="${n.toFixed(2)}" x2="${c-a.right}" y2="${n.toFixed(2)}"></line>`),y.push(`<text class="chart-axis-label" x="${a.left-8}" y="${(n+4).toFixed(2)}" text-anchor="end">${e(l(t*60,!0))}</text>`)});const h=C/f.length,_=[],w=[],O=[],x=[],M=[...p].sort((e,t)=>t-e);k.forEach((t,n)=>{const s=Math.max(0,Math.min(u,t.value)),o=b(s),i=l(s*60);O.push(`<line class="chart-reference-line chart-dose-reference-line" x1="${a.left}" y1="${o.toFixed(2)}" x2="${c-a.right}" y2="${o.toFixed(2)}" style="stroke:${e(t.color)}"><title>${e(`${t.label}: ${i}`)}</title></line>`),x.push(`<text class="chart-reference-label chart-dose-reference-label" x="${(c-a.right-4).toFixed(2)}" y="${(a.top+12+n*12).toFixed(2)}" text-anchor="end" style="fill:${e(t.color)}">${e(`${t.label}: ${i}`)}</text>`)}),f.forEach((n,s)=>{const o=a.left+s*h+h/2,i=new Map((Array.isArray(n.doses)?n.doses:[]).map(e=>[t(e.dose_order),e]));M.forEach(e=>{const s=t(e);if(s===null)return;const d=p.indexOf(s),r=i.get(s);if(!r)return;const c=Number(r.avg_minute_of_day),f=Number(r.samples);if(!Number.isFinite(c)||!Number.isFinite(f)||f<=0)return;const j=Math.max(0,Math.min(u,c/60)),v=j/u*g,y=a.top+g-v,w=.46+d*.08,b=Math.max(12,Math.min(h*.84,h*w)),O=o-b/2,x=`${n.weekday_label} ${m(s)} dose: ${l(c)}`;_.push(`<rect class="chart-bar chart-dose-layer" x="${O.toFixed(2)}" y="${y.toFixed(2)}" width="${b.toFixed(2)}" height="${v.toFixed(2)}" style="fill:${ue(d,p.length)}" data-tooltip="${encodeURIComponent(x)}"></rect>`)}),w.push(`<text class="chart-axis-label" x="${o.toFixed(2)}" y="${d-a.bottom+18}" text-anchor="middle">${e(n.weekday_label)}</text>`)}),n.innerHTML=`
      <svg class="chart-svg" viewBox="0 0 ${c} ${d}" role="img" aria-label="${e(i?.ariaLabel||"Combined dose time highlights")}">
        <line class="chart-axis-line" x1="${a.left}" y1="${a.top}" x2="${a.left}" y2="${d-a.bottom}"></line>
        <line class="chart-axis-line" x1="${a.left}" y1="${d-a.bottom}" x2="${c-a.right}" y2="${d-a.bottom}"></line>
        ${v.join("")}
        ${y.join("")}
        ${_.join("")}
        ${x.join("")}
        ${w.join("")}
        ${O.join("")}
      </svg>
    `,ee(n,".chart-dose-layer[data-tooltip]")}function fe(e){if(!s)return;s.innerHTML="",e.forEach(e=>{const t=document.createElement("button");t.type="button",t.className="ghost-btn dose-order-btn",t.textContent=`${m(e)} dose`,e===h&&t.classList.add("is-active"),t.addEventListener("click",()=>{if(h===e)return;h=e,a&&_(a)}),s.appendChild(t)})}function L(e){if(!n)return;if(!Array.isArray(e)||e.length<=1){n.hidden=!0,n.innerHTML="";return}n.hidden=!1,n.innerHTML="";const t=document.createElement("button");t.type="button",t.className="ghost-btn dose-order-btn",t.textContent="All medicines",o==="all"&&t.classList.add("is-active"),t.addEventListener("click",()=>{if(o==="all")return;o="all",a&&_(a)}),n.appendChild(t),e.forEach(e=>{const t=i(e.id);if(t===null||t==="all")return;const s=document.createElement("button");s.type="button",s.className="ghost-btn dose-order-btn",s.textContent=String(e.name||`Medicine ${t}`),o===t&&s.classList.add("is-active"),s.addEventListener("click",()=>{if(o===t)return;o=t,a&&_(a)}),n.appendChild(s)})}function _(e){const d=e?.dose_weekday_patterns_7_days||e?.dose_weekday_patterns_90_days||{},j=Array.isArray(d.rows)?d.rows:[],T=Array.isArray(d.dosage_averages)?d.dosage_averages:[],k=Array.isArray(d.available_medicines)?d.available_medicines:[];let a=Array.isArray(d.available_orders)?d.available_orders.map(e=>t(e)).filter(e=>e!==null):[];if(f!=="single"&&f!=="combined"&&(f="single"),a.length===0&&(a=Array.from(new Set(j.map(e=>t(e.dose_order)).filter(e=>e!==null)))),a.sort((e,t)=>e-t),a.length===0){o="all",u&&(u.innerHTML=""),s&&(s.hidden=f!=="single",s.innerHTML=""),n&&(n.hidden=!0,n.innerHTML=""),p&&(p.textContent="No dose-order timing data yet for the last 7 days."),c(v,"No data yet."),r(y,"No chart data yet.");return}de();const z=f==="combined";if(z){s&&(s.hidden=!0);const n=le(j,k,a),h=i(o);n.length<=1||h===null?o="all":h!=="all"&&!n.some(e=>e.id===h)&&(o="all"),L(n);const d=n.length>1?i(o)||"all":"all",x=n.find(e=>e.id===d),b=d==="all"?n.length===1?n[0].name:"All medicines":x?.name||"All medicines",u=ae(j,a,d),e=a.filter(e=>u.some(n=>(Array.isArray(n.doses)?n.doses:[]).some(n=>t(n.dose_order)===e&&Number.isFinite(Number(n.avg_minute_of_day))&&Number(n.samples)>0)));if(e.length===0){p&&(p.textContent="No combined dose timing data yet for the last 7 days."),c(v,"No data yet."),r(y,"No chart data yet.");return}const _=e.map(e=>{const t=te(j,e,d),n=R(t);return{doseOrder:e,averageMinute:n}}).filter(e=>e.averageMinute!==null),O=W(T,e,d),f=_.map(e=>`${m(e.doseOrder)}: ${l(e.averageMinute)}`).join(" | "),w=O.filter(e=>e.dose_order!==null&&e.samples>0&&String(e.dosage_text||"").trim()!=="--").map(e=>`${m(e.dose_order)}: ${String(e.dosage_text||"--")}`).join(" | "),C=f===""?"No average-time samples yet.":f,E=w===""?"No dosage averages yet.":w;p&&(p.textContent=`Combined timing for ${b} over the last 7 days. Avg times: ${C}. Avg dosages: ${E}`),g(v,u,3,n=>{const s=e.map(e=>{const s=(Array.isArray(n.doses)?n.doses:[]).find(n=>t(n.dose_order)===e);return!s||!Number.isFinite(Number(s.avg_minute_of_day))||Number(s.samples)<=0?null:`${m(e)}: ${l(s.avg_minute_of_day)}`}).filter(e=>e!==null),o=(Array.isArray(n.doses)?n.doses:[]).reduce((n,s)=>{const o=t(s.dose_order);return o===null||!e.includes(o)?n:n+Math.max(0,Number(s.samples)||0)},0);return[n.weekday_label,s.length>0?s.join(" | "):"--",o]}),me(y,u,e,{ariaLabel:`Combined dose times by weekday for ${b}`,referenceLines:_.map(t=>{const n=e.indexOf(t.doseOrder),s=Number(t.averageMinute)/60;return{value:s,label:`${m(t.doseOrder)} Avg`,color:he(n,e.length)}})});return}s&&(s.hidden=!1),a.includes(h)||(h=a[0]),fe(a);const b=ce(j,k,h),E=i(o);b.length<=1||E===null?o="all":E!=="all"&&!b.some(e=>e.id===E)&&(o="all"),L(b);const x=b.length>1?i(o)||"all":"all",H=b.find(e=>e.id===x),A=x==="all"?b.length===1?b[0].name:"All medicines":H?.name||"All medicines",w=te(j,h,x),_=`${m(h)} dose`,C=R(w),N=C===null?null:C/60,D=w.reduce((e,t)=>e+Math.max(0,Number(t.samples)||0),0),F=W(T,a,x),O=F.find(e=>e.dose_order===h),P=O&&O.samples>0&&String(O.dosage_text||"").trim()!==""?String(O.dosage_text):"--",S=F.filter(e=>e.dose_order!==null&&e.samples>0&&String(e.dosage_text||"").trim()!=="--").map(e=>`${m(e.dose_order)}: ${String(e.dosage_text||"--")}`).join(" | "),I=S===""?"No dosage averages yet.":S;p&&(p.textContent=`${_} average time by day for ${A} over the last 7 days. ${_} overall average: ${l(C)} (${D} samples). ${_} avg dosage: ${P}. All dose avg dosages: ${I}`),g(v,w,3,e=>[e.weekday_label,e.samples>0?l(e.avg_minute_of_day):"--",e.samples]);const B=w.map(e=>({label:e.weekday_label,value:e.samples>0&&Number.isFinite(Number(e.avg_minute_of_day))?Number(e.avg_minute_of_day)/60:Number.NaN}));M(y,B,{ariaLabel:`${_} average time by day for ${A}`,yMax:24,integerTicks:!0,keepAllPoints:!0,enableHoverTooltip:!0,tickFormatter:e=>l(e*60,!0),valueFormatter:e=>l(e*60),labelFormatter:e=>e,referenceLineValue:N,referenceLineLabel:`${_} Avg`,referenceValueFormatter:e=>l(e*60)})}function ve(e){const p=Array.isArray(e?.dose_interval_weekly_12_weeks)?e.dose_interval_weekly_12_weeks:[],t=e?.summary||{},u=Number(t.avg_dose_interval_this_week_minutes),n=Number.isFinite(u)?u:null,c=Number(t.dose_interval_this_week_samples),a=Number.isFinite(c)&&c>0?Math.round(c):0,m=Number(t.avg_dose_interval_last_7_days_minutes),s=Number.isFinite(m)?m:null,o=Number(t.dose_interval_last_7_days_samples),i=Number.isFinite(o)&&o>0?Math.round(o):0,l=Number(t.avg_dose_interval_last_90_days_minutes),h=Number.isFinite(l)?l:null,r=Number(t.dose_interval_last_90_days_samples),f=Number.isFinite(r)&&r>0?Math.round(r):0;Y&&(Y.textContent=n!==null&&a>0?d(n):"--"),q&&(q.textContent=s!==null&&i>0?d(s):"--");const g=n!==null&&a>0?`This week average gap: ${d(n)} (${a} gaps).`:"No dose-gap samples this week yet.",v=s!==null&&i>0?`Rolling 7-day average gap: ${d(s)} (${i} gaps).`:"No rolling 7-day dose-gap samples yet.",b=h!==null&&f>0?`Last 90-day average gap: ${d(h)} (${f} gaps).`:"No dose-gap data in the last 90 days.";I&&(I.textContent=`Average time between consecutive doses by week over the last 12 weeks. ${g} ${v} ${b}`);const j=p.map(e=>({label:String(e.label||"-").replace(/^Week of\s+/i,""),value:Number.isFinite(Number(e.avg_interval_minutes))&&Number(e.avg_interval_minutes)>=0?Number(e.avg_interval_minutes)/60:Number.NaN})).filter(e=>Number.isFinite(e.value));S(B,j,{yMin:0,ariaLabel:"Average time between doses by week",tickFormatter:e=>d(e*60,!0),valueFormatter:e=>d(e*60),labelFormatter:e=>e})}function be(e){const i=Array.isArray(e?.dose_interval_rolling_7_days_30_days)?e.dose_interval_rolling_7_days_30_days:[],t=[...i].reverse().find(e=>Number(e.samples)>0);k&&(t&&Number.isFinite(Number(t.avg_interval_minutes))?k.textContent=`Rolling 7-day average time between consecutive doses over the last 30 days. Latest window (${t.label||t.date||"today"}): ${d(Number(t.avg_interval_minutes))} (${j(t.samples)} gaps).`:k.textContent="Rolling 7-day average time between consecutive doses over the last 30 days. No rolling-window samples yet.");const a=i.map(e=>({label:String(e.date||e.label||"-"),value:Number.isFinite(Number(e.avg_interval_minutes))&&Number(e.avg_interval_minutes)>=0?Number(e.avg_interval_minutes)/60:Number.NaN})),o=a.map(e=>e.value).filter(e=>Number.isFinite(e)),r=o.length>0,s=r?Math.min(...o):null,n=r?Math.max(...o):null,c=s!==null&&n!==null?n-s:0,l=s!==null&&n!==null?Math.max(.15,c>0?c*.12:n*.12):0,h=s!==null?Math.max(0,s-l):0,u=n!==null?n+l:0[0];S(H,a,{yMin:h,...Number.isFinite(u)?{yMax:u}:{},ariaLabel:"Rolling 7-day average time between doses",tickFormatter:e=>d(e*60,!0),valueFormatter:e=>d(e*60),labelFormatter:e=>{if(/^\d{4}-\d{2}-\d{2}$/.test(e)){const t=e.slice(5);return t.replace("-","/")}return e}})}function D(e){const n=Array.isArray(e.monthly_average_rating)?e.monthly_average_rating:[],s=Array.isArray(e.weekly_entries)?e.weekly_entries:[],o=Array.isArray(e.top_medicines_90_days)?e.top_medicines_90_days:[],i=Array.isArray(e.weekday_patterns_90_days)?e.weekday_patterns_90_days:[],t=e.summary||{};if(J&&(J.textContent=b(t.avg_rating_this_week)),Q&&(Q.textContent=b(t.avg_rating_last_90_days)),X&&(X.textContent=String(t.entries_last_30_days??0)),G){const e=Number(t.active_days_last_30_days??0),n=Number(t.active_day_ratio_last_30_days??0);G.textContent=`${e} (${n.toFixed(1)}%)`}g(x,n,3,e=>[e.label||"-",b(e.avg_rating),e.entries??0]),g(O,s,3,e=>[e.label||"-",e.entries??0,b(e.avg_rating)]),g(C,o,3,e=>[e.medicine_name||"-",e.entries??0,b(e.avg_rating)]),g(E,i,3,e=>[e.label||"-",e.entries??0,b(e.avg_rating)]);const r=n.map(e=>({label:e.label||"-",value:Number(e.avg_rating)})).filter(e=>Number.isFinite(e.value));S(K,r,{yMin:0,yMax:5,ariaLabel:"Monthly average rating trend",tickFormatter:e=>e.toFixed(1),valueFormatter:e=>`${e.toFixed(2)} / 5`,labelFormatter:e=>e});const c=s.map(e=>({label:String(e.label||"-").replace(/^Week of\s+/i,""),value:Number(e.entries)})).filter(e=>Number.isFinite(e.value));M(U,c,{ariaLabel:"Weekly intake entries trend",integerTicks:!0,tickFormatter:e=>j(e),valueFormatter:e=>`${j(e)} entries`,labelFormatter:e=>e});const l=o.map(e=>({label:e.medicine_name||"-",value:Number(e.entries)})).filter(e=>Number.isFinite(e.value));se(T,l);const d=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],a=new Map(i.map(e=>[String(e.label||""),Number(e.entries)])),u=d.map(e=>({label:e,value:Number.isFinite(a.get(e))?Number(a.get(e)):0}));M(V,u,{ariaLabel:"Weekday intake entry pattern",integerTicks:!0,tickFormatter:e=>j(e),valueFormatter:e=>`${j(e)} entries`,labelFormatter:e=>e}),_(e),ve(e),be(e)}if(!oe){P("Database unavailable.","error"),c(x,"Database unavailable."),c(O,"Database unavailable."),c(C,"Database unavailable."),c(E,"Database unavailable."),c(v,"Database unavailable."),u&&(u.innerHTML=""),s&&(s.hidden=!0,s.innerHTML=""),n&&(n.hidden=!0,n.innerHTML=""),$("Database unavailable.");return}re("trends").then(e=>{a=e.trends||{},D(a)}).catch(e=>{a=null,P(e.message,"error"),c(x,"Could not load trends."),c(O,"Could not load trends."),c(C,"Could not load trends."),c(E,"Could not load trends."),c(v,"Could not load trends."),u&&(u.innerHTML=""),s&&(s.hidden=!0,s.innerHTML=""),n&&(n.hidden=!0,n.innerHTML=""),$("Could not load charts.")});let F=null;window.addEventListener("resize",()=>{if(!a)return;F&&window.clearTimeout(F),F=window.setTimeout(()=>{D(a)},120)})})