document.addEventListener("DOMContentLoaded",()=>{const _=window.MEDICINE_SETTINGS_CONFIG||{},b=String(_.apiPath||"index.php"),y=document.body,v=y.dataset.dbReady==="1",i=document.getElementById("settings-status"),a=document.getElementById("account-meta"),r=document.getElementById("signed-in-username"),d=document.getElementById("account-form"),c=document.getElementById("account-submit-btn"),s=document.getElementById("account_username"),n=document.getElementById("account_display_name"),o=document.getElementById("account_email"),u=document.getElementById("account_current_password"),l=document.getElementById("account_new_password"),h=document.getElementById("account_confirm_password"),t={username:String(s?.value||"").trim(),display_name:String(n?.value||"").trim(),email:String(o?.value||"").trim().toLowerCase()};function j(e){const t=new URL(b,window.location.origin);return t.searchParams.set("api",e),t.toString()}async function f(e,t={}){const a=String(t.method||"GET"),o=t.data,s={method:a,headers:{Accept:"application/json"}};o!==0[0]&&(s.headers["Content-Type"]="application/json",s.body=JSON.stringify(o));const i=await fetch(j(e),s);let n=null;try{n=await i.json()}catch{throw new Error("Server returned an unreadable response.")}if(!i.ok||!n.ok){const e=n?.errors?.join(" ")||n?.error||"Request failed.";throw new Error(e)}return n}function e(e,t="success"){if(!i)return;i.hidden=!1,i.textContent=e,i.className=t==="error"?"alert alert-error":"alert alert-success"}function m(e){if(!d)return;d.querySelectorAll("input, button").forEach(t=>{t.disabled=e})}function g(){u&&(u.value=""),l&&(l.value=""),h&&(h.value="")}function p(e){const t=String(e?.display_name||"").trim();return t!==""?t:String(e?.username||"").trim()}async function w(){if(!s)return;const d=await f("account"),e=d.account||{},i=String(e.username||"").trim(),c=String(e.display_name||"").trim(),l=String(e.email||"").trim().toLowerCase();if(!i)throw new Error("Could not load account username.");if(s.value=i,n&&(n.value=c),o&&(o.value=l),t.username=i,t.display_name=c,t.email=l,r&&(r.textContent=p({username:i,display_name:c})),a){const t=String(e.last_login_at||"").trim();a.textContent=t!==""?`Last login: ${t}. Update your username and password.`:"Update your username and password."}}if(!v){m(!0),e("Database unavailable. Update your .env settings first.","error");return}d?.addEventListener("submit",async i=>{i.preventDefault();const v=String(s?.value||"").trim(),j=String(n?.value||"").trim(),d=String(o?.value||"").trim().toLowerCase(),_=String(u?.value||""),b=String(l?.value||""),y=String(h?.value||""),O=v!==t.username,x=j!==t.display_name,C=d!==t.email,w=b!==""||y!=="";if(v===""){e("Username is required.","error");return}if(!O&&!x&&!C&&!w){e("No account changes to save.","error");return}if(d!==""&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(d)){e("Email format is invalid.","error");return}if(_===""){e("Current password is required to update account details.","error");return}if(w){if(b.length<8){e("New password must be at least 8 characters.","error");return}if(b!==y){e("New password confirmation does not match.","error");return}}m(!0),c&&(c.textContent="Updating...");try{const i=await f("account_update",{method:"POST",data:{username:v,display_name:j,email:d,current_password:_,new_password:b,confirm_password:y}}),c=String(i?.account?.username||v).trim(),l=String(i?.account?.display_name||j).trim(),u=String(i?.account?.email||d).trim().toLowerCase();s&&(s.value=c),n&&(n.value=l),o&&(o.value=u),t.username=c,t.display_name=l,t.email=u,r&&(r.textContent=p({username:c,display_name:l})),g(),a&&(a.textContent="Account details updated."),e(i.message||"Account updated.")}catch(t){e(t.message,"error")}finally{m(!1),c&&(c.textContent="Update Account")}}),g(),w().catch(t=>{e(t.message,"error")})})