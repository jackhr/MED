document.addEventListener("DOMContentLoaded",()=>{const z=window.MEDICINE_SCHEDULES_CONFIG||{},fe=z.apiPath||"index.php",a=z.canWrite!==!1&&z.canWrite!=="false",N=document.body,ue=N.dataset.dbReady==="1",F=document.getElementById("schedules-status"),c=document.getElementById("schedules-body"),v=document.getElementById("schedule-form"),d=document.getElementById("schedule-submit-btn"),te=document.getElementById("schedule_medicine_id"),$=document.getElementById("schedule_dosage_value"),I=document.getElementById("schedule_dosage_unit"),R=document.getElementById("schedule_time_of_day"),P=document.getElementById("schedule_reminder_message"),W=document.getElementById("schedule_is_active"),h=document.getElementById("schedule-edit-modal"),E=document.getElementById("schedule-edit-form"),o=document.getElementById("schedule-edit-delete-btn"),t=document.getElementById("schedule-edit-toggle-btn"),r=document.getElementById("schedule-edit-submit-btn"),f=document.getElementById("schedule_edit_id"),J=document.getElementById("schedule_edit_medicine_id"),w=document.getElementById("schedule_edit_dosage_value"),O=document.getElementById("schedule_edit_dosage_unit"),H=document.getElementById("schedule_edit_time_of_day"),C=document.getElementById("schedule_edit_reminder_message"),m=document.getElementById("schedule_edit_is_active"),g=document.getElementById("schedule-meta"),A=document.getElementById("push-status"),q=document.getElementById("enable-push-btn"),K=document.getElementById("disable-push-btn"),U=document.getElementById("test-push-btn"),L=document.getElementById("run-reminders-btn"),oe=String(z.pushPublicKey||""),_=Boolean(z.pushConfigured)&&oe!=="";let D=null,y=[],p=[],i=null,T=null,l=null;function pe(){if(a)return;N.classList.add("is-read-only"),v?.querySelectorAll("input, select, textarea, button").forEach(e=>{e.disabled=!0}),d&&(d.textContent="Read-Only",d.disabled=!0),o&&(o.disabled=!0,o.hidden=!0),t&&(t.disabled=!0,t.hidden=!0),r&&(r.disabled=!0,r.textContent="Read-Only"),L&&(L.disabled=!0)}function me(e,t={}){const n=new URL(fe,window.location.origin);return n.searchParams.set("api",e),Object.entries(t).forEach(([e,t])=>{n.searchParams.set(e,String(t))}),n.toString()}async function s(e,t={}){const a=t.method||"GET",r=t.params||{},o=t.data,s={method:a,headers:{Accept:"application/json"}};o!==0[0]&&(s.headers["Content-Type"]="application/json",s.body=JSON.stringify(o));const i=await fetch(me(e,r),s);let n=null;try{n=await i.json()}catch{throw new Error("Server returned an unreadable response.")}if(!i.ok||!n.ok){const e=n?.errors?.join(" ")||n?.error||"Request failed.";throw new Error(e)}return n}function e(e,t="success"){if(!F)return;D&&(window.clearTimeout(D),D=null),F.hidden=!1,F.textContent=e,F.className=t==="error"?"alert alert-error":"alert alert-success",D=window.setTimeout(()=>{F.hidden=!0},3200)}function n(e,t="neutral"){if(!A)return;A.textContent=e,A.classList.remove("push-ok","push-error"),t==="ok"&&A.classList.add("push-ok"),t==="error"&&A.classList.add("push-error")}function M(e){return p.find(t=>Number(t.id)===Number(e))||null}function S(){if(!t)return;const e=i!==null?M(i):null;if(!e){t.hidden=!0,t.disabled=!0,t.textContent="Pause Schedule",t.dataset.active="";return}const n=Boolean(e.is_active);t.hidden=!1,t.disabled=!1,t.dataset.active=n?"1":"0",t.textContent=n?"Pause Schedule":"Resume Schedule"}function Z(){return Boolean(h&&!h.hidden)}function he(t){if(!a){e("Read-only access: schedule editing is disabled.","error");return}const n=M(t);if(!n){e("Schedule not found. Refresh and try again.","error");return}i=Number(n.id),f&&(f.value=String(n.id)),Y(String(n.medicine_id||"")),w&&(w.value=String(n.dosage_value||"20")),O&&(O.value=String(n.dosage_unit||"mg")),H&&(H.value=String(n.time_of_day_input||"").slice(0,5)),C&&(C.value=String(n.reminder_message||"")),m&&(m.checked=Boolean(n.is_active)),r&&(r.textContent="Save Schedule"),S(),h&&(h.hidden=!1,N.classList.add("modal-open"))}function X(e,t=""){if(!e)return;const n=t!==""?t:String(e.value||"");if(e.innerHTML="",!y.length){const t=new Option("No medicine types yet","");t.disabled=!0,t.selected=!0,e.add(t);return}if(y.forEach(t=>{e.add(new Option(t.name,String(t.id)))}),n!==""&&y.some(e=>String(e.id)===n)){e.value=n;return}e.value=String(y[0].id)}function Q(){X(te)}function Y(e=""){X(J,e)}function ie(){if(!E)return;E.reset(),f&&(f.value=""),w&&(w.value="20"),O&&(O.value="mg"),m&&(m.checked=!0),C&&(C.value=""),o&&(o.textContent="Delete Schedule"),Y(),S()}function u(){h&&(h.hidden=!0,N.classList.remove("modal-open")),i=null,ie()}function k(e,t=""){const n=document.createElement("td");return n.textContent=e==null||e===""?"-":String(e),t&&(n.className=t),n}async function re(){const e=await s("medicines");y=Array.isArray(e.medicines)?e.medicines.map(e=>({id:Number(e.id),name:String(e.name||"")})).filter(e=>e.id>0&&e.name!==""):[],Q(),Y()}function ae(e){if(!c)return;if(c.innerHTML="",!Array.isArray(e)||e.length===0){const t=document.createElement("tr"),e=document.createElement("td");e.className="empty-cell",e.colSpan=6,e.textContent="No schedules yet.",t.appendChild(e),c.appendChild(t);return}e.forEach(e=>{const t=document.createElement("tr");t.appendChild(k(e.time_label||e.time_of_day_input||"-")),t.appendChild(k(e.medicine_name||"-")),t.appendChild(k(e.dosage_display||"-")),t.appendChild(k(e.reminder_message||"")),t.appendChild(k(e.is_active?"Active":"Paused"));const n=document.createElement("td");if(a){const t=document.createElement("button");t.type="button",t.className="table-action",t.dataset.scheduleAction="edit",t.dataset.id=String(e.id),t.textContent="Edit",n.appendChild(t)}else n.textContent="Read only";t.appendChild(n),c.appendChild(t)})}async function x(){if(!g)return;const e=await s("schedules");p=Array.isArray(e.schedules)?e.schedules:[],ae(p),i!==null&&!M(i)?u():Z()&&S();const t=p.filter(e=>e.is_active).length;g.textContent=`${p.length} schedule${p.length===1?"":"s"} (${t} active)`}function se(e){if(!v)return;v.querySelectorAll("input, select, button").forEach(t=>{if(t.id==="schedule_is_active")return;t.disabled=e})}function j(e){if(!E)return;E.querySelectorAll("input, select, button").forEach(t=>{if(t.id==="schedule_edit_is_active")return;t.disabled=e})}function ne(){if(!v)return;if(v.reset(),$&&($.value="20"),I&&(I.value="mg"),W&&(W.checked=!0),R&&!R.value){const e=new Date;e.setMinutes(e.getMinutes()+30),R.value=`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}P&&(P.value=""),Q()}function ce(e){const s="=".repeat((4-e.length%4)%4),o=(e+s).replace(/-/g,"+").replace(/_/g,"/"),t=window.atob(o),n=new Uint8Array(t.length);for(let e=0;e<t.length;e+=1)n[e]=t.charCodeAt(e);return n}function le(){const e=navigator.userAgent||"",t=navigator.platform||"";return/iPad|iPhone|iPod/.test(e)||t==="MacIntel"&&Number(navigator.maxTouchPoints||0)>1}function de(){const e=typeof window.matchMedia=="function"&&window.matchMedia("(display-mode: standalone)").matches,t=typeof navigator.standalone=="boolean"&&navigator.standalone;return Boolean(e||t)}function ee(){return le()&&!de()?"On iPhone/iPad, add this site to Home Screen to enable push notifications.":"Push notifications are not supported in this browser context."}function B(e){if(!e||!e.pushManager)throw new Error(ee());return e.pushManager}async function V(){if(!("serviceWorker"in navigator))throw new Error("Service workers are not supported in this browser.");if(T)return T;const e=new URL("push-sw.js",window.location.href).pathname;if(await navigator.serviceWorker.register(e),T=await navigator.serviceWorker.ready,!T)throw new Error("Service worker did not become ready.");return T}function b(){const e=Boolean(l);q&&(q.disabled=!_||e),K&&(K.disabled=!e),U&&(U.disabled=!_||!e)}async function G(e){const t=e?e.toJSON():null;if(!t)throw new Error("Could not read browser subscription details.");await s("push_subscribe",{method:"POST",data:{endpoint:t.endpoint,keys:t.keys||{},user_agent:navigator.userAgent||""}})}async function ge(){if(!_)throw new Error("Push is not configured on the server.");if(!("PushManager"in window))throw new Error(ee());if(Notification.permission==="denied")throw new Error("Notifications are blocked for this site.");const s=await V(),t=B(s),o=await Notification.requestPermission();if(o!=="granted")throw new Error("Notification permission was not granted.");let e=await t.getSubscription();e||(e=await t.subscribe({userVisibleOnly:!0,applicationServerKey:ce(oe)})),await G(e),l=e,b(),n("Push enabled for this browser.","ok")}async function ve(){const t=await V(),o=B(t),e=l||await o.getSubscription();if(!e){l=null,b(),n("Push is not enabled in this browser.");return}const i=e.toJSON();await s("push_unsubscribe",{method:"POST",data:{endpoint:i.endpoint||""}}),await e.unsubscribe(),l=null,b(),n("Push disabled for this browser.")}async function be(){if(!_){n("Push is not configured. Add VAPID keys in .env.","error"),b();return}try{const e=await V(),t=B(e);l=await t.getSubscription(),b(),l?(await G(l),n("Push enabled for this browser.","ok")):Notification.permission==="denied"?n("Notifications are blocked in this browser.","error"):n("Push is available. Enable it to receive reminders.")}catch(e){n(e.message||"Could not initialize push.","error")}}if(!ue){g&&(g.textContent="Database unavailable."),c&&(c.innerHTML='<tr><td class="empty-cell" colspan="6">Database unavailable.</td></tr>'),n("Database unavailable.","error");return}pe(),a||e("Read-only access enabled for this workspace."),b(),_||n("Push is not configured. Add VAPID keys in .env.","error"),v?.addEventListener("submit",async t=>{if(t.preventDefault(),!a){e("Read-only access: schedule updates are disabled.","error");return}const n={medicine_id:Number(te?.value||0),dosage_value:String($?.value||"").trim(),dosage_unit:String(I?.value||"").trim(),time_of_day:String(R?.value||"").trim(),reminder_message:String(P?.value||"").trim(),is_active:W?.checked?1:0};if(!n.medicine_id||!n.dosage_value||!n.dosage_unit||!n.time_of_day){e("Please complete all schedule fields.","error");return}se(!0),d&&(d.textContent="Adding...");try{await s("schedule_create",{method:"POST",data:n}),e("Schedule added."),ne(),await x()}catch(t){e(t.message,"error")}finally{se(!1),d&&(d.textContent="Add Schedule")}}),E?.addEventListener("submit",async t=>{if(t.preventDefault(),!a){e("Read-only access: schedule editing is disabled.","error");return}const o=Number(f?.value||i||0),n={id:o,medicine_id:Number(J?.value||0),dosage_value:String(w?.value||"").trim(),dosage_unit:String(O?.value||"").trim(),time_of_day:String(H?.value||"").trim(),reminder_message:String(C?.value||"").trim(),is_active:m?.checked?1:0};if(!n.id||!n.medicine_id||!n.dosage_value||!n.dosage_unit||!n.time_of_day){e("Please complete all schedule edit fields.","error");return}j(!0),r&&(r.textContent="Saving...");try{await s("schedule_update",{method:"POST",data:n}),u(),e("Schedule updated."),await x()}catch(t){e(t.message,"error")}finally{j(!1),r&&(r.textContent="Save Schedule")}}),t?.addEventListener("click",async()=>{if(!a){e("Read-only access: schedule editing is disabled.","error");return}const n=i!==null?M(i):null;if(!n){u(),e("Schedule not found. Refresh and try again.","error");return}const o=n.is_active?0:1;j(!0),t&&(t.textContent=n.is_active?"Pausing...":"Resuming...");try{await s("schedule_toggle",{method:"POST",data:{id:Number(n.id),is_active:o}}),await x();const t=M(Number(n.id));m&&(m.checked=Boolean(t?.is_active??o)),S(),e(o===1?"Schedule resumed.":"Schedule paused.")}catch(t){e(t.message,"error")}finally{j(!1),S()}}),o?.addEventListener("click",async()=>{if(!a){e("Read-only access: schedule deleting is disabled.","error");return}const t=Number(f?.value||i||0);if(!t){e("Missing schedule ID for delete.","error");return}const n=window.confirm("Delete this schedule?");if(!n)return;j(!0),o&&(o.textContent="Deleting...");try{await s("schedule_delete",{method:"POST",data:{id:t}}),u(),e("Schedule deleted."),await x()}catch(t){e(t.message,"error")}finally{j(!1),o&&(o.textContent="Delete Schedule")}}),c?.addEventListener("click",async e=>{if(!a)return;const t=e.target.closest("button[data-schedule-action]");if(!t)return;const n=Number(t.dataset.id||0);if(!n)return;if(t.dataset.scheduleAction==="edit"){he(n);return}}),h?.addEventListener("click",e=>{const t=e.target.closest("[data-close-schedule-modal='true']");t&&u()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&Z()&&u()}),q?.addEventListener("click",async()=>{try{await ge(),e("Push notifications enabled.")}catch(t){e(t.message,"error"),n(t.message,"error")}}),K?.addEventListener("click",async()=>{try{await ve(),e("Push notifications disabled.")}catch(t){e(t.message,"error"),n(t.message,"error")}}),U?.addEventListener("click",async()=>{try{const n=await s("push_test",{method:"POST"}),t=n.dispatch||{};e(`Test push sent: ${t.sent||0}/${t.attempted||0} delivered.`)}catch(t){e(t.message,"error")}}),L?.addEventListener("click",async()=>{if(!a){e("Read-only access: reminder checks are disabled.","error");return}const t=L;t&&(t.disabled=!0,t.textContent="Running...");try{const a=await s("process_reminders",{method:"POST"}),t=a.result||{},n=Number(t.due||0),o=Number(t.sent||0),r=Number(t.push_attempted||0),i=Number(t.push_failed||0),c=Number(t.push_deactivated||0),l=`Reminder check complete. Due: ${n}, sent: ${o}, attempted: ${r}, failed: ${i}, deactivated: ${c}.`;e(l,i>0||n>0&&o===0?"error":"success")}catch(t){e(t.message,"error")}finally{t&&(t.disabled=!1,t.textContent="Run Reminder Check")}}),Promise.all([re(),x()]).then(async()=>{ne(),u(),await be()}).catch(t=>{e(t.message,"error"),g&&(g.textContent="Schedules unavailable. Run latest DB migrations."),c&&(c.innerHTML='<tr><td class="empty-cell" colspan="6">Schedules unavailable.</td></tr>')})})